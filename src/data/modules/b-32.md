# Detection Engineering (SPL & KQL)

## 1. Orientation

### What this module covers
Searching for "Error" is not detection. Detection Engineering is writing code to identify specific threat behaviors. This module covers **Search Processing Language (SPL)** and **Kusto Query Language (KQL)**.

### Learning Objectives
*   Write a query to detect **Brute Force** attacks.
*   Understand **Precision vs. Recall** in rules.
*   Implement **Thresholding** and **Time Windows**.

---

## 2. Core Content

### Anatomy of a Rule
1.  **Selection:** Filter data. `index=windows EventCode=4625` (Failed Login).
2.  **Aggregation:** Group by criteria. `| stats count by src_ip, user`.
3.  **Threshold:** Set a limit. `| where count > 10`.
4.  **Timeframe:** `earliest=-15m`.

### Precision vs. Recall
*   **Precision:** How many alerts are real? (High precision = Low False Positives).
*   **Recall:** How many attacks did we catch? (High recall = Low False Negatives).
*   *Tradeoff:* Tighter rules increase Precision but lower Recall (you might miss a slow brute force).

### SPL Example (Splunk)
```splunk
index=main sourcetype=access_combined status=200
| stats count by client_ip, uri_path
| where count > 1000
| sort -count
```
*Detects High-Volume Scraping/Fuzzing.*

---

## 3. Lab: Detecting Password Spraying

### Scenario
Attack: Trying *one* password against *many* users (avoids lockout).

**Logic:**
1.  Look for Failed Logins (`4625`).
2.  Group by `src_ip`.
3.  Count distinct `user` names (`dc(user)`).
4.  Trigger if `unique_users > 20` in 10 minutes.

**KQL (Sentinel):**
```kql
SecurityEvent
| where EventID == 4625
| summarize UserCount = dcount(TargetAccount) by IpAddress, bin(TimeGenerated, 10m)
| where UserCount > 20
```

---

## 4. Reflection
1.  Why use `bin(TimeGenerated, 10m)`? (To look for bursts of activity. A subtle attacker stretches the attack over 24 hours to evade this rule).
2.  What is an "Allow List"? (Exceptions within the rule code, e.g., `| where src_ip != '10.0.0.5'` (Scanner). Managing these is a nightmare).
