# Kernel Security & Modules

## 1. Orientation

### What this module covers
The Kernel is Ring 0. If you own the kernel, you own the hardware, the memory, and every process. This module covers **Kernel Hardening**, **Loadable Kernel Modules (LKMs)** as attack vectors (Rootkits), and **eBPF** (the modern way to interact with the kernel safely).

### Learning Objectives
By the end of this module, you will:
*   Explain the difference between User Space (Ring 3) and Kernel Space (Ring 0).
*   Understand why `insmod` is the most dangerous command in Linux.
*   Configure `sysctl` settings for kernel hardening (ASLR, kptr_restrict).
*   Analyze the security implications of eBPF.

---

## 2. Core Content

### Rings of Power (x86 Architecture)
*   **Ring 0 (Kernel):** Infinite access. Direct hardware control.
*   **Ring 1 & 2:** Drivers (Rarely used).
*   **Ring 3 (User):** Restricted. Cannot touch hardware directly; must use **System Calls (syscalls)** (e.g., `read()`, `write()`, `fork()`).

### The Attack Surface

#### 1. Loadable Kernel Modules (LKM)
Linux is a monolithic kernel, but it can extend itself at runtime using `.ko` files.
*   **Use Case:** Loading a WiFi driver without rebooting.
*   **Attack:** Loading a **Rootkit** (e.g., Diamorphine).
*   **Rootkit Payload:** It can hook `getdents` (Get Directory Entries) to hide files. It can hook `kill` to grant root privileges.
*   **Defense:** Enforce module signing. `CONFIG_MODULE_SIG_FORCE=y`.

#### 2. Kernel Memory Exploitation
*   **User-After-Free (UAF):** Common in kernel drivers.
*   **Defense:** KASLR (Kernel Address Space Layout Randomization). Makes it hard to guess where `system()` is.

#### 3. eBPF (Extended Berkeley Packet Filter)
The modern superpower. It allows you to run sandboxed programs inside the kernel without writing a module.
*   **Security Tooling:** Cilium, Falco, Tetragon use eBPF to monitor syscalls with near-zero overhead.
*   **Risk:** Offensive eBPF allows "unhookable" malware if not monitored.

### Hardening the Kernel (`sysctl.conf`)

```bash
# Hide kernel pointers (prevents KASLR bypass)
kernel.kptr_restrict = 2

# Restrict usage of dmesg (info leak)
kernel.dmesg_restrict = 1

# Disable unprivileged eBPF (reduce attack surface)
kernel.unprivileged_bpf_disabled = 1

# Prevent JIT spraying
net.core.bpf_jit_harden = 2
```

---

## 3. Deep Dive: The "Dirty COW" Exploit (CVE-2016-5195)

### Mechanism
A race condition in the Copy-On-Write (COW) mechanism of the memory subsystem.
*   **Concept:** When you write to a read-only file mapping, the kernel makes a private copy (COW).
*   **Race:** The exploit raced the memory manager to modify the *original* read-only memory instead of the copy.
*   **Impact:** Overwriting `/etc/passwd` or `/usr/bin/su` as an unprivileged user.
*   **Lesson:** Logic bugs in the kernel bypass all ACLs.

---

## 4. Reflection Check
1.  Why involves "Secure Boot" when talking about Kernel Modules? (Because if the kernel trusts unsigned modules, Secure Boot is useless).
2.  Can Docker protect you from a Kernel exploit? (No. Containers share the host kernel. A kernel panic kills all containers).
3.  Why is a "Microkernel" (like SeL4) theoretically more secure than a Monolithic kernel (Linux/Windows)? (Smaller TCB).

---

## 5. Completion Criteria
1.  **Check** if your current Linux kernel allows loading unsigned modules.
2.  **Explain** how a rootkit hides a process from `top`.
