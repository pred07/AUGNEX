# Network Device Logging (Firewalls, Routers)

## 1. Orientation

### What this module covers
This module covers network infrastructure logging—firewalls, routers, switches, and VPN devices. These logs show network-level activity: who connected to what, traffic volumes, and blocked connections.

### Fit in the Learning Path
Endpoint logs show what happened on a system. Network logs show how attackers got there and where they went. Together, they provide complete visibility for incident investigation.

### Learning Objectives
By the end of this module, you will:
*   Understand network log types (firewall, NetFlow, PCAP)
*   Analyze traffic patterns for security events
*   Detect lateral movement and exfiltration
*   Correlate network and endpoint evidence

---

## 2. Core Content

### Mental Model: Network as Witness

**How professionals think about this:**
The network sees everything that crosses it. Even if an attacker clears endpoint logs, network logs on separate infrastructure often survive. Network logs provide the "who talked to whom" perspective.

```
NETWORK VISIBILITY LAYERS:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  LAYER 1: CONNECTION METADATA (Firewall logs, NetFlow)              │
│  ─────────────────────────────────────────────────────              │
│  What you see:                                                     │
│  - Source IP/Port                                                  │
│  - Destination IP/Port                                             │
│  - Protocol (TCP/UDP)                                              │
│  - Action (Allow/Deny)                                             │
│  - Bytes transferred                                               │
│  - Timestamp                                                       │
│                                                                     │
│  Cannot see: Content (encrypted or not)                            │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  LAYER 2: DECRYPTED INSPECTION (Proxy logs, TLS inspection)        │
│  ─────────────────────────────────────────────────────              │
│  What you see:                                                     │
│  - Full URLs                                                       │
│  - HTTP headers                                                    │
│  - File downloads                                                  │
│  - POST data (sometimes)                                           │
│                                                                     │
│  Requires: TLS interception capability                             │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  LAYER 3: FULL PACKET CAPTURE (PCAP)                              │
│  ─────────────────────────────────────────────────────              │
│  What you see:                                                     │
│  - Everything (if unencrypted)                                     │
│  - Exact malware payload                                           │
│  - Command and control traffic                                     │
│                                                                     │
│  Cost: Massive storage, privacy concerns                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Firewall Logs

**Understanding the 5-tuple:**

```
FIREWALL LOG ANATOMY:

Example entry:
2024-01-15 08:30:45 DENY TCP 203.0.113.50:54321 → 192.168.1.10:22 
│                    │    │   │                   │
│                    │    │   │                   └── Destination IP:Port
│                    │    │   └── Source IP:Port
│                    │    └── Protocol
│                    └── Action (DENY/ALLOW)
└── Timestamp

THE 5-TUPLE:
1. Source IP
2. Source Port
3. Destination IP
4. Destination Port
5. Protocol

This uniquely identifies a network connection
```

**Common firewall log patterns:**

| Pattern | Indication |
|---------|------------|
| Many DENY same dest port | Port scan |
| Many DENY same src IP | Blocked attacker |
| ALLOW to unusual port | Potential backdoor |
| Outbound to known-bad IP | C2 communication |
| Large outbound transfer | Data exfiltration |
| Internal-to-internal blocked | Lateral movement attempt |

### NetFlow and Flow Data

**Network metadata:**

```
NETFLOW CONCEPT:

Full packet capture:
┌────────────────────────────────────────────────────────────────┐
│ IP Header │ TCP Header │ HTTP Request │ Actual Content...     │
│ 20 bytes  │ 20 bytes   │ 500 bytes    │ 1MB file download     │
└────────────────────────────────────────────────────────────────┘
Storage: Every byte captured

NetFlow record (same connection):
┌─────────────────────────────────────────────────────────────────┐
│ Src: 192.168.1.50:4567                                         │
│ Dst: 203.0.113.100:443                                         │
│ Protocol: TCP                                                  │
│ Start: 08:30:00, End: 08:35:00                                │
│ Packets: 1,500                                                 │
│ Bytes: 1,048,576 (1MB)                                         │
│ TCP Flags: SYN, ACK, PSH, FIN                                  │
└─────────────────────────────────────────────────────────────────┘
Storage: ~100 bytes

TRADE-OFF:
- NetFlow: Scalable, shows patterns, misses content
- PCAP: Complete evidence, storage expensive
```

**NetFlow analysis:**

```
NETFLOW SECURITY USE CASES:

1. DATA EXFILTRATION DETECTION
   ─────────────────────────────
   Query: Outbound flows > 1GB in last hour
   Alert: 192.168.1.100 → 203.0.113.50 : 5GB
   
   Investigation: What is 203.0.113.50?
   
2. BEACONING DETECTION
   ─────────────────────────────
   Pattern: Same src→dst every 60 seconds
   Typical C2: Regular heartbeat intervals
   
   Query: Connections with consistent timing
   
3. SCANNING DETECTION
   ─────────────────────────────
   Pattern: One source → Many destinations
   
   Query: Unique destinations per source in 5min
   
4. LATERAL MOVEMENT
   ─────────────────────────────
   Pattern: Internal → Internal unusual port
   
   Query: Internal flows to ports 445, 3389, 22
   From sources that don't normally use them
```

### Packet Capture (PCAP)

**Full content capture:**

```
PCAP USE CASES:

1. MALWARE ANALYSIS
   ─────────────────────────────
   Capture the exact malware download
   Analyze payload, C2 protocol
   
2. CREDENTIAL THEFT EVIDENCE
   ─────────────────────────────
   Unencrypted protocols (FTP, HTTP, Telnet)
   Capture actual credentials
   
3. FORENSIC EVIDENCE
   ─────────────────────────────
   Legal proceedings require exact evidence
   PCAP provides complete record
   
4. INCIDENT RECONSTRUCTION
   ─────────────────────────────
   Replay the attack exactly as it happened

PCAP CHALLENGES:
- Storage: 1Gbps link = 10TB/day (uncompressed)
- Privacy: Captures employee content
- Performance: Full capture impacts network speed
- Encryption: HTTPS content not visible

TYPICAL APPROACH:
- Capture headers only (metadata)
- Full capture only at network tap for incidents
- Trigger full capture on alert
```

### Router and Switch Logs

**Infrastructure events:**

```
ROUTER/SWITCH LOG TYPES:

INTERFACE STATUS:
  Interface GigabitEthernet0/1: link up/down
  → Physical connection changes
  → Cable pulled, device offline

ROUTING CHANGES:
  BGP neighbor 10.0.0.1 down
  OSPF adjacency changed
  → Routing manipulation attack?

ACL HITS:
  Denied IP from 192.168.1.100 to 10.0.0.50
  → Traffic blocked by access list

AUTHENTICATION:
  User admin logged in via SSH
  → Management access to infrastructure

CONFIGURATION CHANGES:
  Config changed by admin from 192.168.1.1
  → Audit trail for changes
```

### VPN Logs

**Remote access visibility:**

```
VPN LOG ANALYSIS:

CRITICAL VPN EVENTS:
─────────────────────────────
Connection established:
  User: alice@company.com
  Source IP: 203.0.113.50 (Coffee shop)
  Assigned IP: 10.100.1.50
  Time: 08:30:00
  
Connection terminated:
  Duration: 4 hours
  Bytes sent: 50MB
  Bytes received: 200MB

DETECTION OPPORTUNITIES:
─────────────────────────────
1. STOLEN CREDENTIALS
   Alert: alice connected from two countries simultaneously
   
2. UNUSUAL ACCESS PATTERNS
   Alert: alice connected at 3AM (normally 9-5)
   
3. DATA EXFILTRATION
   Alert: alice uploaded 50GB (normally <1GB)
   
4. LATERAL MOVEMENT ENTRY
   VPN gives internal access → Then lateral movement
   VPN logs show the initial entry point
```

### Detection Use Cases

**Network-based detection:**

```
DETECTION SCENARIOS:

1. COMMAND AND CONTROL (C2)
   ─────────────────────────────
   Indicators:
   - Beaconing pattern (regular intervals)
   - DNS tunneling (high DNS query volume to one domain)
   - Connections to known-bad IPs
   - Unusual port usage (HTTPS on port 8443)
   
   Query: Outbound connections with regular timing patterns

2. DATA EXFILTRATION
   ─────────────────────────────
   Indicators:
   - Large outbound transfers
   - Transfers to cloud storage
   - Encrypted connections to new destinations
   - DNS TXT records (DNS tunneling)
   
   Query: Outbound flows > 100MB to non-business destinations

3. LATERAL MOVEMENT
   ─────────────────────────────
   Indicators:
   - Internal SMB/WMI/RDP traffic
   - Admin tools to multiple systems
   - Workstation-to-workstation traffic
   
   Query: Internal flows between workstations on admin ports

4. RECONNAISSANCE
   ─────────────────────────────
   Indicators:
   - Port scans (many ports, one destination)
   - Host scans (many destinations, one port)
   - DNS enumeration (many queries)
   
   Query: Source with >100 unique destinations in 5min
```

### Correlation with Endpoint Logs

**Building the complete picture:**

```
CORRELATION EXAMPLE:

Network log:
  ALLOW TCP 192.168.1.50:4567 → 203.0.113.100:443 : 5MB

Questions the network log can't answer:
- What process made this connection?
- What was downloaded?
- What happened after the download?

Endpoint log (Sysmon):
  Event 3: Network Connection
  Process: powershell.exe (PID 1234)
  Destination: 203.0.113.100:443
  
  Event 1: Process Create
  Parent: powershell.exe (PID 1234)
  Child: malware.exe (PID 5678)

CORRELATED STORY:
1. PowerShell connected to external IP (network + endpoint)
2. Downloaded payload (network bytes, endpoint shows file)
3. Launched malware (endpoint shows child process)
4. Malware connected to C2 (network shows new connection)
```

---

## 3. Guided Practice

### Exercise 1: Firewall Log Analysis

Analyze this log excerpt:

```
08:00:01 DENY TCP 203.0.113.5:54321 → 192.168.1.10:22
08:00:01 DENY TCP 203.0.113.5:54322 → 192.168.1.10:23
08:00:01 DENY TCP 203.0.113.5:54323 → 192.168.1.10:80
08:00:01 DENY TCP 203.0.113.5:54324 → 192.168.1.10:443
08:00:02 DENY TCP 203.0.113.5:54325 → 192.168.1.10:3389
```

1. What is happening? ___
2. Is this a concern? ___
3. What action is needed? ___

### Exercise 2: NetFlow Analysis

This host transferred data:

| Destination | Bytes | Port |
|-------------|-------|------|
| 8.8.8.8 | 1MB | 53 |
| company.box.com | 500MB | 443 |
| 45.33.32.156 | 50MB | 443 |

1. Which needs investigation? ___
2. Why? ___

### Exercise 3: Correlation

Network shows: `192.168.1.50 → external:443 : 1GB upload`

What endpoint logs would you check?

1. ___
2. ___
3. ___

---

## 4. Reflection Check

### Network Understanding
1. Why can't a firewall see the content of HTTPS traffic?

2. NetFlow shows 1GB to cloud storage. Is this exfiltration?

3. All outbound traffic is through a proxy. Where do you look for C2?

### Detection Thinking
1. Attacker uses port 443 for C2. How might you still detect it?

2. DNS tunneling uses standard DNS port. How do you detect it?

3. Lateral movement is all internal traffic. What makes it visible?

---

## 5. Key Misconceptions

**MYTH: "Network logs see everything"**
REALITY: Encryption hides content. Network logs show metadata (who, when, how much), not what.

**MYTH: "PCAP is always best"**
REALITY: PCAP is expensive and often contains encrypted data anyway. NetFlow often sufficient.

**MYTH: "Firewall blocks mean no compromise"**
REALITY: Blocks show attempted attack. Check if other paths succeeded.

**MYTH: "Internal network traffic is safe"**
REALITY: Lateral movement is internal. Monitor east-west traffic, not just north-south.

**MYTH: "VPN users are authenticated, so they're trusted"**
REALITY: VPN credentials can be stolen. Monitor VPN user behavior too.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Read** firewall logs and identify the 5-tuple
2. **Explain** the difference between NetFlow and PCAP
3. **Detect** exfiltration, beaconing, and lateral movement patterns
4. **Correlate** network and endpoint logs
5. **Identify** appropriate log source for different investigations

---

## 7. Further Depth (Optional)

*   **Tool:** Practice with Wireshark for PCAP analysis
*   **Lab:** Set up NetFlow collection (ntopng, Elastiflow)
*   **Research:** DNS tunneling detection techniques
*   **Practice:** SecurityOnion for network security monitoring
