# Validating Command-Line and Script Activity

## 1. What this module covers
Scripts (`.ps1`, `.bat`, `.vbs`, `.py`) are text, not binaries. They don't have static hashes like `.exe`. You must log the *content* of the script.

## 2. Why this matters for purple teams
"Fileless Malware" is just a script running in memory. If you don't log the script content/block, you are blind to modern attacks.

## 3. Core concepts explained clearly

### AMSI (Antimalware Scan Interface)
*   Microsoft interface that allows AV to scan a script *as it runs* in memory.
*   Even if the script is obfuscated, it must de-obfuscate to run. AMSI sees the naked code.

### Script Block Logging (PowerShell)
*   GPO setting: `Turn on PowerShell Script Block Logging`.
*   Records the entire text of the script to the Event Log (EID 4104).

## 4. Validation examples

### Testing Script Logging
1.  **Action**: Run a Base64 encoded command: `powershell -enc UwB0AGEAcgB0AC0AUAByAG8AYwBlAHMAcwAgAGMAYQBsAGMA`. (Start-Process calc).
2.  **Log Check (Process)**: Shows `-enc UwB0...`. (Obfuscated).
3.  **Log Check (Script Block 4104)**: Shows `Start-Process calc`. (De-obfuscated!).
4.  **Success**: We can read the intent.

## 5. Common gaps and failures
*   **Bypassing AMSI**: Attackers use tools to patch AMSI in memory.
    *   *Purple Test*: Run an "AMSI Bypass" script. Does EDR catch the bypass attempt?
*   **Other Interpreters**: We watch PowerShell. What about Python? What about WScript (`cscript.exe`)?

## 6. Key takeaways
*   **De-obfuscation**: You technically cannot analyze obfuscated code. You need the dynamic runtime logs (Script Block) to see the truth.
