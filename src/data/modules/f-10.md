# Filesystems and Permissions

## 1. Orientation

### What this module covers
This module covers how data is organized on storage devices and how access to that data is controlled. Understanding filesystems and permissions is fundamental—privilege escalation attacks often exploit permission misconfigurations, and forensic investigations require understanding how data is stored and recovered.

### Fit in the Learning Path
You cannot exploit a system without understanding what you can and cannot access. You cannot investigate a compromise without understanding where data lives and who can modify it. This module makes privilege escalation and forensics techniques comprehensible.

### Learning Objectives
By the end of this module, you will:
*   Understand how filesystems organize data on disk
*   Read and modify Linux permissions confidently
*   Understand Windows ACL model concepts
*   Identify permission-based privilege escalation opportunities

---

## 2. Core Content

### Mental Model: The Access Control Question

**How professionals think about this:**
Every file access is a question: "Does this user/process have permission to perform this operation on this resource?" The filesystem and permission model answer this question billions of times per day.

```
ACCESS CONTROL CHECK:

┌─────────────┐     ┌─────────────────────────────────────────────────┐
│   Process   │     │              KERNEL CHECK:                      │
│ (User: bob) │────►│  Can "bob" READ file "/etc/shadow"?            │
│   wants to  │     │                                                 │
│ READ a file │     │  1. What are the file's permissions?           │
└─────────────┘     │  2. Who owns the file?                          │
                    │  3. What groups does bob belong to?             │
                    │  4. Does any ACL grant/deny access?             │
                    │                                                 │
                    │  RESULT: ALLOW or DENY                          │
                    └─────────────────────────────────────────────────┘
```

### How Filesystems Work

**The filing cabinet analogy:**
A raw disk is just magnetic or electronic bits. The filesystem imposes structure: names, directories, metadata, and the mapping between names and actual data locations.

**Key filesystem concepts:**

| Concept | Description | Security Relevance |
|---------|-------------|-------------------|
| **Inode** | Metadata structure (permissions, timestamps, data location) | Timestamps for forensics |
| **Directory** | Special file listing name→inode mappings | Traversal permissions |
| **Data blocks** | Actual file content | Slack space may contain old data |
| **Journal** | Log of pending operations | Forensic artifacts |

**Filesystem structure (Linux ext4 example):**
```
┌─────────────────────────────────────────────────────────────────────┐
│                           DISK                                      │
├─────────────────────────────────────────────────────────────────────┤
│ Superblock │ Inode │ Inode │ ... │ Data  │ Data  │ Data  │ ...    │
│ (metadata) │  #1   │  #2   │     │Block 1│Block 2│Block 3│        │
└─────────────────────────────────────────────────────────────────────┘

    Inode contains:                Data blocks contain:
    - Owner (UID)                  - Actual file contents
    - Group (GID)                  - May have slack space
    - Permissions (rwx)            - Deleted data may remain
    - Timestamps (atime, mtime, ctime)
    - Pointers to data blocks
```

### Linux vs Windows Filesystems

| Aspect | Linux (ext4) | Windows (NTFS) |
|--------|--------------|----------------|
| Case sensitivity | Yes (`File.txt` ≠ `file.txt`) | No (`File.txt` = `file.txt`) |
| Permission model | Basic rwx + ACLs | Rich ACLs |
| Streams | Not native | Alternate Data Streams |
| Journal | Yes | Yes |
| Max filename | 255 bytes | 255 characters |
| Encryption | LUKS (block level) | EFS (file level) |

**NTFS special features:**

**Alternate Data Streams (ADS):**
Files can have hidden streams attached:
```
file.txt                    # Normal file
file.txt:hidden_data        # Hidden stream (not visible in Explorer)
```
Security implication: Malware can hide in ADS.

**Master File Table (MFT):**
NTFS stores file metadata in MFT. Deleted files remain in MFT until overwritten—useful for forensics.

### Linux Permission Model

**The rwx triplet:**
Every file has three permission sets: Owner, Group, Others.

```
ls -l output decoded:

-rwxr-xr-- 1 alice developers 4096 Jan 15 10:30 script.sh
│└┬┘└┬┘└┬┘   │     │
│ │  │  │    │     └── Group
│ │  │  │    └── Owner
│ │  │  └── Others: read only (r--)
│ │  └── Group: read + execute (r-x)
│ └── Owner: read + write + execute (rwx)
└── File type (- = regular, d = directory, l = link)
```

**Permission meaning:**

| Permission | On Files | On Directories |
|------------|----------|----------------|
| **r (read)** | View contents | List contents |
| **w (write)** | Modify contents | Create/delete files in it |
| **x (execute)** | Run as program | Enter (cd into) directory |

**Numeric (octal) notation:**
```
r = 4, w = 2, x = 1

chmod 755 = rwxr-xr-x = Owner: 7(rwx), Group: 5(r-x), Others: 5(r-x)
chmod 600 = rw------- = Owner: 6(rw-), Group: 0(---), Others: 0(---)
chmod 777 = rwxrwxrwx = Everyone can do everything (DANGEROUS!)
```

**Special permissions:**

| Bit | Name | On Files | On Directories |
|-----|------|----------|----------------|
| **SUID (4000)** | Set User ID | Run as file owner | No effect |
| **SGID (2000)** | Set Group ID | Run as file group | New files inherit group |
| **Sticky (1000)** | Sticky bit | Legacy | Only owner can delete files |

**SUID is critical for privilege escalation:**
```
-rwsr-xr-x 1 root root /usr/bin/passwd

      ^
      │
      └── 's' means SUID: This runs as 'root' regardless of who executes it

If an attacker can exploit a SUID binary, they gain root privileges.
```

### Windows ACL Model

**More granular than Unix:**
Windows ACLs (Access Control Lists) specify permissions per-user or per-group with fine granularity.

**ACL components:**
- **DACL (Discretionary ACL):** Who can access
- **SACL (System ACL):** Audit logging
- **ACE (Access Control Entry):** Individual permission rule

**Permission types:**
```
Standard permissions:
- Full Control
- Modify
- Read & Execute
- List Folder Contents
- Read
- Write

Advanced permissions (granular):
- Traverse Folder / Execute File
- List Folder / Read Data
- Read Attributes
- Read Extended Attributes
- Create Files / Write Data
- Create Folders / Append Data
- Write Attributes
- Write Extended Attributes
- Delete
- Read Permissions
- Change Permissions
- Take Ownership
```

**Viewing Windows permissions:**
```cmd
icacls C:\Windows\System32\cmd.exe
```

### Permission Escalation Opportunities

**Common Linux misconfigurations:**

| Misconfiguration | Risk | Example |
|-----------------|------|---------|
| World-writable files | Anyone can modify | `chmod 777 /etc/passwd` |
| SUID on custom scripts | Root execution | Exploit the script |
| SUID on vulnerable binaries | GTFOBins exploitation | SUID vim, find, etc. |
| Weak directory permissions | File replacement | Writable /usr/local/bin |
| Sudo misconfigurations | Command abuse | `sudo vim` → shell escape |

**Finding SUID binaries:**
```bash
find / -perm -4000 -type f 2>/dev/null
```

**Common Windows misconfigurations:**

| Misconfiguration | Risk | Example |
|-----------------|------|---------|
| Weak service permissions | Service hijacking | Replace service executable |
| Unquoted service paths | Path interception | C:\Program Files\App → C:\Program.exe |
| Writable PATH directories | DLL hijacking | Place malicious DLL |
| Modifiable scheduled tasks | Task hijacking | Change task action |

### Sensitive Files and Locations

**Linux critical files:**

| File | Purpose | Permission Should Be |
|------|---------|---------------------|
| `/etc/passwd` | User accounts | 644 (world-readable, but no write) |
| `/etc/shadow` | Password hashes | 640 or 600 (root/shadow only) |
| `/etc/sudoers` | Sudo configuration | 440 (read-only, root) |
| `~/.ssh/id_rsa` | SSH private key | 600 (owner only) |
| `/root/` | Root home | 700 (root only) |

**Windows critical locations:**
- `C:\Windows\System32\config\` - Registry hives (SAM, SYSTEM)
- `C:\Windows\System32\` - System binaries
- `C:\Users\[user]\AppData\` - Application data
- `C:\Program Files\` - Installed applications

---

## 3. Guided Practice

### Exercise 1: Permission Analysis

Create files with different permissions and test access:

```bash
# Create test file
echo "secret data" > secret.txt

# View current permissions
ls -l secret.txt

# Make owner-only
chmod 600 secret.txt
ls -l secret.txt

# Try accessing as different user (if possible)
sudo -u nobody cat secret.txt  # Should fail

# Make world-readable
chmod 644 secret.txt
sudo -u nobody cat secret.txt  # Should work
```

### Exercise 2: SUID Discovery

Find and analyze SUID binaries:

```bash
# Find all SUID files
find / -perm -4000 -type f 2>/dev/null

# Analyze one (e.g., passwd)
ls -l /usr/bin/passwd
file /usr/bin/passwd

# Check if any are exploitable (gtfobins.github.io)
```

Record your findings:
- Number of SUID binaries found: ___
- Any unusual ones? ___

### Exercise 3: Permission Impact

Demonstrate permission effects:

```bash
# Create executable script
echo '#!/bin/bash' > test.sh
echo 'echo "Hello"' >> test.sh

# Try to run without execute permission
./test.sh  # Should fail

# Add execute permission
chmod +x test.sh
./test.sh  # Should work

# Remove read permission, keep execute
chmod 100 test.sh
./test.sh  # What happens?
cat test.sh  # What happens?
```

Answer: What happens when a script is executable but not readable? ___

---

## 4. Reflection Check

### Permission Logic
1. You have write permission on a directory but not on a file inside it. Can you delete the file? Why or why not?

2. Why is `chmod 777` considered dangerous, even for files you own?

3. A file is owned by root with permissions 600. You are not root but are in the sudoers file. Can you read it?

### Security Implications
1. Why should SSH private keys be mode 600? What could go wrong otherwise?

2. If `/etc/shadow` is accidentally made world-readable, what's the impact? How quickly does it become critical?

3. An attacker discovers a SUID binary with a known vulnerability. What happens next?

### Forensics Angle
1. You delete a file. Is the data really gone? What determines whether it can be recovered?

2. What filesystem metadata survives file deletion and is useful for forensics?

3. How do NTFS Alternate Data Streams complicate malware detection?

---

## 5. Key Misconceptions

**MYTH: "Deleting a file removes the data from disk"**
REALITY: Deletion removes the directory entry and marks space available. Actual data remains until overwritten.

**MYTH: "If I can't see a file (no read on directory), it's secure"**
REALITY: If the full path is known, and file permissions allow access, the file can still be read directly.

**MYTH: "Windows permissions are simpler than Linux"**
REALITY: Windows ACLs are actually more complex with inheritance, explicit/inherited ACEs, and allow/deny precedence.

**MYTH: "SUID programs are inherently insecure"**
REALITY: SUID is a feature for privilege elevation. It's insecure only if the program has vulnerabilities or allows escape.

**MYTH: "File extension determines if something can execute"**
REALITY: On Linux, execute permission matters, not extension. On Windows, extension matters for double-click, but not for direct execution.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Read** and interpret Linux permission strings (`ls -l` output)
2. **Modify** permissions using both symbolic and numeric chmod
3. **Explain** SUID/SGID/sticky bits and their security implications
4. **Identify** common permission-based privilege escalation vectors
5. **Understand** filesystem concepts relevant to forensics

---

## 7. Further Depth (Optional)

*   **Practice:** Set up a deliberately misconfigured system and exploit the permissions
*   **Research:** Study NTFS Alternate Data Streams and forensic implications
*   **Tools:** Learn to use `getfacl`/`setfacl` for Linux ACLs
*   **Exploration:** Research POSIX capabilities as an alternative to SUID
