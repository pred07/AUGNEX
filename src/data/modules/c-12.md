# Validating Authentication Visibility

## 1. Orientation

### What this module covers
This module covers testing your visibility into authentication events—the critical security controls around identity. If you can't see logins clearly, you're blind to compromised credentials, lateral movement, and identity-based attacks.

### Fit in the Learning Path
"Identity is the new perimeter." Modern attacks increasingly use valid credentials rather than malware. Visibility into authentication—who, where, when, how—is essential for detecting these attacks.

### Learning Objectives
By the end of this module, you will:
*   Validate authentication logging coverage
*   Detect anomalous authentication patterns
*   Identify pass-the-hash and credential attacks
*   Test authentication visibility through purple teaming

---

## 2. Core Content

### Mental Model: The Identity Battleground

**How professionals think about this:**
Attackers often skip malware entirely—stolen credentials are cleaner, stealthier, and look legitimate. Your ability to distinguish legitimate authentication from credential abuse is critical to detecting modern attacks.

```
AUTHENTICATION VISIBILITY:

TRADITIONAL ATTACK:
─────────────────────────────
Malware → Detection → Alert

MODERN ATTACK:
─────────────────────────────
Stolen Creds → Valid Login → ??? (Looks normal)

THE VISIBILITY CHALLENGE:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  Legitimate Login            vs        Credential Abuse            │
│                                                                     │
│  User: Alice                           User: "Alice" (attacker)    │
│  Time: 9:00 AM                         Time: 3:00 AM               │
│  Location: Office                      Location: Russia            │
│  Device: Corp laptop                   Device: Unknown             │
│  Behavior: Normal                      Behavior: Reconnaissance    │
│                                                                     │
│  BOTH LOOK THE SAME IN BASIC LOGS:                                 │
│  "Event 4624: Logon Success - Alice"                               │
│                                                                     │
│  DIFFERENCE REQUIRES:                                              │
│  - Source IP/location                                              │
│  - Time analysis                                                   │
│  - Device identification                                           │
│  - Behavior analysis                                               │
│  - Historical baseline                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Authentication Event Types

**Understanding Windows logon events:**

```
KEY AUTHENTICATION EVENTS:

SUCCESS EVENTS:
─────────────────────────────
4624: Logon Success
      Key fields: Logon Type, Source IP, Account Name
      
4628: User added to special group
4672: Special privileges assigned
4648: Explicit credential logon

FAILURE EVENTS:
─────────────────────────────
4625: Logon Failure
      Key fields: Failure Reason, Source IP, Target Account
      
4771: Kerberos pre-auth failed
4776: NTLM authentication failed

KERBEROS EVENTS:
─────────────────────────────
4768: TGT Requested (initial authentication)
4769: Service Ticket Requested
4770: Service Ticket Renewed

ACCOUNT EVENTS:
─────────────────────────────
4720: User account created
4724: Password reset attempt
4728/4732/4756: User added to group
```

### Logon Types Deep Dive

**What each logon type reveals:**

```
LOGON TYPE ANALYSIS:

Type 2: Interactive (Console)
────────────────────────────
User physically at keyboard
Example: Logging into workstation
Alert if: Service account logs in interactively

Type 3: Network
────────────────────────────
Access network resource (file share, etc.)
Example: Mapping drive, accessing share
Alert if: Admin account used across many systems

Type 4: Batch
────────────────────────────
Scheduled task execution
Example: Backup job runs
Alert if: Batch logon to unusual system

Type 5: Service
────────────────────────────
Service account starting
Example: SQL Server service starts
Alert if: Service account used interactively

Type 7: Unlock
────────────────────────────
User unlocks locked workstation
Normal, usually

Type 9: NewCredentials (RunAs)
────────────────────────────
RunAs with different credentials
Example: Admin using different account
Alert if: Unusual credential pairing

Type 10: RemoteInteractive (RDP)
────────────────────────────
Remote Desktop connection
Example: Admin RDPs to server
Alert if: Service account RDPs (should never happen)
Alert if: Unusual source for RDP

Type 11: CachedInteractive
────────────────────────────
Domain controller unreachable, cached creds
Alert if: Frequent when DC is reachable
```

### Detecting Credential Attacks

**Pass-the-Hash and beyond:**

```
CREDENTIAL ATTACK DETECTION:

PASS-THE-HASH (PtH):
─────────────────────────────
Attack: Use NTLM hash without knowing password
Log: Event 4624, Type 3 (Network)
Indicator: Key Length = 0 (instead of 128)

Detection Rule:
EventID=4624 AND LogonType=3 AND KeyLength=0

PASS-THE-TICKET (PtT):
─────────────────────────────
Attack: Use stolen Kerberos ticket
Log: Event 4769 (Service Ticket Request)
Indicator: Ticket requested from unusual IP

Detection: Correlation between 4624 and 4769
           Source IP mismatch = suspicious

GOLDEN TICKET:
─────────────────────────────
Attack: Forged TGT with domain admin
Log: May not log if KRBTGT compromised
Indicator: Ticket lifetime unusual (>10 hours)

Detection: 4769 without prior 4768
           Impossible account access patterns

KERBEROASTING:
─────────────────────────────
Attack: Request service tickets, crack offline
Log: Event 4769 (many service ticket requests)
Indicator: One user requests many tickets

Detection: Count(4769) by User > threshold
```

### Password Attack Detection

**Spraying and brute force:**

```
PASSWORD ATTACK PATTERNS:

BRUTE FORCE:
─────────────────────────────
Pattern: Many failures, one account

Event log: Many 4625s, same target account
           Different source IPs possible

Detection:
COUNT(4625) WHERE TargetAccount = X > 10
WITHIN 5 minutes

SPRAY ATTACK:
─────────────────────────────
Pattern: One failure per account, many accounts

Event log: Many 4625s, different accounts
           Same or few source IPs

Detection:
COUNT(DISTINCT TargetAccount) WHERE SourceIP = X > 50
WITHIN 10 minutes

CREDENTIAL STUFFING:
─────────────────────────────
Pattern: Mix of success and failure
         Credentials from breach databases

Detection: Unusual success rate from single source
           Logins from known bad IPs
           
SMART AGGREGATION:
─────────────────────────────
Don't alert on each 4625
Aggregate: "Password spray detected
            100 accounts targeted in 5 minutes
            Source: 10.0.0.50"
```

### Service Account Monitoring

**High-value account visibility:**

```
SERVICE ACCOUNT VISIBILITY:

SERVICE ACCOUNTS SHOULD:
─────────────────────────────
✓ Only login as Type 5 (Service)
✓ Only login to specific systems
✓ Only login at specific times
✓ Never login interactively (Type 2, 10)
✓ Never be used by humans

DETECTION RULES:
─────────────────────────────
Alert: Service account interactive login
Rule: Account IN [service_accounts] AND LogonType IN (2, 10)

Alert: Service account on unusual system
Rule: Account IN [service_accounts] AND 
      Workstation NOT IN [expected_systems]

Alert: Service account from unusual source
Rule: Account IN [service_accounts] AND
      SourceIP NOT IN [expected_sources]

Alert: Service account fails authentication
Rule: Account IN [service_accounts] AND EventID = 4625
Priority: HIGH (service accounts have known passwords)
```

### Cloud Authentication

**Extending visibility to cloud:**

```
CLOUD AUTHENTICATION VISIBILITY:

AZURE AD / ENTRA ID:
─────────────────────────────
Source: Azure AD Sign-in logs
        Azure AD Audit logs

Key events:
- Sign-in success/failure
- MFA status
- Conditional Access results
- Risk detections

Forward to: SIEM via Azure Sentinel
            Or API integration

AWS:
─────────────────────────────
Source: CloudTrail
Events: ConsoleLogin, AssumeRole, 
        GetSessionToken

O365:
─────────────────────────────
Source: Unified Audit Log
Events: UserLoggedIn, MailboxLogin

THE GAP:
─────────────────────────────
If you only watch on-prem AD:
- Miss cloud-only attacks
- Miss hybrid attacks
- Miss SaaS compromise

ALL IDENTITY PROVIDERS MUST FORWARD LOGS
```

### Purple Team Validation

**Testing authentication visibility:**

```
PURPLE TEAM AUTH VALIDATION:

TEST 1: BASIC VISIBILITY
─────────────────────────────
Action: Login as test user
Check: Does 4624 appear in SIEM?
       Is source IP captured?
       Is logon type correct?

TEST 2: FAILURE DETECTION
─────────────────────────────
Action: 10 failed logins, 1 account
Check: Does aggregated alert fire?
       Is account visible?

TEST 3: SPRAY DETECTION
─────────────────────────────
Action: 1 failure each, 100 accounts
Check: Does spray detection fire?
       Is source identified?

TEST 4: PASS-THE-HASH
─────────────────────────────
Action: Use Mimikatz for PtH
Check: Does 4624 show Key Length = 0?
       Does detection rule fire?

TEST 5: ANOMALY DETECTION
─────────────────────────────
Action: Login from unusual location/time
Check: Does behavioral detection alert?
       Is context captured?

TEST 6: SERVICE ACCOUNT ABUSE
─────────────────────────────
Action: RDP using service account
Check: Does "service account Type 10" alert?
       Priority appropriate?
```

---

## 3. Guided Practice

### Exercise 1: Logon Type Analysis

For each scenario, identify logon type and detection opportunity:

| Scenario | Logon Type | Detection |
|----------|------------|-----------|
| User RDPs to server | ___ | ___ |
| Service starts | ___ | ___ |
| Admin maps network drive | ___ | ___ |
| Attacker uses PtH | ___ | ___ |

### Exercise 2: Password Attack Detection

Design detection for password spray:

Event ID: ___
Aggregation: ___
Threshold: ___
Time window: ___
Alert content: ___

### Exercise 3: Visibility Audit

Check your environment:

| Auth Source | Logged | To SIEM | Alerted | Gap? |
|-------------|--------|---------|---------|------|
| Windows AD | ___ | ___ | ___ | ___ |
| Azure AD | ___ | ___ | ___ | ___ |
| VPN | ___ | ___ | ___ | ___ |
| SaaS apps | ___ | ___ | ___ | ___ |

---

## 4. Reflection Check

### Authentication Understanding
1. 4624 shows success from Russia IP. User is in US. Incident?

2. Service account logs in Type 10 (RDP). Severity?

3. 100 failed logins, 100 different accounts, 1 source IP. Attack type?

### Strategic Thinking
1. Azure AD logs not forwarded. On-prem covered. Acceptable?

2. Can't detect Key Length = 0. Impact?

3. All logins look normal but data is exfiltrating. What did you miss?

---

## 5. Key Misconceptions

**MYTH: "We log all logons, so we're covered"**
REALITY: Logging ≠ analyzing ≠ alerting. Context matters.

**MYTH: "Failed logins are the key indicator"**
REALITY: Modern attacks minimize failures. Focus on anomalous success too.

**MYTH: "Service accounts are low priority"**
REALITY: Service accounts often have high privileges. Abuse is critical.

**MYTH: "MFA makes credential attacks impossible"**
REALITY: MFA helps but can be bypassed (token theft, SIM swap, fatigue).

**MYTH: "We'd notice an unusual login"**
REALITY: Without automation, unusual logins hide in legitimate volume.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Interpret** Windows logon event types
2. **Detect** password attacks (brute force, spray)
3. **Identify** credential theft indicators (PtH, PtT)
4. **Monitor** service account abuse
5. **Validate** authentication visibility through testing

---

## 7. Further Depth (Optional)

*   **Tool:** Microsoft Defender for Identity
*   **Practice:** Purple team authentication testing
*   **Resource:** MITRE ATT&CK Credential Access techniques
*   **Reading:** Golden/Silver ticket attack research
