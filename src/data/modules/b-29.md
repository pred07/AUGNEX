# Kubernetes Architecture & Attack Surface

## 1. Orientation

### What this module covers
Kubernetes (K8s) is the OS of the Cloud. It orchestrates containers. It is notoriously complex and insecure by default. This module explains the **Control Plane**, **Worker Nodes**, and the API Server.

### Learning Objectives
*   Map the K8s Architecture (Etcd, API Server, Kubelet).
*   Identify the **Kubelet** as a primary attack vector.
*   Understand the concept of **Pods** vs Containers.

---

## 2. Core Content

### The Control Plane (The Brain)
1.  **API Server:** The front door. REST API. Everyone talks to this.
2.  **Etcd:** The database. Stores all state (and secrets). **Target #1**.
3.  **Scheduler:** Decides where to put pods.
4.  **Controller Manager:** Enforces state.

### The Worker Node (The Muscle)
1.  **Kubelet:** The agent running on the node. Takes orders from API Server.
2.  **Kube-proxy:** Handles networking.
3.  **Container Runtime:** (Docker/Containerd).

### The Attack Surface
*   **Anonymous Access:** Older K8s versions allowed anonymous access to the API server.
*   **Kubelet API:** Often left open on port 10250. Allows remote code execution if unauthenticated.
*   **Secrets:** Stored in Etcd. If Etcd is not encrypted at rest, anyone with disk access can read all secrets.

---

## 3. Lab: Talking to the API

### Scenario
You land on a compromised pod.

1.  **Check Service Account:**
    `ls /var/run/secrets/kubernetes.io/serviceaccount/`
    *   You see `token` and `ca.crt`.
2.  **Use the Token:**
    ```bash
    TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    curl -k -H "Authorization: Bearer $TOKEN" https://kubernetes.default/api/v1/pods
    ```
3.  **Result:**
    *   *Forbidden (403):* Good. RBAC is working.
    *   *JSON List of Pods:* Bad. The Service Account has too many permissions.

---

## 4. Reflection
1.  Why is Etcd called the "Crown Jewels"? (Because if you write to Etcd, you change the cluster state. You can write "Make me Admin" directly into the DB).
2.  What is a "Sidecar"? (A helper container running in the same pod as the main app. Often used for logging or service mesh proxies).
