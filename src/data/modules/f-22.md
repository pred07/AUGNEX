# DNS and Name Resolution

## 1. Orientation

### What this module covers
This module covers the Domain Name System (DNS)—the internet's phonebook that translates human-readable names to IP addresses. DNS is critical infrastructure and a common attack vector.

### Fit in the Learning Path
Attackers abuse DNS constantly—for reconnaissance (subdomain enumeration), for C2 (DNS tunneling), and for manipulation (DNS poisoning). Understanding DNS is essential for both offensive and defensive security.

### Learning Objectives
By the end of this module, you will:
*   Understand DNS hierarchy and resolution
*   Query different record types
*   Recognize DNS attacks
*   Implement DNS security measures

---

## 2. Core Content

### Mental Model: The Phone Book

**How professionals think about this:**
DNS is a distributed database that maps names to numbers. Like a phone book, you look up a name and get an address. Unlike a phone book, DNS is hierarchical, distributed, and frequently abused.

```
DNS RESOLUTION PROCESS:

User types: www.example.com
                ↓
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 1: LOCAL CACHE                                               │
│  Browser cache → OS cache → Hosts file                            │
│  "Do I already know this?"                                         │
│  If yes → Return immediately                                       │
└───────────────────────────────────┬─────────────────────────────────┘
                                    ↓ Not found
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 2: RECURSIVE RESOLVER                                        │
│  Usually ISP or configured (8.8.8.8, 1.1.1.1)                      │
│  "Let me find this for you"                                        │
└───────────────────────────────────┬─────────────────────────────────┘
                                    ↓ Query Root
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 3: ROOT SERVER (.)                                           │
│  13 root server clusters worldwide                                 │
│  "I don't know, but .COM is handled by these servers"             │
└───────────────────────────────────┬─────────────────────────────────┘
                                    ↓ Query TLD
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 4: TLD SERVER (.com)                                         │
│  "I don't know, but EXAMPLE.COM is handled by these servers"      │
└───────────────────────────────────┬─────────────────────────────────┘
                                    ↓ Query Authoritative
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 5: AUTHORITATIVE SERVER                                      │
│  "Yes! www.example.com = 93.184.216.34"                            │
│  Returns with TTL (Time to Live)                                   │
└───────────────────────────────────┬─────────────────────────────────┘
                                    ↓
                              Result cached
                              Connection proceeds
```

### DNS Record Types

**Common record types:**

| Record | Purpose | Example |
|--------|---------|---------|
| **A** | Name → IPv4 | `www` → `192.168.1.1` |
| **AAAA** | Name → IPv6 | `www` → `2001:db8::1` |
| **CNAME** | Alias → Canonical name | `www` → `server1.example.com` |
| **MX** | Mail server | `10 mail.example.com` |
| **TXT** | Text data | SPF, DKIM, verification |
| **NS** | Nameserver | `ns1.example.com` |
| **SOA** | Zone authority | Start of authority info |
| **PTR** | IP → Name (reverse) | `1.1.168.192` → `www.example.com` |
| **SRV** | Service location | `_ldap._tcp` → server |

**Security-relevant records:**

```
SPF (TXT) - Email sender verification:
v=spf1 include:_spf.google.com ~all

DKIM (TXT) - Email signature verification:
k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQK...

DMARC (TXT) - Email policy:
v=DMARC1; p=reject; rua=mailto:dmarc@example.com
```

### DNS Query Tools

**Interrogating DNS:**

```
NSLOOKUP (Windows/Linux):
─────────────────────────────
nslookup example.com           # A record
nslookup -type=mx example.com  # MX records
nslookup -type=txt example.com # TXT records
nslookup -type=ns example.com  # Nameservers
nslookup -type=any example.com # All records

DIG (Linux, preferred):
─────────────────────────────
dig example.com                # A record
dig example.com MX             # MX records
dig example.com TXT            # TXT records
dig example.com ANY            # All records
dig +short example.com         # Just the answer
dig +trace example.com         # Full resolution path
dig @8.8.8.8 example.com       # Use specific resolver

HOST (Linux):
─────────────────────────────
host example.com               # A record
host -t mx example.com         # MX record
```

### The Hosts File

**Local DNS override:**

```
HOSTS FILE LOCATION:
─────────────────────────────
Windows: C:\Windows\System32\drivers\etc\hosts
Linux:   /etc/hosts
macOS:   /etc/hosts

FORMAT:
─────────────────────────────
IP_ADDRESS    HOSTNAME    [ALIAS]
127.0.0.1     localhost
192.168.1.10  intranet.company.com  intranet

SECURITY USES:
─────────────────────────────
Block malware: 127.0.0.1 malware.com
Block ads:     127.0.0.1 ads.example.com
Testing:       192.168.1.50 staging.myapp.com

MALWARE ABUSE:
─────────────────────────────
Redirect bank.com to attacker IP
Block antivirus update servers
Redirect to phishing sites
```

### DNS Security Threats

**Attack types:**

```
DNS ATTACKS:

1. DNS CACHE POISONING
   ─────────────────────────────
   Attacker injects false record into resolver cache
   All users of that resolver get wrong answer
   
   User asks: bank.com?
   Resolver cache (poisoned): bank.com = ATTACKER_IP
   User connects to attacker's fake bank
   
   Defense: DNSSEC, randomized source ports

2. DNS SPOOFING
   ─────────────────────────────
   Attacker responds to DNS query faster than real server
   On local network (MITM position)
   
   Defense: DNSSEC, encrypted DNS

3. DNS TUNNELING
   ─────────────────────────────
   Encode data in DNS queries for exfiltration/C2
   
   Query: aGVsbG8gd29ybGQ=.data.evil.com
          └── Base64 encoded data
   
   Defense: Monitor DNS query patterns, block suspicious

4. DNS AMPLIFICATION (DDoS)
   ─────────────────────────────
   Attacker sends small query with spoofed source = victim
   DNS responds with large answer to victim
   Amplification factor: 50-100x
   
   Defense: Response rate limiting, BCP38

5. DNS REBINDING
   ─────────────────────────────
   Attacker controls DNS for evil.com
   First query: evil.com = ATTACKER_IP (victim loads page)
   Second query: evil.com = 192.168.1.1 (internal IP)
   JavaScript now accesses internal network
   
   Defense: Validate Host header, block private IPs in DNS

6. SUBDOMAIN TAKEOVER
   ─────────────────────────────
   CNAME points to cloud service (S3, Azure, etc.)
   Company stops using but leaves DNS record
   Attacker claims the cloud resource
   Now controls the subdomain
   
   Defense: Remove stale DNS records, monitor
```

### DNS Security Solutions

**Protecting DNS:**

```
DNSSEC (DNS Security Extensions):
─────────────────────────────
Cryptographically signs DNS records
Resolver can verify authenticity
Prevents cache poisoning and spoofing

Chain of trust:
Root → .com → example.com
Each level signs the next

DNS-over-HTTPS (DoH):
─────────────────────────────
DNS queries encrypted over HTTPS
ISP cannot see queries
Bypasses some filtering

DNS-over-TLS (DoT):
─────────────────────────────
DNS queries encrypted over TLS
Uses port 853
Enterprise can still filter (block port 853)

DEFENSE COMPARISON:
─────────────────────────────
DNSSEC: Integrity (not confidentiality)
DoH/DoT: Confidentiality (not integrity)
Both together: Complete protection
```

### DNS Reconnaissance

**Gathering intelligence:**

```
SUBDOMAIN ENUMERATION:
─────────────────────────────
# Brute force subdomains
gobuster dns -d example.com -w subdomains.txt

# Online sources
amass enum -d example.com

# Certificate transparency logs
crt.sh search for *.example.com

ZONE TRANSFER (if misconfigured):
─────────────────────────────
dig axfr @ns1.example.com example.com
# Returns all DNS records for domain
# Should be restricted, but often isn't

REVERSE DNS:
─────────────────────────────
# Find hostnames for IP range
dig -x 192.168.1.1

WHAT ATTACKERS LEARN:
─────────────────────────────
- Internal naming conventions
- Server roles (mail, ftp, dev, staging)
- IP address ranges
- Third-party services
- Email infrastructure (MX, SPF)
```

---

## 3. Guided Practice

### Exercise 1: DNS Queries

Perform these queries and record results:

| Query | Command | Result |
|-------|---------|--------|
| Google's IP | `nslookup google.com` | ___ |
| Google's mail servers | `nslookup -type=mx google.com` | ___ |
| Google's nameservers | `nslookup -type=ns google.com` | ___ |

### Exercise 2: Reconnaissance

For your organization's domain (or a test domain):

1. What are the MX records? ___
2. What TXT records exist? ___
3. Can you find any subdomains? ___

### Exercise 3: Hosts File

1. Open your hosts file (admin required)
2. Add: `127.0.0.1 test.local`
3. Try to `ping test.local`
4. Result: ___

---

## 4. Reflection Check

### DNS Understanding
1. DNS query uses UDP 53. Response is 5KB. What happens?

2. TTL is 86400 seconds. What does this mean?

3. CNAME for www points to server1. A record for server1 changes. Does www change?

### Security Thinking
1. You control victim's DNS server. What attacks possible?

2. DNS queries are encrypted (DoH). Can employer still filter?

3. Zone transfer succeeds. Why is this bad?

---

## 5. Key Misconceptions

**MYTH: "DNS is just name to IP"**
REALITY: DNS stores many record types—mail routing, verification, service location.

**MYTH: "HTTPS protects DNS queries"**
REALITY: DNS happens before HTTPS connection. DNS queries are visible unless using DoH/DoT.

**MYTH: "DNS is reliable and trustworthy"**
REALITY: DNS was designed without security. Attacks are common without DNSSEC.

**MYTH: "Internal DNS is safe"**
REALITY: Internal DNS can be poisoned. Malware on internal network can redirect.

**MYTH: "Blocking malicious domains is easy"**
REALITY: Attackers use DGA, fast-flux, and cloud fronting to evade blocking.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Query** DNS using nslookup or dig
2. **Identify** different record types and purposes
3. **Explain** the DNS resolution process
4. **Recognize** DNS attack types
5. **Apply** DNS security measures

---

## 7. Further Depth (Optional)

*   **Practice:** Enumerate subdomains of test targets
*   **Tool:** Explore DNSRecon for comprehensive DNS analysis
*   **Research:** DNS-over-HTTPS browser settings
*   **Lab:** Set up BIND DNS server and experiment
