# Shells Explained (Bash, Zsh)

## 1. Orientation

### What this module covers
This module examines the command-line shell—the primary interface for security professionals. We compare Bash and Zsh, explore configuration, customization, and the security implications of shell environments.

### Fit in the Learning Path
You will spend thousands of hours in the shell. Understanding shell mechanics, customization, and security implications separates efficient operators from those fighting their own environment.

### Learning Objectives
By the end of this module, you will:
*   Understand shell types and their differences
*   Configure shell environments effectively
*   Create aliases and functions for efficiency
*   Recognize shell-related security implications

---

## 2. Core Content

### Mental Model: The Shell as Interface

**How professionals think about this:**
The shell is your command interpreter—it takes text commands, interprets them, and executes system calls. The shell you use and how you configure it impacts your efficiency and operational security.

```
SHELL ARCHITECTURE:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│   YOU (Human)                                                       │
│     │                                                               │
│     │ Type: ls -la                                                  │
│     ▼                                                               │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  SHELL (bash, zsh, sh)                                      │   │
│   │                                                             │   │
│   │  1. Parse command                                           │   │
│   │  2. Expand wildcards ($*, glob)                             │   │
│   │  3. Handle redirections (>, |)                              │   │
│   │  4. Fork child process                                       │   │
│   │  5. Execute binary                                          │   │
│   └────────────────────────────┬────────────────────────────────┘   │
│                                │                                    │
│                                ▼                                    │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  KERNEL                                                     │   │
│   │  - Execute /bin/ls                                          │   │
│   │  - Return output                                            │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                │                                    │
│                                ▼                                    │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  OUTPUT                                                     │   │
│   │  drwxr-xr-x 2 user user 4096 Jan 15 10:00 .                 │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Shell Comparison

**Major shells:**

| Shell | Path | Default In | Features |
|-------|------|-----------|----------|
| **sh** | /bin/sh | POSIX scripts | Minimal, universal |
| **bash** | /bin/bash | Most Linux | Scripts, completion, history |
| **zsh** | /bin/zsh | Kali, macOS | Plugins, themes, better completion |
| **fish** | /usr/bin/fish | None (install) | User-friendly, syntax highlighting |

**Feature comparison:**

```
SHELL FEATURES:

                     sh    bash   zsh    fish
────────────────────────────────────────────────
Tab completion       Basic  Good  Great  Excellent
Syntax highlighting   No    No    Plugin  Built-in
Plugin ecosystem      No    Some  Great  Good
Script compatibility High   High  Good   Different
Customization        Low   Medium High   High
Default prompts      Basic  Basic Great  Colorful
Performance          Fast  Fast  Medium Medium
```

### Configuration Files (Dotfiles)

**How shells load configuration:**

```
SHELL STARTUP FILES:

LOGIN SHELL (ssh, console login):
sh:   /etc/profile → ~/.profile
bash: /etc/profile → ~/.bash_profile → ~/.bash_login → ~/.profile
zsh:  /etc/zprofile → ~/.zprofile → ~/.zshrc → ~/.zlogin

INTERACTIVE NON-LOGIN (opening terminal):
bash: ~/.bashrc
zsh:  ~/.zshrc

ORDER MATTERS:
┌────────────────────────────────────────────────────────────────┐
│  /etc/profile            System-wide (all users)               │
│       │                                                        │
│       ▼                                                        │
│  ~/.bash_profile         User login config (once per login)    │
│       │                                                        │
│       ▼                                                        │
│  ~/.bashrc               User interactive config (each shell)  │
│       │                                                        │
│       ▼                                                        │
│  ~/.bash_logout          Cleanup on logout                     │
└────────────────────────────────────────────────────────────────┘
```

### Creating Aliases

**Alias syntax:**

```bash
# Basic alias
alias ll='ls -la'
alias update='sudo apt update && sudo apt upgrade'
alias myip='curl -s ifconfig.me'

# View existing aliases
alias

# Remove alias (current session)
unalias ll

# Common security-related aliases
alias ports='netstat -tulanp'
alias listening='ss -tuln'
alias connections='ss -tp'
alias hgrep='history | grep'
alias please='sudo !!'
```

**Functions vs aliases:**

```bash
# Alias: Simple command substitution
alias mkcd='mkdir -p $1 && cd $1'  # WRONG - $1 doesn't work here

# Function: For complex logic with arguments
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Usage:
mkcd new_directory

# Function with multiple operations
extract() {
    case "$1" in
        *.tar.gz)  tar xzf "$1" ;;
        *.zip)     unzip "$1" ;;
        *.gz)      gunzip "$1" ;;
        *)         echo "Unknown format" ;;
    esac
}
```

### Environment Variables

**Critical variables:**

```bash
# View all environment variables
env
printenv

# Important variables:
$PATH    # Where shell looks for binaries
$HOME    # User's home directory
$USER    # Current username
$SHELL   # Current shell path
$PWD     # Current working directory
$EDITOR  # Default text editor
$TERM    # Terminal type
$PS1     # Prompt string (appearance)

# View specific variable
echo $PATH

# Set variable (current session)
export HISTSIZE=10000

# Append to PATH
export PATH="$PATH:/new/directory"

# Prepend to PATH (takes precedence)
export PATH="/new/directory:$PATH"
```

### Prompt Customization (PS1)

**Understanding PS1:**

```bash
# Bash prompt variables:
\u  - Username
\h  - Hostname (short)
\w  - Working directory
\W  - Working directory (basename only)
\$  - $ for user, # for root
\t  - Current time (24h)
\d  - Date

# Example prompts:
# Default: user@host:~/directory$
PS1='\u@\h:\w\$ '

# Colored prompt (Red for root warning):
PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '

# Security-conscious prompt (show full path, highlight root):
if [ "$EUID" -eq 0 ]; then
    PS1='\[\033[01;31m\]ROOT@\h:\w\#\[\033[00m\] '
else
    PS1='\[\033[01;32m\]\u@\h:\w\$\[\033[00m\] '
fi
```

### Shell History

**History configuration:**

```bash
# History settings in .bashrc/.zshrc:
HISTSIZE=10000           # Lines in memory
HISTFILESIZE=20000       # Lines in file
HISTFILE=~/.bash_history # History file location
HISTCONTROL=ignoreboth   # Ignore duplicates and space-prefixed

# History commands:
history                  # Show history
history 50               # Last 50 commands
!123                     # Execute command #123
!!                       # Repeat last command
!$                       # Last argument of previous command
ctrl+r                   # Reverse search history

# Security: Don't save certain commands
HISTIGNORE="ls:cd:exit:clear"
```

**Security implications:**

```
SHELL HISTORY SECURITY:

RISKS:
├── History contains passwords typed on command line
│   mysql -u root -pSecretPassword  ← Visible in history
│
├── History persists after session
│   Attacker with file access sees commands
│
├── History may sync to cloud (zsh plugins)
│   Synced history = expanded exposure
│
└── Shared accounts expose each other's commands

MITIGATIONS:
├── Never type passwords on command line
│   mysql -u root -p (prompts for password)
│
├── Unset HISTFILE for sensitive sessions
│   unset HISTFILE
│
├── Delete specific entries
│   history -d <line_number>
│
└── Link history to /dev/null (attackers do this)
    ln -sf /dev/null ~/.bash_history
```

### Shell Scripting Security

**Security considerations:**

```bash
# DANGEROUS - command injection:
name=$1
echo "Hello $name"  # What if name="; rm -rf /"?

# SAFER - quote variables:
echo "Hello $name"  # Still vulnerable

# Use [[]] for conditionals in bash:
if [[ "$var" == "safe" ]]; then
    # Safer than [ ]
fi

# Set strict mode in scripts:
#!/bin/bash
set -euo pipefail
# -e: Exit on error
# -u: Error on undefined variable
# -o pipefail: Catch pipe failures
```

### Zsh-Specific Features

**Zsh advantages:**

```bash
# Superior glob patterns
ls **/*.txt           # Recursive glob
ls *.txt~important*   # Exclude pattern

# Better completion
git che<TAB>          # Shows options with descriptions

# Spelling correction
cd /htme → cd /home

# Directory navigation
cd ...                # Go up two directories
d                     # Directory stack (with alias)

# Oh-My-Zsh framework
# Install: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/oh-my-zsh/master/tools/install.sh)"

# Popular plugins:
plugins=(git sudo extract z)
```

---

## 3. Guided Practice

### Exercise 1: Shell Identification

```bash
# Current shell
echo $SHELL

# All available shells
cat /etc/shells

# Change default shell
chsh -s /bin/zsh
```

Current shell: ___
Available shells: ___

### Exercise 2: Alias Creation

Add to your shell config file:

```bash
# Edit config
nano ~/.zshrc  # or ~/.bashrc

# Add aliases:
alias myip='curl -s ifconfig.me'
alias ports='ss -tuln'
alias hg='history | grep'

# Reload
source ~/.zshrc

# Test
myip
```

Verify aliases work: ___ (Yes/No)

### Exercise 3: Security Audit

Examine your history:

```bash
# Check history for sensitive data
history | grep -i "password\|secret\|key"

# Check history permissions
ls -la ~/.bash_history ~/.zsh_history
```

Findings: ___

---

## 4. Reflection Check

### Shell Understanding
1. Why doesn't an alias defined in the terminal survive a reboot?

2. You need to run a command but not have it appear in history. How?

3. What determines which program runs when you type "python"?

### Security Thinking
1. An attacker has read access to ~/.bash_history. What can they learn?

2. Why might an attacker link ~/.bash_history to /dev/null?

3. You inherit a server. How do you audit what the previous admin was doing?

---

## 5. Key Misconceptions

**MYTH: "All shells are the same"**
REALITY: Shell differences affect scripting compatibility, efficiency features, and security defaults.

**MYTH: "History is private"**
REALITY: History files are readable by root and anyone with file access. Treat as sensitive.

**MYTH: "Aliases are just for convenience"**
REALITY: Aliases can be security tools (default safe flags) or risks (overriding system commands).

**MYTH: "The shell prompt is cosmetic"**
REALITY: A well-designed prompt prevents mistakes (red for root, full paths).

**MYTH: "Scripts written for bash work in sh"**
REALITY: bash has features not in POSIX sh. Use #!/bin/bash explicitly.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Identify** your current shell and configuration files
2. **Create** persistent aliases and functions
3. **Customize** your prompt effectively
4. **Manage** shell history securely
5. **Recognize** shell security implications

---

## 7. Further Depth (Optional)

*   **Tool:** Install and configure Oh-My-Zsh
*   **Practice:** Create a security-focused shell configuration
*   **Research:** Bash vs POSIX sh compatibility issues
*   **Reading:** Offensive use of shell history
