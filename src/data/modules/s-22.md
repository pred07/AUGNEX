# Intrusion Analysis & The Diamond Model

## 1. Orientation

### What this module covers
The **Diamond Model of Intrusion Analysis** is the standard framework for clustering and attributing cyber activity. Unlike the Kill Chain (which tracks the *progress* of an attack), the Diamond Model tracks the *relationships* between the bad guy, their victim, their tools, and the network.

### Fit in the Learning Path
You understand IOCs (S-14). Now you need a way to group those IOCs to tell a story. "This IP (Infrastructure) was used by this Actor (Adversary) to target this Bank (Victim) using this Malware (Capability)."

### Learning Objectives
*   Construct a **Diamond Event** from raw intelligence.
*   Pivot across the Diamond to discover new indicators.
*   Cluster events to identify **Activity Groups**.

---

## 2. Core Content

### The Four Vertices

At its core, every malicious event has four components:

1.  **Adversary (Who):** The attacker. (e.g., APT29, "Script Kiddie", Member of Finance Dept).
2.  **Victim (Whom):** The target. (e.g., Server 101, User Alice, The Energy Sector).
3.  **Capability (With What):** The tools/TTPs. (e.g., Mimikatz, Phishing Email, CVE-2023-1234).
4.  **Infrastructure (How):** The physical/logical paths. (e.g., IP Addresses, Domain Names, USB Stick).

**The Meta-Features:**
*   **Timestamp:** When did it happen?
*   **Phase:** Where in the Kill Chain?
*   **Result:** Success, Failure, Unknown.

### The Pivot (The Superpower)
The Diamond Model shines when you **pivot**.
*   *Start:* You find a malicious domain (Infrastructure).
*   *Pivot:* "What other files (Capability) beacon to this domain?" -> *Found `bad.exe`*.
*   *Pivot:* "Who else (Victim) saw `bad.exe`?" -> *Found Company B*.
*   *Pivot:* "What IP (Infrastructure) did Company B see the attack come from?" -> *New IP Found*.

### Activity Groups (Clustering)
A single Diamond is an event. A pile of Diamonds that look the same is an **Activity Group**.
*   If 50 events all use *Cobalt Strike* (Capability) and *GoDaddy Domains* (Infrastructure) targeting *Hospitals* (Victim), you have a Cluster.
*   **Analytic Warning:** Don't attribute to a specific government (Adversary) until you have evidence. Call it "Activity Group 45" until you know.

---

## 3. Lab: Constructing the Diamond

### Scenario: The "NightShift" Breach
**Intel Source:** "On Jan 4th at 02:00 UTC, the HR Server (10.0.0.5) was compromised. We found a web shell named `cmd.jsp` which accepts commands from IP `192.168.1.55`. The web shell uses a specific XOR encoding key 'DEADBEEF'."

### Task: Map the Event
*   **Adversary:** Unknown (at this stage).
*   **Victim:** HR Server (10.0.0.5) / HR Dept.
*   **Capability:** `cmd.jsp` (Web shell) + XOR Key 'DEADBEEF'.
*   **Infrastructure:** IP `192.168.1.55`.

### Task: Pivot
You search for XOR Key 'DEADBEEF' in VirusTotal.
*   **Finding:** A similar web shell `shell.php` uses the same key.
*   **New Diamond:**
    *   Adversary: Same Unknown Group (Likely).
    *   Capability: `shell.php` (New!).
    *   Victim: Search public reports... found it targeted a Retail Chain.

**Conclusion:** The same actor targets HR servers and Retail chains using XOR-encoded web shells.

---

## 4. Advanced: The Extended Model

### Socio-Political Axis
Why are they attacking?
*   **Adversary <-> Victim:** The relationship (e.g., Hacktivism, State of War, Business Competition).
*   *Example:* Identifying that the victim is a Ukrainian Utility and the Adversary is a Russian State actor adds the *Intent* context that technical indicators miss.

### Technology Axis
*   **Infrastructure <-> Capability:** How the tools interact with the network.

---

## 5. Reflection
1.  **Attribution:** Why is the "Adversary" vertex often empty or "Unknown" for months? (Because digital evidence rarely points to a human ID without OPSEC mistakes).
2.  **Kill Chain vs Diamond:** The Kill Chain is linear (Phase 1 -> 7). The Diamond is relational (Node <-> Node). Why do we need both? (Kill Chain for *Defensive Breaking*, Diamond for *Intel Clustering*).

---

## 6. Completion Criteria
1.  **Draw** a Diamond Model for a Phishing Email event.
2.  **Explain** "Pivoting" to a non-technical manager.
3.  **Differentiate** between the Diamond Model and the Cyber Kill Chain.
