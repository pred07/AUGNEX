# Firewalls: Concepts and Rule Logic

## 1. Orientation

### What this module covers
This module examines firewalls in depth—from basic packet filtering to next-generation application awareness. Understanding firewall technology and rule logic is fundamental to network security.

### Fit in the Learning Path
The firewall is often the first line of defense. A misconfigured firewall exposes the organization. Understanding how firewalls work—and their limitations—is essential for both attackers and defenders.

### Learning Objectives
By the end of this module, you will:
*   Understand firewall generations and capabilities
*   Write and audit firewall rules
*   Recognize common misconfigurations
*   Apply best practices for firewall management

---

## 2. Core Content

### Mental Model: The Traffic Controller

**How professionals think about this:**
A firewall is a policy enforcement point—it inspects traffic and decides allow or deny based on rules. The sophistication of what it can inspect determines its capabilities and limitations.

```
FIREWALL DECISION PROCESS:

PACKET ARRIVES:
       ▼
┌──────────────────────────────────────────────────────────────┐
│  RULE 1: Allow 10.0.0.0/24 → 192.168.1.100:443 ?             │
│          Does packet match? → NO → Next rule                │
├──────────────────────────────────────────────────────────────┤
│  RULE 2: Allow ANY → 192.168.1.100:80 ?                     │
│          Does packet match? → YES → ALLOW, stop processing   │
├──────────────────────────────────────────────────────────────┤
│  RULE 3: Deny 192.168.2.0/24 → ANY                          │
│          (Never reached for this packet)                     │
├──────────────────────────────────────────────────────────────┤
│  ...                                                        │
├──────────────────────────────────────────────────────────────┤
│  RULE N: Implicit DENY ALL                                   │
│          If no rules matched → DENY                          │
└──────────────────────────────────────────────────────────────┘

KEY CONCEPTS:
- First match wins
- Rules processed top to bottom
- Implicit deny at the end (best practice)
```

### Firewall Generations

**Evolution of capabilities:**

```
FIREWALL EVOLUTION:

GENERATION 1: PACKET FILTER (Stateless)
─────────────────────────────────────────
Inspects: IP addresses, Ports, Protocol
Example: "Allow any → 80/tcp"

Limitations:
- No connection tracking
- Each packet evaluated independently
- Can be bypassed by crafted packets
- No application awareness

GENERATION 2: STATEFUL INSPECTION
─────────────────────────────────────────
Inspects: Same as Gen 1 + Connection state
Example: "Allow established connections to return"

                    REQUEST
Client:50000 ──────────────────────────► Server:80
              Firewall tracks: "Connection opened"
              
                    RESPONSE
Client:50000 ◄────────────────────────── Server:80
              Firewall: "Part of established connection, allow"

Advantage:
- Return traffic automatically allowed
- Harder to bypass with crafted packets

GENERATION 3: APPLICATION AWARE (NGFW)
─────────────────────────────────────────
Inspects: Applications within protocols
Example: "Allow Facebook, Block Facebook Games"

Both use port 443, but NGFW identifies the application:
┌──────────────────────────────────────────────────────────────┐
│ HTTPS (Port 443)                                            │
│ ├── facebook.com → INSPECT APPLICATION                      │
│ │   ├── Social feed → Allow                                 │
│ │   ├── Messenger → Allow                                   │
│ │   └── Games → Block                                       │
│ ├── twitter.com → Allow                                     │
│ └── malware-c2.com → Block (threat intelligence)            │
└──────────────────────────────────────────────────────────────┘

NGFW Features:
- Application identification
- User-based policies
- Threat prevention (IPS)
- URL filtering
- SSL/TLS inspection
```

### Rule Components

**Anatomy of a firewall rule:**

```
RULE COMPONENTS (5-TUPLE):

┌────────────────────────────────────────────────────────────┐
│ SOURCE        DESTINATION    PROTOCOL/PORT    ACTION       │
│ ──────        ───────────    ─────────────    ──────       │
│ 10.0.0.0/24   192.168.1.100  TCP/443          ALLOW        │
│ │             │              │                │            │
│ │             │              │                └── Permit/Deny
│ │             │              └── What service access       │
│ │             └── Where going (target system)              │
│ └── Where from (requester)                                 │
└────────────────────────────────────────────────────────────┘

EXTENDED ATTRIBUTES:
─────────────────────────────────────────
- Schedule: "Allow only during business hours"
- User: "Allow for 'IT-Admins' group only"
- Application: "Allow 'ssh' not just port 22"
- Logging: "Log all matches"
- Comment: "Created for Project X, expires 2024-06-30"
```

### Rule Order Matters

**Top-down processing:**

```
RULE ORDER EXAMPLE:

WRONG ORDER (Shadow Rule Problem):
───────────────────────────────────
Rule 1: ALLOW Any → Web Server : 80,443
Rule 2: DENY  Attacker-IP → Web Server : Any  ← NEVER REACHED!

Attacker traffic:
1. Check Rule 1: Attacker → Web Server : 443 → MATCH → ALLOW
2. Rule 2 never evaluated

CORRECT ORDER:
───────────────────────────────────
Rule 1: DENY  Attacker-IP → Web Server : Any
Rule 2: ALLOW Any → Web Server : 80,443

Attacker traffic:
1. Check Rule 1: Attacker → Web Server : 443 → MATCH → DENY

ORDERING PRINCIPLES:
1. Most specific rules first
2. Deny rules before general allows
3. Frequently matched rules near top (performance)
4. Cleanup/logging rules at end
5. Implicit deny last
```

### Common Misconfigurations

**What goes wrong:**

| Misconfiguration | Risk | Example |
|-----------------|------|---------|
| **Any-Any-Allow** | Full exposure | "Allow any → any" |
| **Overly broad source** | Unnecessary exposure | "Allow internet → DB" |
| **HTTP instead of HTTPS** | Traffic interception | "Allow 80 to API" |
| **No egress filtering** | C2/exfiltration | Server can reach any IP |
| **Shadow rules** | Intended deny bypassed | Allow before deny |
| **Stale rules** | Outdated access persists | Old project rules |
| **No logging** | No visibility into blocks | Can't detect attacks |

**Dangerous patterns:**

```
DANGEROUS RULES:

1. ANY-ANY-ALLOW
   Allow Any → Any : Any
   ↓
   No firewall protection at all

2. OUTBOUND UNRESTRICTED
   Allow Internal → Any : Any
   ↓
   Malware can reach C2 servers
   Data can be exfiltrated

3. MANAGEMENT WIDE OPEN
   Allow Any → Firewall : 22
   ↓
   Attackers can brute force admin access

4. OVERLY PERMISSIVE SEGMENT ACCESS
   Allow DMZ → Internal : Any
   ↓
   Compromised web server → full internal access
```

### Stateful Inspection Deep Dive

**Connection tracking:**

```
STATEFUL INSPECTION MECHANICS:

OUTBOUND TCP CONNECTION:
───────────────────────────────────────
1. Client → SYN → Server:80
   Firewall: Creates state table entry
   ┌─────────────────────────────────────────────────┐
   │ State: NEW                                      │
   │ Src: 192.168.1.50:54321                        │
   │ Dst: 10.0.0.100:80                             │
   │ Protocol: TCP                                  │
   │ Timeout: 60 seconds                            │
   └─────────────────────────────────────────────────┘

2. Server → SYN-ACK → Client
   Firewall: Updates state to ESTABLISHED
   
3. Client → ACK → Server
   Firewall: Connection established, normal traffic flows

4. FIN/RST or timeout
   Firewall: Removes state table entry

SECURITY BENEFIT:
- Only return traffic for established connections allowed
- Random inbound packets rejected (no matching state)
- Prevents many scanning/attack techniques
```

### Egress Filtering

**Controlling outbound traffic:**

```
EGRESS FILTERING IMPORTANCE:

WITHOUT EGRESS FILTERING:
───────────────────────────────────────
Malware installed → Connects to internet C2 → SUCCESS
                   └── Any port, any destination

WITH EGRESS FILTERING:
───────────────────────────────────────
Malware installed → Tries to connect C2
                   └── Blocked! Server can only reach:
                       - Patch servers
                       - NTP
                       - DNS (internal only)
                       - Specific business destinations

EGRESS BEST PRACTICES:
───────────────────────────────────────
1. Default deny outbound
2. Whitelist necessary destinations
3. Force DNS through internal servers
4. Proxy web traffic for inspection
5. Alert on blocked outbound attempts
```

### Firewall Logging

**What to log:**

```
FIREWALL LOGGING STRATEGY:

LOG EVERYTHING (NOISY):
- Generates massive volume
- Expensive storage
- Hard to find signal

LOG NOTHING (BLIND):
- No visibility
- Can't investigate
- Can't detect attacks

BALANCED APPROACH:
───────────────────────────────────────
1. ALWAYS LOG:
   - Denied traffic (attack indicators)
   - Admin access (audit trail)
   - New connections to critical systems
   - Traffic to/from IOCs

2. SAMPLE LOG:
   - High-volume permitted traffic
   - Known-good patterns

3. NEVER LOG:
   - Debug/verbose (usually)
   - Heartbeat traffic
   - Already logged elsewhere

LOG EXAMPLE:
Date: 2024-01-15 08:30:45
Action: DENY
Src: 203.0.113.50:54321
Dst: 192.168.1.10:22
Proto: TCP
Rule: "Block SSH from Internet"
```

---

## 3. Guided Practice

### Exercise 1: Rule Writing

Write rules for a web server:
- Allow HTTP/HTTPS from anywhere
- Allow SSH from admin network (10.0.0.0/24) only
- Allow database connection to db.internal (port 3306)
- Deny everything else

| # | Source | Destination | Port | Action |
|---|--------|-------------|------|--------|
| 1 | ___ | ___ | ___ | ___ |
| 2 | ___ | ___ | ___ | ___ |
| 3 | ___ | ___ | ___ | ___ |
| 4 | ___ | ___ | ___ | ___ |

### Exercise 2: Rule Audit

Find issues in this ruleset:

| # | Source | Destination | Port | Action |
|---|--------|-------------|------|--------|
| 1 | Any | 192.168.1.10 | Any | Allow |
| 2 | 10.0.0.0/24 | 192.168.1.10 | 22 | Allow |
| 3 | BadIP | 192.168.1.10 | Any | Deny |

Issues:
1. ___
2. ___

### Exercise 3: Egress Design

Design egress rules for a corporate network:

| # | Source Zone | Destination | Port | Action | Reason |
|---|-------------|-------------|------|--------|--------|
| 1 | ___ | ___ | ___ | ___ | ___ |
| 2 | ___ | ___ | ___ | ___ | ___ |
| 3 | ___ | ___ | ___ | ___ | ___ |

---

## 4. Reflection Check

### Technical Understanding
1. Stateless firewall sees return packet SYN-ACK. What happens?

2. Rule 1 allows port 443. Rule 2 denies malware domain. Both match. What happens?

3. NGFW inspects SSL. What privacy concerns exist?

### Operational Thinking
1. User requests temporary "allow all" for testing. How do you respond?

2. You find 500 rules, many undocumented. What's your approach?

3. Firewall blocks legitimate traffic. Quick fix vs proper fix?

---

## 5. Key Misconceptions

**MYTH: "Application runs on port 443, so allow 443"**
REALITY: Anyone can use any port. NGFW inspects actual application, not just port.

**MYTH: "Firewall blocks attacks automatically"**
REALITY: Firewall enforces YOUR rules. Bad rules = bad protection.

**MYTH: "More rules = more secure"**
REALITY: More rules = more complexity = more mistakes. Simplicity is security.

**MYTH: "Permit rules are the security"**
REALITY: The implicit DENY and specific DENYs do the blocking. Permits create holes.

**MYTH: "Egress doesn't matter, we control internal systems"**
REALITY: Compromised internal systems need to reach attackers. Egress filtering stops this.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Explain** stateless vs stateful vs NGFW capabilities
2. **Write** firewall rules using 5-tuple format
3. **Identify** common misconfigurations
4. **Apply** proper rule ordering
5. **Design** egress filtering strategy

---

## 7. Further Depth (Optional)

*   **Practice:** Configure iptables/nftables on Linux
*   **Lab:** Set up pfSense or OPNsense firewall
*   **Research:** NGFW vendor documentation (Palo Alto, Fortinet)
*   **Tools:** Firewall rule analyzers for audit
