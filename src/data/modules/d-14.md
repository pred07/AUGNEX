# Log Retention and Integrity

## 1. Orientation

### What this module covers
This module covers the lifecycle of logs—how long to keep them, how to ensure they weren't tampered with, and how to balance operational needs with compliance requirements and cost.

### Fit in the Learning Path
The average time to detect a breach is 200+ days. If you only keep 30 days of logs, you lose visibility into the initial compromise. Proper retention is essential for investigation and legal defensibility.

### Learning Objectives
By the end of this module, you will:
*   Design retention policies based on requirements
*   Implement log integrity mechanisms
*   Recognize tampering indicators
*   Balance cost, compliance, and operational needs

---

## 2. Core Content

### Mental Model: Logs as Legal Evidence

**How professionals think about this:**
Logs are not just operational data—they're potential legal evidence. The same principles that apply to physical evidence (chain of custody, integrity) apply to log data. Treat your logging infrastructure as evidence preservation.

```
LOG LIFECYCLE:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  GENERATION                      COLLECTION                        │
│  ──────────                      ──────────                        │
│  Event occurs on endpoint  →  Agent ships to central location      │
│                                                                     │
│  INTEGRITY CONCERN:             INTEGRITY CONCERN:                 │
│  Can attacker delete before     Can attacker intercept            │
│  collection?                    and modify in transit?            │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  STORAGE                         ARCHIVAL                          │
│  ───────                         ────────                          │
│  Indexed for search         →   Long-term preservation            │
│  (Hot storage)                   (Cold storage)                    │
│                                                                     │
│  INTEGRITY CONCERN:             INTEGRITY CONCERN:                 │
│  Can admin modify once           Can data be corrupted            │
│  stored?                         or deleted?                       │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  RETRIEVAL                      DISPOSAL                           │
│  ─────────                      ────────                           │
│  Retrieved for investigation → Secure deletion after retention    │
│                                                                     │
│  INTEGRITY CONCERN:             INTEGRITY CONCERN:                 │
│  Chain of custody for           Proper destruction                │
│  legal proceedings              of sensitive data                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Retention Policy Design

**Tiered retention approach:**

```
STORAGE TIERS:

HOT (0-30 days)
─────────────────────────────
Storage: Fast SSD/NVMe
Access: Immediate, interactive search
Cost: $$$$$ per GB
Use: Active investigation, real-time alerting

WARM (30-90 days)
─────────────────────────────
Storage: Standard HDD/SAN
Access: Minutes to hours
Cost: $$$ per GB
Use: Recent investigations, trend analysis

COLD (90-365 days)
─────────────────────────────
Storage: Object storage (S3, Azure Blob)
Access: Hours to retrieve
Cost: $ per GB
Use: Compliance, historical reference

ARCHIVE (1-7+ years)
─────────────────────────────
Storage: Glacier, tape
Access: Days to retrieve
Cost: ¢ per GB
Use: Legal hold, regulatory compliance
```

**Retention requirements by regulation:**

| Regulation | Required Retention | Log Types |
|------------|-------------------|-----------|
| **PCI-DSS** | 1 year available, 3 months online | Audit trails, access logs |
| **HIPAA** | 6 years | Access to PHI, security events |
| **SOX** | 7 years | Financial system access |
| **GDPR** | "No longer than necessary" | Varies (minimize) |
| **FedRAMP** | 1 year online, 3 years total | All security-relevant |
| **NIST 800-53** | Organization-defined | Security audit logs |

### Log Integrity Mechanisms

**Preventing tampering:**

```
INTEGRITY CONTROLS:

1. WRITE-ONCE READ-MANY (WORM)
   ─────────────────────────────
   Storage that cannot be modified or deleted
   until retention period expires
   
   Implementation:
   - S3 Object Lock
   - Azure Immutable Blob Storage
   - NetApp SnapLock
   - Dedicated WORM appliances
   
   Protection: Admin cannot delete evidence

2. CRYPTOGRAPHIC HASHING
   ─────────────────────────────
   Hash each log block/batch
   Store hashes separately
   Any modification breaks the hash
   
   Implementation:
   - Log shipping with signed checksums
   - Merkle trees (blockchain-style)
   - GPG-signed log files
   
   Protection: Detect any modification

3. DUAL CONTROL
   ─────────────────────────────
   Require two admins to modify/delete
   Split responsibilities
   
   Implementation:
   - Separate logging admin from system admin
   - Different credentials for log storage
   
   Protection: Prevent single actor tampering

4. OFF-SITE REPLICATION
   ─────────────────────────────
   Real-time copy to separate location
   Different administrative domain
   
   Implementation:
   - SIEM in separate cloud account
   - Third-party log aggregator
   
   Protection: If primary compromised, copy survives
```

### Detecting Log Tampering

**Indicators of manipulation:**

```
TAMPERING INDICATORS:

1. TIME GAPS
   ─────────────────────────────
   Jan 1-10: Logs present
   Jan 11-14: NO LOGS
   Jan 15: Logs resume
   
   Investigation:
   - Was system down? (Check other systems)
   - Was collection failing? (Check agent status)
   - Were logs deleted? (Check for clearing events)
   
   Windows: Event ID 1102 (Log cleared)
   Linux: Check for truncated files, missing rotation

2. SEQUENCE BREAKS
   ─────────────────────────────
   Event IDs: 100, 101, 102, [GAP], 150, 151
   
   Events 103-149 either:
   - Never occurred (unlikely)
   - Were deleted (likely)

3. TIMESTAMP ANOMALIES
   ─────────────────────────────
   Events out of chronological order
   Timestamps from future
   Sudden time zone changes
   
   Indicates: Reconstructed or modified logs

4. METADATA MISMATCH
   ─────────────────────────────
   File modified date ≠ Log entry dates
   File size inconsistent with entry count
   Hash doesn't match prior record
   
   Indicates: Post-hoc modification

5. LOG CLEARING EVENTS
   ─────────────────────────────
   Windows: 1102, 104
   Linux: auth.log cleared
   
   Legitimate: Rare, documented
   Suspicious: During incident timeframe
```

### Chain of Custody

**Maintaining log admissibility:**

```
CHAIN OF CUSTODY FOR LOGS:

1. COLLECTION
   ─────────────────────────────
   Document:
   - When collected
   - From which system
   - By which process
   - Hash at collection time

2. STORAGE
   ─────────────────────────────
   Document:
   - Where stored
   - Who has access
   - Hash on arrival
   - Access logs for storage

3. ANALYSIS
   ─────────────────────────────
   Document:
   - Who accessed
   - When accessed
   - What queries run
   - Work on copies, not originals

4. PRESENTATION
   ─────────────────────────────
   Document:
   - Hash matches original
   - No modifications occurred
   - Complete chain from source to court
```

### Cost Optimization

**Balancing retention with budget:**

```
COST OPTIMIZATION STRATEGIES:

1. FILTER AT SOURCE
   ─────────────────────────────
   Don't collect debug logs
   Drop known-noise events
   Aggregate before shipping
   
   Savings: 50-80% log volume

2. TIERED RETENTION
   ─────────────────────────────
   Security logs: 1 year hot, 6 years cold
   Application logs: 30 days hot, 90 days cold
   Debug logs: 7 days, no archive
   
   Savings: 60-70% storage cost

3. COMPRESSION
   ─────────────────────────────
   Logs compress well (90%+ compression)
   Compress before cold storage
   
   Savings: 5-10x storage for cold tier

4. SMART ARCHIVAL
   ─────────────────────────────
   Keep metadata hot, raw logs cold
   Summarize/aggregate for long-term
   Full logs only when needed
   
   Example: Keep "user logged in" summary,
            archive full event details
```

### Privacy Considerations

**GDPR and log retention:**

```
PRIVACY VS SECURITY TENSION:

GDPR REQUIRES:
- Data minimization (don't over-collect)
- Storage limitation (don't over-retain)
- Right to erasure (delete on request)

SECURITY REQUIRES:
- Comprehensive logging (collect everything)
- Long retention (keep for investigation)
- Immutable storage (can't delete)

RESOLUTION APPROACHES:
─────────────────────────────
1. PSEUDONYMIZATION
   Store user_id instead of email
   Mapping table can be erased
   
2. LEGAL BASIS DOCUMENTATION
   Security logging = legitimate interest
   Document the justification
   
3. SEPARATE RETENTION
   User data: Short retention, deletable
   Security events: Long retention, anonymized
   
4. LEGAL REVIEW
   Consult counsel on specific requirements
   Document retention decisions
```

---

## 3. Guided Practice

### Exercise 1: Retention Policy Design

Design retention for a healthcare company:

| Log Type | Hot | Warm | Cold | Total | Justification |
|----------|-----|------|------|-------|---------------|
| Auth logs | ___ | ___ | ___ | ___ | ___ |
| App logs | ___ | ___ | ___ | ___ | ___ |
| Debug logs | ___ | ___ | ___ | ___ | ___ |
| Database audit | ___ | ___ | ___ | ___ | ___ |

### Exercise 2: Tampering Analysis

You're investigating a server. You notice:
- /var/log/auth.log was truncated 3 days ago
- /var/log/syslog has a 4-hour gap
- File modification times are after the events inside

1. What do you suspect? ___
2. What other evidence would you check? ___
3. How would you preserve current state? ___

### Exercise 3: Integrity Design

Design integrity controls for a logging system:

| Stage | Control | Implementation |
|-------|---------|----------------|
| Collection | ___ | ___ |
| Transport | ___ | ___ |
| Storage | ___ | ___ |
| Archival | ___ | ___ |

---

## 4. Reflection Check

### Retention Understanding
1. Average breach detection is 200+ days. Logs kept for 30 days. Problem?

2. GDPR says "delete user data." Security logs contain usernames. What do you do?

3. Storage costs are high. Finance wants 7-day retention. How do you respond?

### Integrity Understanding
1. An attacker gets root. They clear logs. What survived?

2. You hash logs daily. Attacker modifies a log at 3 AM, you hash at 6 AM. Problem?

3. Admin accidentally deletes logs. How is this different from attacker deleting logs?

---

## 5. Key Misconceptions

**MYTH: "More retention is always better"**
REALITY: Long retention has costs (storage, privacy, discovery). Match retention to requirements.

**MYTH: "Logs in the SIEM are tamper-proof"**
REALITY: SIEM admins can modify data. Additional controls (WORM, separation) needed.

**MYTH: "Backups protect log integrity"**
REALITY: Backups can also be modified. Immutable storage and hashing provide integrity.

**MYTH: "Log gaps always mean attacker tampering"**
REALITY: Collection failures, system reboots, and misconfigurations also cause gaps. Investigate before concluding.

**MYTH: "Archive equals backup"**
REALITY: Archives are for search/evidence (immutable). Backups are for restore (overwritable).

---

## 6. Completion Criteria

This module is complete when you can:

1. **Design** tiered retention policies per requirements
2. **Implement** integrity controls (WORM, hashing)
3. **Detect** indicators of log tampering
4. **Maintain** chain of custody for evidentiary use
5. **Balance** retention with cost and privacy

---

## 7. Further Depth (Optional)

*   **Practice:** Configure S3 Object Lock or Azure Immutable Storage
*   **Research:** NIST SP 800-92 Guide to Log Management
*   **Legal:** Understand e-discovery and log admissibility
*   **Architecture:** Design air-gapped log storage
