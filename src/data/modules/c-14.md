# Validating Network Visibility

## 1. Orientation

### What this module covers
This module covers validating your network visibility—the ability to see traffic flows, DNS queries, and network connections. Network telemetry is often the most durable evidence because packets must traverse the wire.

### Fit in the Learning Path
Attackers can delete files, flush memory, and clear local logs, but network traffic leaves traces across multiple systems. Network visibility provides detection opportunities even when endpoint visibility fails.

### Learning Objectives
By the end of this module, you will:
*   Validate visibility across network planes (DNS, Flow, Proxy)
*   Detect common network-based attacks (beaconing, tunneling, exfiltration)
*   Identify North-South vs East-West visibility gaps
*   Test network visibility through purple teaming

---

## 2. Core Content

### Mental Model: The Three Network Planes

**How professionals think about this:**
Network visibility operates on three complementary planes. Each reveals different attack indicators. Complete visibility requires coverage across all three.

```
THE THREE NETWORK VISIBILITY PLANES:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  PLANE 1: DNS                                                       │
│  ─────────────────────────────                                     │
│  What domains are being queried?                                   │
│  The "phonebook" of the internet                                   │
│                                                                     │
│  Reveals:                                                          │
│  - Malicious domain lookups                                        │
│  - DNS tunneling                                                   │
│  - DGA (Domain Generation Algorithm)                               │
│  - C2 infrastructure                                               │
│                                                                     │
│  PLANE 2: FLOW (NetFlow/IPFIX)                                     │
│  ─────────────────────────────                                     │
│  Who talks to whom and how much?                                   │
│  Connection metadata without content                               │
│                                                                     │
│  Reveals:                                                          │
│  - Beaconing patterns                                              │
│  - Data exfiltration volumes                                       │
│  - Lateral movement                                                │
│  - Unusual connection patterns                                     │
│                                                                     │
│  PLANE 3: CONTENT (Proxy/DPI)                                      │
│  ─────────────────────────────                                     │
│  What is actually being transferred?                               │
│  Full packet inspection                                            │
│                                                                     │
│  Reveals:                                                          │
│  - Malware downloads                                               │
│  - Exploit kit traffic                                             │
│  - Specific URLs accessed                                          │
│  - File content analysis                                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### North-South vs East-West

**Understanding visibility topology:**

```
TRAFFIC DIRECTION:

NORTH-SOUTH (External Traffic)
─────────────────────────────
Internet ↔ Internal Network

Where: Perimeter firewall, proxy, IDS
Visibility: Usually good (chokepoint)

Catches:
- External C2 communication
- Malware downloads
- Data exfiltration to internet

                    INTERNET
                        │
                        │ (North-South visibility here)
                        ▼
              ┌─────────────────┐
              │    FIREWALL     │
              │    PROXY        │
              │    IDS          │
              └─────────────────┘
                        │
              ┌─────────┴─────────┐
              │                   │
         [Subnet A]         [Subnet B]
              │                   │
              └───────────────────┘
                        │
                        │ (East-West visibility here?)
                        
EAST-WEST (Internal Traffic)
─────────────────────────────
Internal ↔ Internal

Where: Core switch (NetFlow), internal firewall, NDR
Visibility: Often POOR (no chokepoint)

Misses if not monitored:
- Lateral movement (RDP, SMB)
- Internal reconnaissance
- Attacker pivoting
- Pass-the-hash/ticket

GAP: Most organizations have good North-South,
     poor East-West visibility
```

### DNS Monitoring

**The critical visibility plane:**

```
DNS VISIBILITY:

WHY DNS IS CRITICAL:
─────────────────────────────
- Almost all attacks require DNS
- C2 must resolve to IP
- Even file-only attacks phone home
- Hard to block without breaking things
- Attackers love it

WHAT TO CAPTURE:
─────────────────────────────
Source IP        Who made the query
Query            What domain was asked
Response         What answer was given
Timestamp        When it happened
Query Type       A, AAAA, TXT, MX, etc.

WHERE TO GET DNS LOGS:
─────────────────────────────
1. Internal DNS servers (Windows DNS, BIND)
2. DNS forwarders (Pi-hole, Infoblox)
3. Firewall DNS inspection
4. Endpoint (Sysmon Event 22)
5. Passive DNS collection

KEY DETECTIONS:
─────────────────────────────
1. Known-bad domains (threat intel)
2. DGA patterns (random-looking domains)
3. High query volume to single domain (tunneling)
4. Long subdomain names (data exfiltration)
5. Rare domain queries (only this host queries it)
6. TXT record queries (often used for C2)
```

### DNS-Based Attacks

**What to detect:**

```
DNS ATTACK PATTERNS:

1. DNS TUNNELING
   ─────────────────────────────
   Data exfiltrated in DNS queries/responses
   
   Pattern:
   - Long subdomain names: abc123xyz.tunnel.evil.com
   - High volume of queries
   - TXT record abuse
   
   Detection:
   - Subdomain length > 20 chars
   - TXT queries to non-authoritative domains
   - Query entropy analysis

2. DGA (Domain Generation Algorithm)
   ─────────────────────────────
   Malware generates random domains for C2
   
   Pattern:
   - Random-looking domains: xhf7k2js9.com
   - Many NX (not found) responses
   - Same host tries many random domains
   
   Detection:
   - Domain name entropy
   - High NX response rate
   - Unusual TLD patterns

3. FAST FLUX
   ─────────────────────────────
   C2 domain resolves to many IPs rapidly
   
   Pattern:
   - Same domain returns different IPs
   - Very short TTL
   - IPs in different countries/ASNs
   
   Detection:
   - TTL analysis
   - Resolution change frequency

4. DOMAIN FRONTING
   ─────────────────────────────
   Hide C2 behind legitimate CDN domain
   
   Pattern:
   - DNS to legitimate domain (cloudfront.net)
   - SNI shows legitimate domain
   - HTTP Host header is actual C2
   
   Detection:
   - Host header vs SNI mismatch
   - Unusual patterns to CDN domains
```

### NetFlow/Flow Data

**Connection metadata analysis:**

```
NETFLOW VISIBILITY:

WHAT NETFLOW CAPTURES:
─────────────────────────────
Source IP          Who initiated
Destination IP     Who received
Source Port        Client port
Destination Port   Server port
Protocol           TCP/UDP/ICMP
Bytes              How much data
Packets            How many packets
Timestamp          When
Duration           How long

NETFLOW DETECTIONS:

1. BEACONING
   ─────────────────────────────
   C2 checking in regularly
   
   Pattern:
   - Regular intervals (every 60 seconds)
   - Same destination
   - Small, similar-sized packets
   - Continues for hours/days
   
   Detection:
   - Time series analysis
   - Jitter analysis
   - Connection frequency

2. DATA EXFILTRATION
   ─────────────────────────────
   Large data transfers out
   
   Pattern:
   - Large bytes out (unusual ratio)
   - To unusual destinations
   - After hours
   - Compressed (smaller than expected)
   
   Detection:
   - Bytes out > normal threshold
   - New destination for high volume
   - Time-based analysis

3. PORT SCANNING
   ─────────────────────────────
   Reconnaissance activity
   
   Pattern:
   - Single source, many destinations
   - Many connection attempts
   - Low success rate
   
   Detection:
   - Unique dest port count per source
   - Failed connection ratio

4. LATERAL MOVEMENT
   ─────────────────────────────
   Attacker moving through network
   
   Pattern:
   - Internal to internal
   - RDP (3389), SMB (445), WinRM (5985)
   - New connection patterns
   
   Detection:
   - First-seen analysis
   - Service account anomalies
```

### Proxy and Content Inspection

**What's inside the traffic:**

```
PROXY/CONTENT VISIBILITY:

WEB PROXY LOGS:
─────────────────────────────
Full URL           Exact page accessed
User Agent         Browser/tool making request
Referrer           Where they came from
Content Type       What was downloaded
File Hash          Hash of downloaded file
Category           URL categorization
Action             Allowed/blocked

KEY PROXY DETECTIONS:
─────────────────────────────
1. Uncategorized domains (new C2)
2. Malicious file downloads
3. Unusual user agents (curl, powershell)
4. Large downloads to unusual destinations
5. POST to pastebin (exfiltration)

TLS/SSL INSPECTION:
─────────────────────────────
Challenge: 90%+ traffic is encrypted
           Without inspection, content is invisible

Options:
1. TLS inspection (decrypt, inspect, re-encrypt)
   Pros: See all content
   Cons: Privacy, performance, certificate management

2. Endpoint visibility (see before encryption)
   Pros: No network decryption needed
   Cons: Requires endpoint agent

3. Metadata analysis (no decryption)
   Pros: Privacy preserved
   Cons: Limited detection capability

RECOMMENDATION:
- TLS inspection for high-risk categories
- Endpoint visibility for supplement
- Threat intel for known-bad without inspection
```

### Purple Team Network Validation

**Testing network visibility:**

```
PURPLE TEAM NETWORK VALIDATION:

TEST 1: DNS VISIBILITY
─────────────────────────────
Action: nslookup purple-test.example.com
Check: Does DNS query appear in logs?
       Is source IP correct?
       Is timestamp accurate?

TEST 2: DNS TUNNELING DETECTION
─────────────────────────────
Action: Use dnscat or iodine for DNS tunnel
Check: Does tunnel detection alert?
       Is subdomain length detected?
       Is TXT abuse detected?

TEST 3: BEACONING DETECTION
─────────────────────────────
Action: Create HTTP callback every 60 seconds
Check: Does beaconing detection find it?
       What's minimum interval to detect?

TEST 4: EAST-WEST VISIBILITY
─────────────────────────────
Action: RDP from workstation to workstation
Check: Does internal connection log?
       Is it visible in SIEM?
       Would you detect lateral movement?

TEST 5: EXFILTRATION DETECTION
─────────────────────────────
Action: Upload large file to cloud storage
Check: Does DLP/proxy detect?
       Is volume anomaly detected?

TEST 6: ENCRYPTED VISIBILITY
─────────────────────────────
Action: Access HTTPS site
Check: If TLS inspection: Is content visible?
       If no inspection: Is metadata useful?
```

---

## 3. Guided Practice

### Exercise 1: Network Visibility Audit

For your environment:

| Visibility Plane | Source | Collected | In SIEM | Detection Rules |
|-----------------|--------|-----------|---------|-----------------|
| DNS | ___ | ___ | ___ | ___ |
| NetFlow (N-S) | ___ | ___ | ___ | ___ |
| NetFlow (E-W) | ___ | ___ | ___ | ___ |
| Proxy | ___ | ___ | ___ | ___ |

### Exercise 2: Detection Design

Design beaconing detection:

Data source: ___
Pattern to detect: ___
Threshold: ___
Time window: ___
False positive mitigation: ___

### Exercise 3: East-West Gap Assessment

Lateral movement scenario:
Attacker RDPs from Workstation A to Workstation B

Would you detect it? ___
What visibility do you have? ___
What visibility is missing? ___

---

## 4. Reflection Check

### Network Understanding
1. DNS tunneling detected. Next investigation step?

2. Have North-South visibility but not East-West. Impact?

3. 90% of traffic encrypted. Network IDS ineffective?

### Strategic Thinking
1. Can only implement one: DNS logging or NetFlow. Which?

2. TLS inspection has legal concerns. Alternative?

3. Internal network is flat. Impact on visibility?

---

## 5. Key Misconceptions

**MYTH: "Firewall logs are sufficient for network visibility"**
REALITY: Firewall sees allow/deny. DNS, content, and internal flows may be missing.

**MYTH: "Encrypted traffic means we're blind"**
REALITY: Metadata (timing, volume, destinations) reveals much without decryption.

**MYTH: "Network visibility catches everything"**
REALITY: Memory-only attacks with no network callback evade network detection.

**MYTH: "DNS over HTTPS blinds us completely"**
REALITY: Endpoint logging sees DNS before encryption. Also can block DoH.

**MYTH: "We log DNS at the firewall"**
REALITY: Firewall DNS logs may lack detail. Dedicated DNS logging preferred.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Validate** DNS logging and alerting
2. **Assess** North-South vs East-West coverage
3. **Detect** beaconing and DNS tunneling patterns
4. **Identify** network visibility gaps
5. **Test** network visibility through purple teaming

---

## 7. Further Depth (Optional)

*   **Tool:** RITA for network threat hunting
*   **Tool:** Zeek for network security monitoring
*   **Practice:** DNS tunnel detection lab
*   **Resource:** SANS Network Forensics course
