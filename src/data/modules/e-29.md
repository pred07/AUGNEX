# Business Logic Vulnerabilities

## 1. Orientation

### What this module covers
This module covers business logic vulnerabilities—flaws in application workflows, rules, and assumptions that allow attackers to abuse legitimate functionality for unintended purposes. These are the bugs that scanners can't find.

### Fit in the Learning Path
Business logic flaws require understanding the application's purpose and workflow. They're often high-impact, low-detection vulnerabilities. Mastering this class separates script kiddies from professional security researchers.

### Learning Objectives
By the end of this module, you will:
*   Identify business logic attack surfaces
*   Test workflow assumptions
*   Exploit pricing and quantity manipulation
*   Abuse trust boundaries

---

## 2. Core Content

### Mental Model: Playing by Different Rules

**How professionals think about this:**
The application has rules it expects users to follow. Business logic attacks exploit the gap between what the application EXPECTS and what it ENFORCES. You're not breaking the code—you're breaking the assumptions.

```
BUSINESS LOGIC CONCEPT:

EXPECTED WORKFLOW:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  1. Add to cart ──► 2. Enter shipping ──► 3. Pay ──► 4. Confirm   │
│                                                                     │
│  Rules (EXPECTED):                                                 │
│  - Must complete each step in order                                │
│  - Payment required before confirmation                            │
│  - Can't modify cart after payment                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

ACTUAL ENFORCEMENT:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  APPLICATION ONLY CHECKS:                                          │
│  - Valid session exists                                            │
│  - Cart has items                                                  │
│                                                                     │
│  APPLICATION DOESN'T CHECK:                                        │
│  - That you actually paid                                          │
│  - That you went through the workflow                              │
│  - That prices haven't been tampered                               │
│                                                                     │
│  ATTACK: Skip step 3 (payment), go directly to step 4              │
│  RESULT: Free merchandise                                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Categories of Logic Flaws

**Common business logic vulnerabilities:**

```
BUSINESS LOGIC FLAW CATEGORIES:

1. WORKFLOW BYPASS
   ─────────────────────────────
   Skip steps in multi-step processes
   Access later stages directly
   Complete transactions without requirements
   
   Example: Skip payment step
            Skip verification step
            Skip CAPTCHA step

2. TRUST BOUNDARIES
   ─────────────────────────────
   Server trusts client-side data
   Internal APIs trust any caller
   Deprecated endpoints remain accessible
   
   Example: Trust price from hidden field
            Trust user role from cookie
            Trust quantity from form

3. RACE CONDITIONS
   ─────────────────────────────
   Timing windows allow double actions
   State changes between check and action
   Concurrent requests exploit delays
   
   Example: Double-spend coupons
            Simultaneous withdrawals
            TOCTOU (Time of Check vs Time of Use)

4. LIMITS AND CONSTRAINTS
   ─────────────────────────────
   Maximum/minimum not enforced
   Rate limits bypassable
   Quantity restrictions client-side
   
   Example: Negative quantity = credit
            Exceed purchase limits
            Bypass rate limiting

5. PRICING MANIPULATION
   ─────────────────────────────
   Prices modifiable by user
   Currency confusion
   Discount stacking
   
   Example: Coupon reuse
            Price in POST body
            Currency switching exploit
```

### Workflow Attacks

**Bypassing multi-step processes:**

```
WORKFLOW ATTACK EXAMPLES:

E-COMMERCE CHECKOUT:
─────────────────────────────
Normal: Cart → Shipping → Payment → Confirm
Attack: Cart → Confirm (skip payment)

Test: After adding items, directly POST to /confirm
      Does it create the order without payment?

PASSWORD RESET:
─────────────────────────────
Normal: Enter email → Get code → Enter code → New password
Attack: Guess the final URL pattern

Test: Can you access /reset/new-password directly?
      Is the token validated on final step?

REGISTRATION:
─────────────────────────────
Normal: Enter info → Verify email → Complete profile
Attack: Skip email verification

Test: Can you access app features before verifying?
      Does verification check persist?

KYC/VERIFICATION:
─────────────────────────────
Normal: Upload ID → Wait for review → Approved
Attack: Access features before approval

Test: Change verification status client-side
      Access restricted features during "pending"
```

### Price and Quantity Manipulation

**Exploiting financial logic:**

```
PRICING ATTACKS:

1. HIDDEN FIELD MANIPULATION
   ─────────────────────────────
   <input type="hidden" name="price" value="100">
   
   Attack: Change to value="0" or value="-100"
   
   Always verify prices server-side!

2. RACE CONDITION COUPONS
   ─────────────────────────────
   Coupon: 50% off, single use
   
   Attack: 
   Thread 1: Apply coupon
   Thread 2: Apply coupon (simultaneously)
   
   Both succeed before "used" flag is set

3. CURRENCY MANIPULATION
   ─────────────────────────────
   Normal: price=100&currency=USD
   Attack: price=100&currency=JPY
   
   If conversion doesn't update price correctly:
   Pay 100 JPY (~$0.70) for $100 item

4. NEGATIVE QUANTITY
   ─────────────────────────────
   Normal: quantity=2 (total $200)
   Attack: quantity=-2 (total -$200)
   
   Some systems credit your account!

5. INTEGER OVERFLOW
   ─────────────────────────────
   quantity=2147483647 + 1 = -2147483648
   
   Large positive → becomes negative
   Results in credit or free items

6. DISCOUNT STACKING
   ─────────────────────────────
   Apply employee discount (20%)
   Apply loyalty discount (10%)
   Apply promotional code (15%)
   Apply referral credit ($20)
   
   Combined: More than 100% off
```

### Trust Boundary Violations

**Trusting the wrong data:**

```
TRUST VIOLATIONS:

1. TRUSTING CLIENT DATA
   ─────────────────────────────
   Cookie: role=user
   Attack: role=admin
   
   localStorage: {"tier": "free"}
   Attack: {"tier": "enterprise"}
   
   Server must verify, not trust

2. API KEY IN FRONTEND
   ─────────────────────────────
   JavaScript: API_KEY = "secret123"
   
   User can:
   - Use key directly
   - Bypass frontend restrictions
   - Access API without UI limitations

3. CLIENT-SIDE VALIDATION ONLY
   ─────────────────────────────
   JavaScript: if (quantity > 10) alert("Max 10")
   
   Attack: Modify request directly, bypass JS
   
   Server has no validation → accepts quantity=1000

4. DIRECT OBJECT REFERENCE
   ─────────────────────────────
   View your order: /order/12345
   View other orders: /order/12346, /order/12347
   
   No verification that you own order 12346
```

### Race Conditions

**Time-of-check vs time-of-use:**

```
RACE CONDITION ATTACKS:

CONCEPT:
─────────────────────────────
Check: Does user have funds? Yes
Use:   Deduct funds
       (Another request uses same funds)

Between CHECK and USE, state can change

EXPLOITATION:

1. MULTI-THREADING
   for i in {1..10}; do
     curl -X POST /transfer?amount=100 &
   done
   
   10 simultaneous requests
   Some may succeed before balance updates

2. COUPON RACE
   Burp Intruder: 100 parallel requests
   All apply same coupon code
   Some succeed before "used" flag

3. VOTE MANIPULATION
   Vote once per user? 
   Send 100 simultaneous votes
   Counter increments multiple times

TESTING:
─────────────────────────────
1. Identify state-changing operations
2. Send multiple concurrent requests
3. Check if action happened multiple times
4. Use Burp Turbo Intruder for precise timing
```

### Testing Methodology

**Systematic logic testing:**

```
BUSINESS LOGIC TESTING APPROACH:

1. MAP THE WORKFLOW
   ─────────────────────────────
   Document every step in the process
   Note what each step requires
   Identify what data flows between steps

2. QUESTION EVERY ASSUMPTION
   ─────────────────────────────
   "What if I skip this step?"
   "What if I repeat this step?"
   "What if I do steps out of order?"
   "What if I modify this value?"

3. TEST BOUNDARIES
   ─────────────────────────────
   - Minimum: 0, -1, negative
   - Maximum: max+1, very large numbers
   - Types: String where number expected
   - Empty: null, empty string, missing

4. TEST TIMING
   ─────────────────────────────
   - Simultaneous requests
   - Very slow requests
   - Requests in rapid succession

5. TEST ACCESS
   ─────────────────────────────
   - Access other users' data
   - Access restricted functions
   - Access deprecated endpoints

DOCUMENTATION SOURCES:
─────────────────────────────
- Help pages
- API documentation
- Terms of service
- Marketing materials
(These describe intended behavior)
```

---

## 3. Guided Practice

### Exercise 1: Workflow Analysis

For a banking transfer flow:
1. Login
2. Select accounts
3. Enter amount
4. Confirm with OTP
5. Transfer complete

What would you test?

| Attack | Test Method |
|--------|-------------|
| Skip OTP | ___ |
| Negative amount | ___ |
| Account you don't own | ___ |
| Simultaneous transfers | ___ |

### Exercise 2: Price Manipulation

Checkout form has:
```html
<input type="hidden" name="total" value="150.00">
<input type="hidden" name="currency" value="USD">
<input name="quantity" value="1">
```

List 5 manipulation tests:
1. ___
2. ___
3. ___
4. ___
5. ___

### Exercise 3: Business Rule Bypass

Promotional rule: "First order 50% off, one per customer"

How would you get multiple discounts?
1. ___
2. ___
3. ___

---

## 4. Reflection Check

### Logic Understanding
1. Scanner finds no vulnerabilities. Application secure?

2. Server validates quantity > 0. Integer overflow still possible?

3. "Verified" badge displayed. Does server enforce restrictions?

### Attack Thinking
1. Free trial limits 5 documents. How to bypass?

2. Premium features disabled client-side. Approach?

3. API has rate limit. Workarounds?

---

## 5. Key Misconceptions

**MYTH: "If it works in the UI, the logic is secure"**
REALITY: UI enforces intended workflow. Direct API access may bypass all restrictions.

**MYTH: "Business logic flaws are low impact"**
REALITY: Logic flaws often lead to financial loss, data theft, or privilege escalation.

**MYTH: "You need source code to find logic bugs"**
REALITY: Understanding the business process is often enough. Black box testing works.

**MYTH: "Automated scanners catch logic flaws"**
REALITY: Scanners find technical bugs. Logic flaws require human understanding.

**MYTH: "If it's not in OWASP Top 10, it's not important"**
REALITY: Logic flaws are in OWASP Top 10 as "Broken Access Control" and others.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Identify** business logic attack surfaces
2. **Test** multi-step workflow bypasses
3. **Exploit** pricing and quantity manipulation
4. **Recognize** trust boundary violations
5. **Test** for race conditions

---

## 7. Further Depth (Optional)

*   **Practice:** PortSwigger Business Logic labs
*   **Tool:** Burp Turbo Intruder for race conditions
*   **Methodology:** Study OAuth/SAML flow attacks
*   **Real-world:** Bug bounty write-ups on logic flaws
