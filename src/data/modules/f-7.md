# Snapshots, Rollbacks, and Lab Hygiene

## 1. Orientation

### What this module covers
This module covers the "save game" capability of virtualization—snapshots—and establishes the operational practices that keep your lab functional, secure, and manageable long-term. Snapshots are not just convenient recovery mechanisms; they're essential workflow tools that enable fearless experimentation.

### Fit in the Learning Path
You are about to start breaking things—intentionally. You will corrupt operating systems, trigger malware, and misconfigure services. Snapshots are your safety net, allowing you to undo catastrophic damage instantly. Without this skill, every mistake requires a complete reinstallation.

### Learning Objectives
By the end of this module, you will:
*   Understand how snapshots work technically (copy-on-write)
*   Implement a snapshot strategy that supports safe experimentation
*   Distinguish between snapshots and backups (different tools, different purposes)
*   Apply lab hygiene practices that prevent operational problems

---

## 2. Core Content

### Mental Model: Fearless Experimentation

**How professionals think about this:**
The lab exists to break things. Every experiment should be reversible in seconds. If you're afraid to try something because you might "mess things up," your snapshot strategy is inadequate. The professional approach is: snapshot before, experiment during, evaluate after, restore if needed.

```
PROFESSIONAL WORKFLOW:

┌─────────────┐    ┌───────────────┐    ┌───────────────┐    ┌─────────────┐
│  Snapshot   │───►│   Experiment  │───►│   Evaluate    │───►│  Decision   │
│   "Safe"    │    │  (Break stuff)│    │  (Success?)   │    │             │
└─────────────┘    └───────────────┘    └───────────────┘    └──────┬──────┘
                                                                     │
                         ┌───────────────────────────────────────────┤
                         │                                           │
                         ▼                                           ▼
              ┌─────────────────────┐                   ┌─────────────────────┐
              │ Restore "Safe"      │                   │ New snapshot        │
              │ (Failed experiment) │                   │ (Good changes)      │
              └─────────────────────┘                   └─────────────────────┘
```

### How Snapshots Work Technically

**Copy-on-Write (CoW) mechanism:**
When you take a snapshot, the hypervisor doesn't immediately copy the entire disk. Instead:

1. Current disk state is "frozen" as a reference point
2. New writes go to a separate delta file
3. Reads check both delta and original
4. Only changed blocks consume additional space

**Practical implications:**
- Snapshots are instant (no disk copying)
- Initially consume minimal space
- Space grows as you make changes after the snapshot
- Multiple snapshots create a chain of deltas

```
SNAPSHOT CHAIN:

Base Disk (20GB)
    │
    ├── Snapshot 1: "Fresh Install" (delta: 0MB initially)
    │       │
    │       ├── Snapshot 2: "Tools Installed" (delta: 2GB added)
    │       │       │
    │       │       └── Current State (delta: 500MB added)
    │       │
    │       └── Snapshot 3: "Malware Test" (delta: 100MB added)
    │               │
    │               └── Deleted (experiment failed)
```

### The Golden Rule: Clean Base State

**Always maintain a known-good reference point.**

After initial setup:
1. Install the operating system
2. Run full system updates
3. Install essential tools you always need
4. Configure basic settings (timezone, networking, SSH)
5. Take a snapshot: "Clean Base - [Date]"

This snapshot is your anchor. When experiments fail, you return here.

**Snapshot naming conventions:**

| Name Pattern | Purpose |
|--------------|---------|
| `Clean Base - YYYY-MM-DD` | Post-installation anchor |
| `Pre-[Experiment]` | Safety before risky action |
| `Post-[Milestone]` | After successful major change |
| `Testing-[Feature]` | Temporary for testing |

**Examples:**
- `Clean Base - 2024-01-15`
- `Pre-Malware-Analysis`
- `Post-Docker-Installed`
- `Testing-New-Burp-Config`

### Snapshot Strategy by Use Case

**General Lab Work:**
```
Clean Base
    │
    └── Pre-Todays-Work
            │
            └── Current State
```

Take "Pre-Todays-Work" at session start. Restore if session goes wrong.

**Malware Analysis:**
```
Clean Base
    │
    └── Analysis-Ready (tools installed, isolated network)
            │
            └── Pre-Sample-[hash]
                    │
                    └── Current State (infected)
                            │
                            └── ANALYZE, THEN RESTORE
```

Always restore after analyzing malware. Never accumulate infected states.

**Attack Lab (Attacker VM):**
```
Clean Base
    │
    └── Lab-Ready (tools, wordlists, configs)
            │
            ├── Pre-Engagement-Client-A
            │
            └── Pre-Engagement-Client-B
```

Snapshot before each engagement to maintain separation.

### Snapshots vs Backups

| Aspect | Snapshot | Backup |
|--------|----------|--------|
| **Purpose** | Quick rollback, experimentation | Disaster recovery, archival |
| **Speed** | Instant | Minutes to hours |
| **Storage** | Same disk (delta chains) | Separate storage (full copy) |
| **Portability** | Not portable | Portable to other systems |
| **Long-term use** | Not recommended | Designed for it |
| **Performance** | Degrades with long chains | No impact on VM |

**When to use each:**

- **Snapshot:** "I'm about to try something risky"
- **Backup:** "I want to preserve this VM for months/years"
- **Snapshot:** "Undo that last hour of work"
- **Backup:** "Move this VM to my new computer"

### Snapshot Chains and Performance

**The problem with long chains:**
Each read operation may need to traverse the entire chain to find the correct block. Long chains = slow I/O.

**Best practices:**
- Keep chains short (3-5 snapshots max in active use)
- Periodically "flatten" by cloning to a new base
- Delete experimental branches after evaluation
- Don't keep snapshots you don't need

**Flattening procedure:**
1. Get VM to desired state
2. Clone the entire VM (creates new base disk)
3. Delete original VM and its snapshots
4. Start fresh with new VM

### Lab Hygiene: Operational Practices

**File Management:**
- Don't store important files only in VMs—they're ephemeral
- Use shared folders for persistent data
- Keep tools and wordlists on host, mount into VMs

**Security Separation:**
- Never log into personal accounts in lab VMs
- Assume lab VMs are compromised (because they often are)
- Don't use the same passwords as your real accounts
- Don't connect lab VMs to production networks

**Maintenance Schedule:**
| Frequency | Task |
|-----------|------|
| Each session | Snapshot before risky work |
| Weekly | Update Clean Base (apt update/upgrade) |
| Monthly | Review and clean old snapshots |
| Quarterly | Flatten long chains, verify backup integrity |

**Naming and Documentation:**
- Use consistent snapshot names
- Document what each snapshot contains
- Delete snapshots you no longer need
- Keep a lab journal of what you've tried

### Practical Snapshot Commands

**VirtualBox (GUI):**
- Machine → Take Snapshot
- Machine → Snapshots → [Select] → Restore

**VirtualBox (CLI):**
```bash
# List snapshots
VBoxManage snapshot "VM-Name" list

# Take snapshot
VBoxManage snapshot "VM-Name" take "Snapshot-Name"

# Restore snapshot
VBoxManage snapshot "VM-Name" restore "Snapshot-Name"

# Delete snapshot
VBoxManage snapshot "VM-Name" delete "Snapshot-Name"
```

**VMware Workstation:**
- VM → Snapshot → Take Snapshot
- VM → Snapshot → Snapshot Manager → [Select] → Go To

---

## 3. Guided Practice

### Exercise 1: Destructive Recovery

Intentionally break your VM and recover:

1. Take snapshot named "Pre-Destruction"
2. Run a destructive command:
   ```bash
   sudo rm -rf /var/log
   ```
3. Reboot and observe problems
4. Restore "Pre-Destruction"
5. Verify `/var/log` exists

Record your observations:
- Time to take snapshot: ___
- Time to restore: ___
- Was data fully recovered? ___

### Exercise 2: Snapshot Strategy Design

Design a snapshot strategy for this scenario:

**Your lab:**
- Kali Linux (main attack platform)
- Windows 10 (victim for testing exploits)
- Windows Server 2019 (AD testing)

For each VM, define:

| VM | Base Snapshot Name | When to Snapshot | Max Chain Length |
|----|-------------------|------------------|------------------|
| Kali | ___ | ___ | ___ |
| Windows 10 | ___ | ___ | ___ |
| Windows Server | ___ | ___ | ___ |

### Exercise 3: Snapshot Chain Analysis

Run this command to check your VM's snapshot chain:
```bash
VBoxManage showvminfo "VM-Name" | grep -i snapshot
```

Or in VMware, open Snapshot Manager and observe the tree.

Questions:
1. How many snapshots exist? ___
2. What's the oldest snapshot date? ___
3. Are there any snapshots you should delete? ___

---

## 4. Reflection Check

### Operational Thinking
1. You've been working on your Kali VM for 3 hours without taking a snapshot. A tool breaks your Python installation. What are your options?

2. Your Windows victim VM has a 10-snapshot chain and is noticeably slower. What should you do?

3. You're about to run an "automated setup script" from GitHub. What do you do first?

### Security Thinking
1. Your malware analysis VM has been infected with 10 different samples over the past month (restoring after each). Is the original base snapshot still clean?

2. You made a snapshot of your VM while logged into a banking website. The session cookie is in the snapshot. What are the implications?

3. Why shouldn't you use your real passwords for accounts inside lab VMs?

---

## 5. Key Misconceptions

**MYTH: "Snapshots are backups"**
REALITY: Snapshots are for quick rollback, not disaster recovery. They're stored on the same disk—if the disk fails, you lose everything.

**MYTH: "Snapshots take copies of the entire disk"**
REALITY: Snapshots use copy-on-write. They're instant and initially small, growing as you make changes.

**MYTH: "I can keep unlimited snapshots without impact"**
REALITY: Long snapshot chains degrade performance. Maintain short chains and flatten periodically.

**MYTH: "Restoring a snapshot removes malware"**
REALITY: True for the VM's disk. But if malware exfiltrated data or spread during execution, that damage persists.

**MYTH: "My lab VM is isolated, so hygiene doesn't matter"**
REALITY: Credentials leak, sessions persist, and configurations transfer. Lab hygiene prevents real-world accidents.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Explain** how snapshots work (copy-on-write mechanism)
2. **Take and restore** snapshots confidently
3. **Design** a snapshot strategy for your lab environment
4. **Distinguish** between snapshots and backups
5. **Apply** lab hygiene practices consistently

---

## 7. Further Depth (Optional)

*   **Exploration:** Compare VirtualBox and VMware snapshot management
*   **Advanced:** Automate snapshot creation with scripts (pre-engagement workflow)
*   **Practice:** Set up a scheduled task to remind you of monthly maintenance
*   **Research:** Understand linked clones and full clones in VMware/VirtualBox
