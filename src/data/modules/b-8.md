# Active Directory Secure Design

## 1. Orientation

### What this module covers
Active Directory (AD) is the identity backbone for 90% of enterprises. It is also the #1 target for ransomware operators during lateral movement. This module goes beyond "what is AD" and focuses on **Secure Architecture**â€”specifically the Tier Model, PAW (Privileged Access Workstations), and defenses against Kerberos attacks like Golden/Silver Tickets.

### Learning Objectives
*   Master the **Microsoft Enterprise Access Model (Tier Model)** to stop lateral movement.
*   Implement the **Clean Source Principle** using PAWs.
*   Understand and mitigate **Golden Ticket** and **Kerberoasting** attacks.
*   Configure **GPO Hardening** for Tier separation.

---

## 2. Core Content

### The Tier Model (Stopping Lateral Movement)
The "Flag" implementation of AD allows a Domain Admin to log into a Receptionist's PC. If that PC is compromised, the Domain Admin's hash is harvested (LSASS Dump), and the attacker owns the domain.

**The Solution: Separation of Duties (Tiers)**

| Tier | Definition | Assets | Admins | Restriction |
| :--- | :--- | :--- | :--- | :--- |
| **Tier 0** | Control Plane | DCs, AD Connect, PKI | T0_Admin | **NEVER** log into T1/T2 assets. |
| **Tier 1** | Application Plane | Servers, SQL, Apps | T1_Admin | **NEVER** log into T2 assets. |
| **Tier 2** | User Plane | Workstations, Laptops | T2_Admin | Local Admin duties only. |

### Clean Source Principle
**"One cannot manage a high-trust system from a low-trust system."**
*   **The Risk:** Managing a Domain Controller (Tier 0) from a standard Laptop exposes the DC to every malware infection on that laptop.
*   **The Solution (PAW):** A **Privileged Access Workstation** is a dedicated, hardened laptop used *only* for administration. No email, no web browsing, no Office.

### GPO Hardening: Enforcing Tiers
You cannot rely on policy (words on paper). You must enforce this electronically via Group Policy Objects.

**User Rights Assignment (Computer Configuration -> Policies -> Windows Settings -> Security Settings -> Local Policies -> User Rights Assignment):**

1.  **Deny log on locally:**
    *   On T1 Servers: Add `Tier 0 Admins` (Prevents T0 IPs from being exposed on Servers).
    *   On T2 Workstations: Add `Tier 0 Admins` AND `Tier 1 Admins`.

2.  **Deny log on as a batch job:**
    *   Prevents schedulers/services from caching high-priv credentials.

### Kerberos Attacks Defenses

**1. Kerberoasting:**
*   **Attack:** Attacker requests a TGS ticket for a Service Account (SPN). They take the ticket offline and crack the NTLM hash.
*   **Defense:** User complex (>25 chars) passwords for Service Accounts. Use gMSA (Group Managed Service Accounts) where possible (auto-rotates passwords).

**2. Golden Ticket:**
*   **Attack:** Attacker steals the `KRBTGT` hash. They can forge a TGT ticket valid for 10 years as any user (fake Domain Admin).
*   **Defense:** Rotate the `KRBTGT` password twice (to invalidate history) every 180 days. Limits the window of exposure.

---

## 3. Lab: Simulating Tier Enforcement

### Scenario
You are hardening a "Tier 1 Server" OU. You want to ensure Domain Admins (Tier 0) cannot accidentally expose their credentials on these servers.

### Step-by-Step

1.  **Create Groups:**
    *   Create `Admin_Tier0`, `Admin_Tier1`.
    *   Add your DA account to `Admin_Tier0`.

2.  **Create GPO:**
    *   Name: `SEC_Enforce_Tier1_Restrictions`.
    *   Link it to the `Servers` OU.

3.  **Edit Policies:**
    *   Navigate to: `Policies -> Windows Settings -> Security Settings -> Local Policies -> User Rights Assignment`.
    *   Open `Deny log on locally`.
    *   Add Group: `Admin_Tier0`.

4.  **Test:**
    *   Run `gpupdate /force` on a Member Server.
    *   Try to login with your Domain Admin account.
    *   **Result:** "The sign-in method you are trying to use isn't allowed." (Success! You have protected the DA credential from exposure).

---

## 4. Reflection Check
1.  Why do we need to rotate `KRBTGT` *twice*? (Because AD keeps the previous password history to validate existing tickets. Rotating once leaves the old hash valid until it times out. Rotating twice flushes the history immediately).
2.  Can a Tier 0 Admin read email on their PAW? (Absolutely not. Email is the #1 vector for malware. They need a separate device for "User" tasks).
3.  What is "LSASS"? (The Local Security Authority Subsystem Service. It holds credentials in memory. Mimikatz targets this process).
