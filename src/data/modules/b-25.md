# Cloud Monitoring: CloudTrail & GuardDuty

## 1. Orientation

### What this module covers
Visibility is everything. In AWS, **CloudTrail** logs every API call (Who did what), and **GuardDuty** is the Intelligent IDS (Intrusion Detection System). This module covers how to monitor and respond to cloud threats.

### Learning Objectives
*   Analyze **CloudTrail Logs** for forensic investigation.
*   Understand **GuardDuty** finding types (Cryptomining, Tor usage).
*   Automate responses using **EventBridge**.

---

## 2. Core Content

### CloudTrail: The Flight Recorder
Every time you click a button in the console or run a CLI command, it is an API call.
*   **Log Entry:** `Identity: Alice`, `Event: RunInstances`, `Source IP: 1.2.3.4`, `Time: 12:00`.
*   **Security:** Ensure CloudTrail is ON, logging to a separate "Log Archive" account, with integrity validation enabled.

### GuardDuty: The AI Watchdog
Analyzes CloudTrail, VPC Flow Logs, and DNS Logs. 
*   **Detects:** 
    *   *Recon:* Port scanning.
    *   *Compromise:* EC2 instance mining bitcoin.
    *   *IAM:* Unusual Root login locations.

### EventBridge (CloudWatch Events)
The glue for automation. 
*   *Trigger:* GuardDuty finds "High Severity Trojan".
*   *Action:* Trigger Lambda Function -> Isolate the EC2 Instance (Change Security Group).

---

## 3. Lab: Forensic Timeline

### Scenario
GuardDuty alerts: "UnauthorizedAccess:IAMUser/TorIPCaller".

**Investigation in CloudTrail:**
1.  Filter by `AccessKeyId` from the alert.
2.  **Findings:**
    *   10:00 AM: `ConsoleLogin` from IP (Tor Exit Node).
    *   10:05 AM: `CreateUser` "Backdoor Admin".
    *   10:06 AM: `AttachUserPolicy` "AdministratorAccess".
    *   10:10 AM: `RunInstances` (Bitcoin Miner).

**Response:** Revoke Key, Terminate Instances, Delete User.

---

## 4. Reflection
1.  Why must CloudTrail logs be stored in a *different* AWS account? (If higherpriv attackers compromise the Prod account, they will try to delete the logs to cover their tracks. Write-Only access to a Log Archive account prevents this).
2.  What does "Regional" mean for CloudTrail? (You need to enable it in ALL regions, even ones you don't use. Hackers love to hide in `sa-east-1` if you only monitor `us-east-1`).
