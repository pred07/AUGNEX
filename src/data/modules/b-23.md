# Infrastructure Security (VPC & Security Groups)

## 1. Orientation

### What this module covers
Even in the cloud, we need networks. The Virtual Private Cloud (VPC) is your private slice of the internet. This module covers isolating resources using Subnets, NACLs, and Security Groups.

### Learning Objectives
*   Design a **3-Tier VPC Architecture** (Public vs. Private Subnets).
*   Differentiate between **Security Groups** (Stateful) and **NACLs** (Stateless).
*   Understand **VPC Peering** and **PrivateLink** risks.

---

## 2. Core Content

### The 3-Tier Architecture (Cloud Edition)
1.  **Public Subnet:** Has an Internet Gateway (IGW). Contains Load Balancers (ALB) and NAT Gateways. **NO SERVERS HERE.**
2.  **Private Subnet (App):** No direct internet access. Contains EC2 App Servers / Containers.
3.  **Private Subnet (Data):** No internet routes at all. Contains RDS Databases.

### Security Groups vs NACLs
*   **Security Group (SG):** The Firewall *for the Instance*. 
    *   *Feature:* **Stateful**. If you allow OUTBOUND traffic to port 80, the return traffic is automatically allowed.
*   **Network ACL (NACL):** The Firewall *for the Subnet*.
    *   *Feature:* **Stateless**. You must explicitly allow both Inbound and Outbound rules (including Ephemeral ports 1024-65535).

### Flow Logs
VPC Flow Logs record the metadata of network traffic (Source IP, Dest IP, Port, Action). They are the "Packet Capture" lite of the cloud.

---

## 3. Lab: The Leaky Bucket

### Scenario
An EC2 instance in a Private Subnet is compromised. The attacker wants to download tools.

1.  **Route Table Check:** Does the Private Subnet have a route to a **NAT Gateway**? 
    *   *Yes:* The instance can reach the internet (outbound). Attacker succeeds.
    *   *No:* The instance is truly air-gapped. Attacker fails.

**Defense:** Use **VPC Endpoints** (PrivateLink) to allow access to S3/DynamoDB without traversing the public internet.

---

## 4. Reflection
1.  Why is `0.0.0.0/0` on SSH (Port 22) a critical finding? (It allows the entire world to brute force your SSH. Use VPN or SSM Session Manager instead).
2.  What is a "Bastion Host"? (A jump box in the public subnet used to SSH into private instances. Modern approach: Replace Bastions with SSM).
