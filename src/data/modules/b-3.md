# Threat Modeling for Engineers

## 1. Orientation

### What this module covers
This module moves beyond "thinking like an attacker" to **systematically modeling abuse**. You will learn industry-standard frameworks (STRIDE, PASTA) and—more importantly—how to integrate threat modeling into the engineering design phase. This is arguably the highest-ROI activity in security engineering.

### Fit in the Learning Path
This is a **Phase 1 (Foundations)** module in the BUILDER path. Before you write a line of code or deploy a container, you must understand how your design can be abused. This skill differentiates "coders" from "engineers."

### Learning Objectives
By the end of this module, you will:
*   Execute a **STRIDE** analysis on a system architecture diagram
*   Understand the difference between **Asset-Centric**, **Attacker-Centric**, and **Software-Centric** threat modeling
*   Create a **Data Flow Diagram (DFD)** specifically for security analysis
*   differentiate between a vulnerability, a threat, and a risk
*   Use the "Four Question Framework" effectively

---

## 2. Core Content

### The Four Question Framework (Shostack)
Adam Shostack, a pioneer in this field, defines threat modeling with four deceptive simple questions:
1.  **What are we building?** (System Model / DFD)
2.  **What can go wrong?** (Threat Identification / STRIDE)
3.  **What are we going to do about it?** (Mitigation Strategy)
4.  **Did we do a good job?** (Validation)

### Step 1: What are we building? (Modeling)
You cannot secure what you cannot understand. We use **Data Flow Diagrams (DFDs)**.
*   **Process (Circle):** Code running (e.g., Web Server, Lambda).
*   **Data Store (Parallel Lines):** Data at rest (e.g., SQL DB, Redis, S3).
*   **Data Flow (Arrow):** Data in motion (e.g., HTTPS req, RPC).
*   **External Entity (Square):** Humans or systems outside your control (e.g., User, Stripe API).
*   **Trust Boundary (Dotted Line):** *CRITICAL*. Where data moves between different privilege levels (e.g., Internet to VPC, User to Admin).

### Step 2: What can go wrong? (STRIDE)
Used primarily for software-centric modeling.
*   **S**poofing: "I am Admin." (Mitigation: Authentication)
*   **T**ampering: "I changed the price to $0." (Mitigation: Integrity/Signing)
*   **R**epudiation: "I didn't delete that DB." (Mitigation: Logging/Audit)
*   **I**nformation Disclosure: "I see your passwords." (Mitigation: Encryption/ACLs)
*   **D**enial of Service: "I crash your server." (Mitigation: Rate Limiting/Scaling)
*   **E**levation of Privilege: "I can run root commands." (Mitigation: Authorization)

### Step 3: Mitigation Strategies
For every found threat, you have four choices:
1.  **Mitigate:** Add a control (e.g., add TLS to prevent Tampering).
2.  **Eliminate:** Change design to remove the feature (e.g., remove the specific API endpoint).
3.  **Transfer:** Let someone else handle it (e.g., use AWS Cognito instead of writing auth).
4.  **Accept:** Document risk and sign off (e.g., "DOS risk acceptable for internal tool").

### Deep Dive: Trust Boundaries
The most common failure in engineering is an **Implicit Trust Boundary**.
*   *Bad:* "The frontend validates the input, so the backend assumes it's safe."
*   *Reality:* The attacker bypasses the frontend and calls the API directly.
*   *Rule:* **ALL input crossing a trust boundary is malicious until proven otherwise.**

---

## 3. Guided Lab Exercise: The "Pet Store" API

### Scenario
You are designing a monolithic "Pet Store" app.
*   **Users** (Internet) talk to **Web Server**.
*   **Web Server** talks to **SQL Database**.
*   **Web Server** writes logs to **Local Disk**.

### Lab Task: Identify Threats
Draw this DFD mentally or on paper. Now apply STRIDE to the **Web Server -> SQL Database** interaction.

1.  **Spoofing:** Can the Web Server pretend to be valid if an attacker controls it? Is the DB checking?
    *   *Fix:* Mutually Authenticated TLS (mTLS) or strong credentials.
2.  **Tampering:** Can someone modify the SQL query in transit?
    *   *Fix:* TLS.
3.  **Information Disclosure:** Is the connection cleartext? Can a network sniffer see the customer list?
    *   *Fix:* TLS.
4.  **Repudiation:** If a table is dropped, do we know which Web Server instance did it?
    *   *Fix:* Database audit logs identifying the service account.
5.  **Denial of Service:** Can the Web Server flood the DB with connections?
    *   *Fix:* Connection pooling limits on the web server side.

### Critical Thinking
*   Where is the trust boundary? (Between Web Server and DB? Or are they both in a trusted VPC?)
*   *Engineer's view:* Even inside a VPC, treat the network as hostile (Zero Trust).

---

## 4. Reflection Check

### Knowledge Check
1.  Why is a "Trust Boundary" the most important line on a diagram?
2.  Which letter of STRIDE corresponds to "Encryption at Rest"? (Hint: T and I).
3.  Why is "Validation" (Step 4) often skipped, and what is the consequence?

### Engineering Decision
You rarely have time to threat model *everything*. How do you prioritize?
*   *Guidance:* Focus on "High Value Assets" (User Data, PII) and "High Risk Interfaces" (Public APIs, Parsers).

---

## 5. Completion Criteria
1.  **Create** a DFD for a simple 3-tier architecture.
2.  **Identify** at least 3 threats using STRIDE across a Trust Boundary.
3.  **Propose** mitigations for those specific threats.

---

## 6. Further Depth
*   **Tool:** OWASP Threat Dragon (Free, open source diagramming).
*   **Book:** "Threat Modeling: Designing for Security" by Adam Shostack.
*   **Game:** play "Elevation of Privilege" (EoP), a card game by Microsoft to teach STRIDE.
