# Security Monitoring Concepts

## 1. Orientation

### What this module covers
This module explains HOW detection systems identify threats—the mechanisms behind determining whether activity is malicious. We cover signature-based detection, behavioral/heuristic detection, and anomaly detection, including their strengths, weaknesses, and evasion techniques.

### Fit in the Learning Path
Knowing what to monitor is insufficient; you must understand how monitoring actually works. This knowledge is essential for tuning detection systems, understanding attacker evasion, and designing effective detection strategies.

### Learning Objectives
By the end of this module, you will:
*   Explain signature-based detection and its limitations
*   Understand behavioral/heuristic detection and why it's necessary
*   Apply anomaly detection concepts and baseline requirements
*   Recognize how attackers evade each detection type

---

## 2. Core Content

### Mental Model: The Three Detection Approaches

**How professionals think about this:**
Detection answers "Is this bad?" There are three ways to answer: compare to known bad (signature), analyze behavior (heuristic), or identify deviation from normal (anomaly). Each has distinct trade-offs.

```
THE DETECTION SPECTRUM:

┌───────────────────────────────────────────────────────────────────────┐
│                                                                       │
│  SIGNATURE-BASED                                                      │
│  "Is this known bad?"                                                 │
│                                                                       │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐             │
│  │   Sample    │────►│  Hash/      │────►│   Match?    │             │
│  │             │     │  Pattern    │     │  YES = BAD  │             │
│  └─────────────┘     └─────────────┘     └─────────────┘             │
│                                                                       │
│  Pro: Fast, precise, low false positives                              │
│  Con: Only catches KNOWN threats                                      │
│                                                                       │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  BEHAVIORAL/HEURISTIC                                                 │
│  "Is this acting bad?"                                                │
│                                                                       │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐             │
│  │   Action    │────►│  Behavior   │────►│ Suspicious? │             │
│  │             │     │  Rules      │     │  YES = BAD  │             │
│  └─────────────┘     └─────────────┘     └─────────────┘             │
│                                                                       │
│  Pro: Catches unknown threats with bad behavior                       │
│  Con: Higher false positive rate                                      │
│                                                                       │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ANOMALY-BASED                                                        │
│  "Is this unusual?"                                                   │
│                                                                       │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐             │
│  │   Action    │     │  Baseline   │     │ Deviation?  │             │
│  │             │────►│  Normal     │────►│ YES = ALERT │             │
│  └─────────────┘     └─────────────┘     └─────────────┘             │
│                                                                       │
│  Pro: Detects insiders, credential theft, new attacks                 │
│  Con: Requires learning period, sensitive to change                   │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

### Signature-Based Detection

**How it works:**
Create a unique identifier (signature) for known threats. Compare new samples against signature database.

**Signature types:**

| Type | Description | Example |
|------|-------------|---------|
| **Hash** | Cryptographic hash of file | `MD5: 5d41402abc4b2a76b9719d911017c592` |
| **Pattern** | Byte sequences in file/traffic | `{6A 40 68 00 30 00 00}` |
| **String** | Text patterns | `mimikatz`, `Invoke-Mimikatz` |
| **Regex** | Pattern matching | `/password\s*=\s*.*/` |
| **YARA** | Rule-based pattern matching | Complex multi-pattern rules |
| **Snort/Suricata** | Network traffic patterns | Protocol + content patterns |

**Example YARA rule:**
```yara
rule Mimikatz_Memory {
    meta:
        description = "Detects Mimikatz in memory"
    strings:
        $a = "mimikatz" nocase
        $b = "sekurlsa" nocase
        $c = "kerberos::list" nocase
    condition:
        2 of ($a, $b, $c)
}
```

**Signature limitations:**

```
THE EVASION MATH:

Known malware file: malware.exe
  Hash: ABC123...
  Signature database: Contains ABC123... → DETECTED

Modified malware: malware_v2.exe
  Added one byte of padding
  Hash: DEF456...
  Signature database: Does NOT contain DEF456... → NOT DETECTED

CONCLUSION:
Changing ONE BYTE defeats signature-based detection.
```

**Evasion techniques:**

| Technique | How It Works |
|-----------|--------------|
| **Recompiling** | Same source, different binary |
| **Packing/Crypting** | Encrypt payload, decrypt at runtime |
| **Polymorphism** | Code that changes each run |
| **Metamorphism** | Complete code rewrites |
| **Fileless** | Never touch disk, no file to hash |

### Behavioral/Heuristic Detection

**How it works:**
Define suspicious behaviors rather than specific samples. Detect actions that indicate malicious intent.

**Behavior examples:**

```
SUSPICIOUS BEHAVIORS:

Process Behaviors:
├── Word.exe spawning cmd.exe (Should NEVER happen)
├── PowerShell downloading from internet
├── Process injecting into another process
├── Service installed from temp directory
└── LSASS accessed by non-system process

Network Behaviors:
├── DNS tunneling patterns
├── Beaconing (regular intervals to same host)
├── Large uploads to unknown destinations
└── Command and control protocols

File Behaviors:
├── Rapid file encryption (ransomware)
├── Modification of system binaries
├── Writing to startup locations
└── Creating scheduled tasks
```

**Parent-child process relationships:**
```
NORMAL PROCESS TREES:

explorer.exe
└── firefox.exe

svchost.exe
└── service operations

SUSPICIOUS PROCESS TREES:

winword.exe           ← Office document
└── cmd.exe           ← Command shell (Macro!)
    └── powershell.exe ← Script execution
        └── net.exe   ← Recon/lateral movement

This chain should NEVER happen under normal conditions.
Detection: Alert on Word/Excel/PowerPoint spawning shells.
```

**Behavioral detection advantages:**

| Advantage | Explanation |
|-----------|-------------|
| Catches unknown malware | Behavior, not sample, is detected |
| Detects tool usage | Same behavior from different tools |
| Harder to evade | Must change how attack works, not just code |

**False positive challenges:**
```
BEHAVIOR: PowerShell executes encoded command
  - Attack: Obfuscated malware script
  - Legitimate: Automation from IT team

BEHAVIOR: Process accesses LSASS
  - Attack: Credential dumping
  - Legitimate: AV scanning process

BEHAVIOR: Large data transfer to cloud
  - Attack: Data exfiltration
  - Legitimate: Backup to cloud storage

SOLUTION: Context + tuning + analyst review
```

### Anomaly Detection

**How it works:**
Establish what "normal" looks like (baseline), then alert on deviations.

**Anomaly types:**

| Type | Baseline | Anomaly Example |
|------|----------|-----------------|
| **Statistical** | Average behaviors | 10x normal data transfer |
| **User** | User behavioral baseline | Bob logs in from China at 3am |
| **Entity** | Machine baseline | Server suddenly making DNS requests |
| **Network** | Traffic patterns | New protocol appears on network |

**User Entity Behavior Analytics (UEBA):**
```
USER BASELINE (Built over 30+ days):

User: Bob
  Login times: 08:00-18:00 EST
  Login locations: New York, Home (VPN)
  Systems accessed: 5 specific servers
  Data accessed: Marketing files
  Transfer volume: 10-50 MB/day

ANOMALY DETECTED:
  Login time: 03:00 EST (ABNORMAL)
  Login location: Shanghai (ABNORMAL)
  Systems accessed: Finance server (NEW)
  Data accessed: Confidential documents (ABNORMAL)
  Transfer volume: 2 GB (ABNORMAL)

ALERT: Possible account compromise
```

**Baseline challenges:**

| Challenge | Impact |
|-----------|--------|
| Learning period | Weeks/months to establish normal |
| Baseline poisoning | Attacker present during learning = bad baseline |
| Seasonal variation | Holiday patterns differ from normal |
| Organizational change | Mergers, new systems break baseline |
| Insider threats | Authorized user deviating slowly |

### Detection In Depth

**Layered approach:**

```
DETECTION LAYERS:

Layer 1: SIGNATURE
├── Fast, catches known threats
├── Low analyst effort
└── First filter

Layer 2: BEHAVIOR
├── Catches TTPs across tools
├── Medium analyst effort
└── Second filter

Layer 3: ANOMALY
├── Catches novel threats
├── High analyst effort
└── Final safety net

ALERT FLOW:
1,000,000 logs → Signature filter → 10,000 remain
10,000 remain → Behavior filter → 500 remain
500 remain → Anomaly filter → 50 alerts
50 alerts → Analyst review → 5 incidents
```

### Attacker Evasion: Living Off the Land

**The modern challenge:**

Attackers use legitimate system tools (LOLBins) with legitimate behaviors:
```
LIVING OFF THE LAND:

Instead of:              Use:
─────────────────────────────────────
Custom malware    →  PowerShell
Netcat            →  BITSAdmin
Mimikatz.exe      →  comsvcs.dll MiniDump
Custom downloader →  certutil

Result:
- No malicious signed executables to detect
- Every tool used is Microsoft-signed
- Behaviors look like admin activity
- VERY hard to distinguish from legitimate use
```

**Detection requires context:**
- WHO is running the command?
- WHEN are they running it?
- WHAT else are they doing?
- WHERE is the target system?

---

## 3. Guided Practice

### Exercise 1: Detection Classification

Classify each detection:

| Detection Logic | Type (Sig/Behav/Anom) |
|-----------------|----------------------|
| Hash matches known malware | ___ |
| PowerShell spawned from Excel | ___ |
| User logging in from new country | ___ |
| File contains string "Invoke-Mimikatz" | ___ |
| 10x normal data egress volume | ___ |
| Process injecting into LSASS | ___ |

### Exercise 2: Alert Analysis

**Alert:** "Suspicious Process: winword.exe spawned powershell.exe which spawned net.exe"

Analyze:
1. Is this signature or behavioral detection? ___
2. Why is this suspicious? ___
3. Could this be legitimate? ___
4. What additional context would help? ___

### Exercise 3: Evasion Thinking

For each detection type, describe an evasion:

| Detection | Evasion Approach |
|-----------|------------------|
| Hash-based AV | ___ |
| "PowerShell downloads file" rule | ___ |
| "Login from new location" anomaly | ___ |

---

## 4. Reflection Check

### Detection Understanding
1. Why can't organizations rely solely on signature-based detection?

2. A behavioral rule "Alert on net user command" generates 500 alerts per day from sysadmins. Is this good detection?

3. Why does anomaly detection need weeks of "learning" before being useful?

### Attacker Perspective
1. How do attacker use "living off the land" to evade behavioral detection?

2. If behavioral detection watches for "parent Word spawning child PowerShell," how might an attacker avoid this?

3. An organization's anomaly detection is trained on 6 months of data. An attacker was inside for month 3-4. What's the problem?

---

## 5. Key Misconceptions

**MYTH: "Antivirus signatures are obsolete"**
REALITY: Signatures catch commodity malware instantly. They're fast, precise, and reduce analyst workload. They're necessary but insufficient.

**MYTH: "Behavioral detection catches everything"**
REALITY: Behaviors can be mimicked (LOLBins) or tuned out (too many false positives). It's powerful but not complete.

**MYTH: "Anomaly = suspicious = bad"**
REALITY: Many anomalies are benign (new project, vacation). Anomaly detection finds unusual, not malicious.

**MYTH: "AI/ML will replace all other detection"**
REALITY: ML detects anomalies, which still require signatures + behaviors + analyst judgment.

**MYTH: "More rules = better detection"**
REALITY: More rules = more false positives = alert fatigue. Quality matters more than quantity.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Explain** signature, behavioral, and anomaly detection mechanisms
2. **Identify** strengths and weaknesses of each approach
3. **Recognize** how attackers evade each detection type
4. **Analyze** alerts to determine detection type and required context
5. **Design** detection strategies using layered approaches

---

## 7. Further Depth (Optional)

*   **Practice:** Write YARA rules for common malware families
*   **Research:** Study Sigma rules for behavioral detection
*   **Tool:** Explore EDR behavioral detection logic (CrowdStrike, SentinelOne)
*   **Advanced:** Research ML-based anomaly detection approaches
