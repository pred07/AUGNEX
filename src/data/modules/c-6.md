# Mapping Attacks to Defensive Controls

## 1. Orientation

### What this module covers
This module teaches systematic mapping between attack techniques and defensive controls. Understanding which controls address which threats enables gap analysis, investment prioritization, and defense in depth architecture.

### Fit in the Learning Path
"We have security tools" is meaningless without understanding what they protect against. Control mapping connects investment to threat coverage, revealing gaps and redundancies. This is essential for security architecture and risk management.

### Learning Objectives
By the end of this module, you will:
*   Map ATT&CK techniques to defensive controls
*   Distinguish prevention, detection, and response controls
*   Identify control gaps and redundancies
*   Build defense in depth architectures

---

## 2. Core Content

### Mental Model: The Shield Matrix

**How professionals think about this:**
Every attack technique has potential defensive controls. Map the attack surface to your control surface. Where they don't overlap are your gaps. Where they overlap multiple times is your depth.

```
CONTROL MAPPING CONCEPT:

ATTACK TECHNIQUE                    DEFENSIVE CONTROLS
      │                                    │
      │                   ┌────────────────┼────────────────┐
      │                   │                │                │
      ▼                   ▼                ▼                ▼
┌──────────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  T1566.001   │    │ PREVENT  │    │  DETECT  │    │ RESPOND  │
│  Phishing    │    │          │    │          │    │          │
│              │───►│ Email    │───►│ Email    │───►│ Isolate  │
│              │    │ Gateway  │    │ Analysis │    │ User     │
│              │    │          │    │          │    │          │
│              │───►│ User     │───►│ Endpoint │───►│ Reset    │
│              │    │ Training │    │ Detection│    │ Creds    │
│              │    │          │    │          │    │          │
│              │───►│ MFA      │    │          │───►│ Forensics│
│              │    │          │    │          │    │          │
└──────────────┘    └──────────┘    └──────────┘    └──────────┘

Multiple controls for one technique = Defense in Depth
```

### Control Categories

**Types of defensive controls:**

```
CONTROL CATEGORIES:

PREVENTIVE CONTROLS
─────────────────────────────
Stop attack before it succeeds

Examples:
- Firewall (block network attack)
- Patch management (remove vulnerability)
- MFA (prevent credential abuse)
- Application whitelist (block execution)
- Email gateway (filter malicious email)

DETECTIVE CONTROLS
─────────────────────────────
Identify attack in progress or after

Examples:
- SIEM/SOC (log analysis)
- EDR (endpoint behavior)
- IDS/IPS (network monitoring)
- File integrity monitoring
- User behavior analytics

RESPONSIVE CONTROLS
─────────────────────────────
Act after detection to limit damage

Examples:
- Incident response team
- Automated isolation
- Password reset
- Forensic investigation
- Communication plan

CORRECTIVE CONTROLS
─────────────────────────────
Fix root cause after incident

Examples:
- Patching
- Configuration hardening
- Policy updates
- Architecture changes
- Training improvements

RECOVERY CONTROLS
─────────────────────────────
Restore normal operations

Examples:
- Backups
- Disaster recovery
- Business continuity
- System rebuilding
```

### MITRE ATT&CK Mapping

**Systematic technique-to-control mapping:**

```
EXAMPLE: CREDENTIAL DUMPING (T1003)

TECHNIQUE: T1003 - OS Credential Dumping

Sub-techniques:
- T1003.001 - LSASS Memory
- T1003.002 - SAM
- T1003.003 - NTDS
- T1003.004 - LSA Secrets

CONTROLS BY CATEGORY:

PREVENT:
─────────────────────────────
├── Credential Guard (Block LSASS access)
├── Protected Users group (Limit exposure)
├── LSA Protection (RunAsPPL)
├── Remove debug privileges
└── Reduce local admin accounts

DETECT:
─────────────────────────────
├── Sysmon Event ID 10 (LSASS access)
├── Windows Event 4656 (Handle request)
├── EDR behavioral detection
├── SIEM correlation rules
└── Memory analysis alerts

RESPOND:
─────────────────────────────
├── Isolate affected endpoint
├── Force password reset (domain-wide if needed)
├── Revoke Kerberos tickets
├── Memory dump for analysis
└── Threat hunt related systems

RECOVER:
─────────────────────────────
├── Rotate KRBTGT (if DC compromised)
├── Rebuild affected systems
├── Reset service accounts
└── Audit access controls
```

### Defense in Depth Matrix

**Layered control architecture:**

| Attack Stage | Layer 1 | Layer 2 | Layer 3 |
|--------------|---------|---------|---------|
| **Initial Access** | Email gateway | User awareness | Endpoint protection |
| **Execution** | Application whitelist | EDR | Script logging |
| **Persistence** | Registry monitoring | Scheduled task audit | Startup analysis |
| **Privilege Escalation** | Patch management | UAC enforcement | Anomaly detection |
| **Credential Access** | Credential Guard | LSASS protection | Behavior analytics |
| **Lateral Movement** | Network segmentation | SMB signing | Authentication logs |
| **Exfiltration** | DLP | CASB | Network monitoring |

### Gap Analysis Process

**Finding what's missing:**

```
GAP ANALYSIS METHODOLOGY:

1. LIST RELEVANT TECHNIQUES
   ─────────────────────────────
   Use threat intelligence
   Industry-specific threats
   MITRE ATT&CK prioritization
   
   Example priority list:
   - Phishing (T1566)
   - Valid Accounts (T1078)
   - PowerShell (T1059.001)
   - Remote Services (T1021)
   - Data Encrypted (T1486)

2. MAP EXISTING CONTROLS
   ─────────────────────────────
   For each technique, document:
   - What prevents it?
   - What detects it?
   - What responds to it?
   
   Rate each: Strong / Partial / Weak / None

3. IDENTIFY GAPS
   ─────────────────────────────
   Techniques with:
   - No prevention
   - No detection
   - Single layer only
   - Weak controls only

4. PRIORITIZE REMEDIATION
   ─────────────────────────────
   Consider:
   - Threat likelihood
   - Impact if exploited
   - Cost to remediate
   - Time to implement

5. IMPLEMENT AND VALIDATE
   ─────────────────────────────
   Deploy new controls
   Purple team validation
   Update documentation
```

### Control Efficacy Assessment

**Are controls actually working?**

```
CONTROL VALIDATION:

FOR EACH CONTROL:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  1. COVERAGE                                                       │
│     What percentage of assets/users does it protect?               │
│     100% intended ≠ 100% actual                                    │
│                                                                     │
│  2. CONFIGURATION                                                  │
│     Is it properly configured?                                     │
│     Default settings often inadequate                              │
│                                                                     │
│  3. EFFECTIVENESS                                                  │
│     Does it actually stop/detect attack?                           │
│     Test with real techniques                                      │
│                                                                     │
│  4. BYPASS RESISTANCE                                              │
│     How easily can attacker evade it?                              │
│     Known bypass techniques?                                       │
│                                                                     │
│  5. OPERATIONAL STATUS                                             │
│     Is it currently functioning?                                   │
│     Alerts enabled? Staff monitoring?                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

RATING SCALE:
Strong: Tested effective, good coverage, bypass-resistant
Partial: Some coverage, known limitations
Weak: Limited coverage, easily bypassed
None: Control doesn't exist for this technique
```

### Primary vs Compensating Controls

**Understanding control relationships:**

```
CONTROL RELATIONSHIPS:

PRIMARY CONTROL:
─────────────────────────────
Directly addresses the vulnerability/threat

Example: Patch the vulnerability
Result: Vulnerability eliminated

COMPENSATING CONTROL:
─────────────────────────────
Reduces risk when primary not feasible

Example: WAF when patching not possible
Result: Attack mitigated, not eliminated

HIERARCHY:
─────────────────────────────
1. Primary (fix root cause)
2. Compensating (mitigate risk)
3. Detective (know it happened)
4. Response (limit damage)

EXAMPLE SCENARIO:
─────────────────────────────
Vulnerability: Log4Shell (CVE-2021-44228)

Primary: Patch Log4j → PREFERRED
   ↓ (if not immediately possible)
Compensating: WAF rules blocking JNDI
   ↓
Detective: Network monitoring for LDAP/RMI
   ↓
Response: Incident response plan

NEVER substitute compensating for primary long-term
```

### Visualization: Bow-Tie Diagram

**Risk and control visualization:**

```
BOW-TIE DIAGRAM (Ransomware):

THREATS                  EVENT               CONSEQUENCES
(Left side)              (Center)            (Right side)

┌─────────────┐                            ┌─────────────┐
│ Phishing    │      ●─────●────●          │ Data Loss   │
│ RDP Brute   │─────►│ RANSOMWARE│────────►│ Downtime    │
│ Exploit     │      │  EXECUTES │         │ Reputation  │
└─────────────┘      └─────┬─────┘         │ Financial   │
                           │               └─────────────┘
       │                   │                      │
       ▼                   │                      ▼
  PREVENTIVE              │              RECOVERY CONTROLS
  CONTROLS                │                      
                          │                      
├─ Email filtering        │         ├─ Offline backups
├─ RDP disabled/MFA       │         ├─ Incident response
├─ Patching               │         ├─ DR plan
├─ EDR blocking           │         ├─ Communication plan
└─ Network segmentation   │         └─ Cyber insurance
```

---

## 3. Guided Practice

### Exercise 1: Technique Mapping

Map controls for T1053.005 (Scheduled Task/Job):

| Control Type | Specific Control | Addresses How |
|--------------|------------------|---------------|
| Prevent | ___ | ___ |
| Prevent | ___ | ___ |
| Detect | ___ | ___ |
| Detect | ___ | ___ |
| Respond | ___ | ___ |

### Exercise 2: Gap Identification

Given these findings, identify gaps:

Technique: T1021.001 (Remote Desktop Protocol)
- Prevention: MFA on VPN ✓
- Prevention: RDP exposed to internet ✗
- Detection: Login monitoring ✓
- Detection: Session recording ✗
- Response: Manual isolation only ✗

Gaps to address:
1. ___
2. ___
3. ___

### Exercise 3: Defense in Depth

Design 3-layer defense for data exfiltration:

| Layer | Control | What It Catches |
|-------|---------|-----------------|
| 1 | ___ | ___ |
| 2 | ___ | ___ |
| 3 | ___ | ___ |

---

## 4. Reflection Check

### Mapping Understanding
1. Organization has excellent prevention. Detection is weak. Problem?

2. Every technique has 10 controls mapped. Still breached. Why?

3. Compensating control in place for 2 years. Issue?

### Strategic Thinking
1. Budget for one new control. How do you choose?

2. Purple team says rule doesn't detect attack. Next step?

3. Control covers 90% of assets. Good enough?

---

## 5. Key Misconceptions

**MYTH: "More controls = more security"**
REALITY: Properly configured, validated controls matter more than quantity.

**MYTH: "Prevention is better than detection"**
REALITY: Both are essential. Prevention fails; detection provides second chance.

**MYTH: "Mapping once is enough"**
REALITY: Threats evolve, controls decay. Continuous mapping required.

**MYTH: "Compliance frameworks = adequate controls"**
REALITY: Compliance checks existence, not effectiveness.

**MYTH: "Our vendor handles control mapping"**
REALITY: Vendors map their product. You must map your entire environment.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Map** attack techniques to defensive controls
2. **Categorize** controls (prevent/detect/respond)
3. **Identify** gaps in coverage
4. **Design** defense in depth architecture
5. **Validate** control effectiveness

---

## 7. Further Depth (Optional)

*   **Framework:** MITRE ATT&CK Navigator for visual mapping
*   **Tool:** MITRE D3FEND for defensive technique taxonomy
*   **Practice:** Create control matrix for your environment
*   **Resource:** NIST CSF for control category mapping
