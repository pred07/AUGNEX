# Active Reconnaissance Techniques

## 1. Orientation

### What this module covers
This module introduces active scanning—directly interacting with target systems to discover open ports, running services, and potential vulnerabilities. We focus primarily on Nmap, the industry standard for network reconnaissance, along with scan types, timing considerations, and stealth techniques.

### Fit in the Learning Path
After exhausting passive intelligence, you transition to active probing. This is where your IP hits their logs. You need to understand what you're doing, what artifacts you leave, and how to minimize detection.

### Learning Objectives
By the end of this module, you will:
*   Understand TCP/IP fundamentals required for scanning
*   Master Nmap scan types and when to use each
*   Interpret scan results correctly
*   Apply timing and stealth techniques appropriately

---

## 2. Core Content

### Mental Model: Probing the Perimeter

**How professionals think about this:**
Active scanning is systematic testing of network boundaries. Each probe leaves traces. The goal: maximum reconnaissance with minimum noise.

```
ACTIVE SCANNING FLOW:

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   ATTACKER  │──────►│   NETWORK   │──────►│   TARGET    │
│             │       │             │       │             │
│ 1. Send     │       │ May have:   │       │ 2. Responds │
│    probe    │       │ - Firewall  │       │    (or not) │
│             │       │ - IDS/IPS   │       │             │
│ 3. Interpret│◄──────│ - Logging   │◄──────│             │
│    response │       │             │       │             │
└─────────────┘       └─────────────┘       └─────────────┘
                              │
                              ▼
                    YOUR IP IS NOW LOGGED
```

### TCP/IP Fundamentals for Scanning

**The Three-Way Handshake:**
```
Normal TCP Connection:

CLIENT                    SERVER
   │                         │
   │──── SYN ───────────────►│  "I want to connect"
   │                         │
   │◄─── SYN-ACK ───────────│  "OK, I acknowledge"
   │                         │
   │──── ACK ───────────────►│  "Connected!"
   │                         │
   │     (Connection established)
   │                         │
```

**Port states:**

| State | Response | Meaning |
|-------|----------|---------|
| **Open** | SYN-ACK | Service is listening and accepting connections |
| **Closed** | RST | Port is not listening but host is alive |
| **Filtered** | No response / ICMP unreachable | Firewall is blocking |
| **Open/Filtered** | Ambiguous (UDP/other) | Cannot determine state |

### Nmap Scan Types

**TCP Scans:**

```
SCAN TYPE COMPARISON:

SYN SCAN (-sS) "Half-open" - DEFAULT
────────────────────────────────────
CLIENT            SERVER
   │── SYN ──────►│
   │◄── SYN-ACK ──│  (Open)
   │── RST ──────►│  "Never mind"
   
Pro: Fast, relatively stealthy (no connection logged)
Con: Requires root/admin privileges
When: Default for root users


CONNECT SCAN (-sT) "Full connection"
────────────────────────────────────
CLIENT            SERVER
   │── SYN ──────►│
   │◄── SYN-ACK ──│
   │── ACK ──────►│  (Connection established)
   │── RST ──────►│  (Then closed)
   
Pro: Works without privileges
Con: Fully logged in most applications
When: Non-root users, or when firewall allows full connections


NULL/FIN/XMAS SCANS (-sN/-sF/-sX)
────────────────────────────────────
Exploit RFC rules: send unusual flags
Open port: No response
Closed port: RST

Pro: May bypass simple firewalls
Con: Unreliable on Windows, many FW detect these
When: Rare, specific evasion scenarios
```

**UDP Scan (-sU):**
```
UDP SCANNING:

UDP is connectionless - no handshake

CLIENT            SERVER
   │── UDP ──────►│
   │              │  Open: No response OR application response
   │              │  Closed: ICMP Port Unreachable

Challenges:
- Slow (must wait for no-response timeout)
- Often rate-limited by ICMP
- Less reliable than TCP

Important UDP services: DNS(53), DHCP(67), SNMP(161), NTP(123)
```

### Essential Nmap Options

**Target specification:**
```bash
nmap 192.168.1.1            # Single host
nmap 192.168.1.0/24         # CIDR range
nmap 192.168.1.1-50         # IP range
nmap -iL targets.txt        # From file
nmap --exclude 192.168.1.1  # Exclude host
```

**Port specification:**
```bash
nmap -p 80                  # Single port
nmap -p 80,443,8080         # Multiple ports
nmap -p 1-1000              # Port range
nmap -p-                    # All 65535 ports
nmap --top-ports 100        # Top 100 most common
nmap -p http                # By service name
```

**Service detection:**
```bash
nmap -sV                    # Version detection
nmap -sV --version-intensity 5  # More aggressive
nmap -A                     # Aggressive (version + OS + scripts)
```

**Common scan combinations:**
```bash
# Quick scan - most common ports
nmap -sS -T4 target

# Thorough scan - all ports, version detection
nmap -sS -sV -p- target

# Stealth scan - slow, avoids detection
nmap -sS -T2 -p- target

# Comprehensive assessment
nmap -sS -sV -sC -O -p- target

# UDP services
sudo nmap -sU --top-ports 100 target
```

### Timing and Performance

**Timing templates:**

| Template | Name | Use Case |
|----------|------|----------|
| -T0 | Paranoid | IDS evasion (5 min between probes) |
| -T1 | Sneaky | IDS evasion |
| -T2 | Polite | Low bandwidth/low impact |
| -T3 | Normal | Default |
| -T4 | Aggressive | Fast, reliable network |
| -T5 | Insane | Very fast, may miss hosts |

**Fine-grained control:**
```bash
# Custom timing
nmap --max-rate 10        # Max 10 packets/sec
nmap --min-rate 100       # Minimum rate
nmap --scan-delay 1s      # Delay between probes
nmap --max-retries 2      # Retry dropped packets
```

### Output Formats

```bash
# Normal output (-oN)
nmap -oN scan.txt target

# Grepable output (-oG)
nmap -oG scan.gnmap target

# XML output (-oX)
nmap -oX scan.xml target

# All formats (-oA)
nmap -oA scan_results target
# Creates: scan_results.nmap, scan_results.gnmap, scan_results.xml
```

### Detection and Evasion

**What defenders see:**

```
FIREWALL/IDS LOGS:

2024-01-15 10:00:00 SYN from 192.168.1.100 to 10.0.0.5:22
2024-01-15 10:00:00 SYN from 192.168.1.100 to 10.0.0.5:23
2024-01-15 10:00:00 SYN from 192.168.1.100 to 10.0.0.5:25
2024-01-15 10:00:00 SYN from 192.168.1.100 to 10.0.0.5:80
... (1000 more in 1 second)

ALERT: Port scan detected from 192.168.1.100
```

**Evasion techniques:**

| Technique | Nmap Option | Purpose |
|-----------|-------------|---------|
| Slow timing | -T0 or -T1 | Spread scan over hours/days |
| Decoys | -D RND:10 | Generate fake source IPs |
| Source port | -g 53 | Use trusted port (DNS) |
| Fragmentation | -f | Split packets into fragments |
| Randomize | --randomize-hosts | Scan out of order |
| Idle scan | -sI zombie | Bounce through idle host |

### Practical Scan Workflows

```
METHODOLOGY:

1. DISCOVERY (Is host alive?)
   nmap -sn 192.168.1.0/24
   
2. QUICK PORT CHECK (Common ports)
   nmap -F 192.168.1.1-10
   
3. FULL PORT SCAN (All ports)
   nmap -p- 192.168.1.5
   
4. SERVICE ENUMERATION
   nmap -sV -p 22,80,443 192.168.1.5
   
5. VULNERABILITY SCRIPTS
   nmap -sV --script vuln -p 80 192.168.1.5
```

### NSE Scripts

**Nmap Scripting Engine:**
```bash
# Default scripts (safe, useful)
nmap -sC target

# Specific category
nmap --script vuln target
nmap --script safe target
nmap --script discovery target

# Specific script
nmap --script http-title target
nmap --script banner target

# List available scripts
ls /usr/share/nmap/scripts/
```

---

## 3. Guided Practice

### Exercise 1: Basic Scanning

Scan the authorized target `scanme.nmap.org`:

```bash
# Basic scan
nmap scanme.nmap.org

# Version detection
nmap -sV scanme.nmap.org

# Service scripts
nmap -sC scanme.nmap.org
```

Record findings:
- Open ports: ___
- Services detected: ___
- Operating system guess: ___

### Exercise 2: Scan Comparison

Compare scan types (requires root):

```bash
# SYN scan (stealth)
sudo nmap -sS scanme.nmap.org

# Connect scan
nmap -sT scanme.nmap.org

# Compare timing
time sudo nmap -sS scanme.nmap.org
time nmap -sT scanme.nmap.org
```

Questions:
- Which is faster? Why? ___
- Which would leave more evidence? ___

### Exercise 3: Output Analysis

```bash
nmap -sV -oA practice_scan scanme.nmap.org
```

Examine all output files:
- What does the .gnmap file look like? ___
- What additional info is in .xml? ___

---

## 4. Reflection Check

### Technical Understanding
1. Why does SYN scan send RST instead of completing the handshake?

2. A port shows as "filtered." What does this tell you about the network architecture?

3. You're scanning a slow, old network. Which timing template and why?

### Operational Thinking
1. You're on a red team engagement. The client says "be stealthy." What scan strategy do you use?

2. You've identified 50 live hosts. How do you prioritize which to scan deeply?

3. UDP scan on 1000 hosts is taking 8 hours. What's happening and what might you do?

---

## 5. Key Misconceptions

**MYTH: "SYN scan is completely invisible"**
REALITY: SYN scan is stealthier but still visible to network monitoring. Modern IDS detects half-open connections.

**MYTH: "All 65535 ports must be scanned every time"**
REALITY: Full port scans are slow and noisy. Use top-ports for initial discovery, full scan only when needed.

**MYTH: "Faster is always better"**
REALITY: Aggressive timing causes packet loss, missed hosts, and detection. Match timing to the network.

**MYTH: "Filtered means the port is closed"**
REALITY: Filtered means firewall is blocking. The service might be running behind the firewall.

**MYTH: "Nmap is just for hackers"**
REALITY: Nmap is a legitimate network administration tool. IT teams use it for inventory and troubleshooting.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Execute** SYN, Connect, and UDP scans appropriately
2. **Interpret** port states (open, closed, filtered)
3. **Apply** timing templates based on situation
4. **Use** version detection and NSE scripts
5. **Save** and analyze scan output in multiple formats

---

## 7. Further Depth (Optional)

*   **Practice:** Complete TryHackMe Nmap room
*   **Advanced:** Study idle scan (-sI) mechanics
*   **Scripting:** Write custom NSE scripts
*   **Documentation:** Read the full nmap man page
