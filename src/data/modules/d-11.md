# Authentication and Authorization Logs

## 1. Orientation

### What this module covers
This module focuses on authentication and authorization logs—the most critical log category for security monitoring. These logs record who is accessing systems, how they're authenticating, and what privileges they're using.

### Fit in the Learning Path
90% of attacks involve compromised credentials. Authentication logs are your primary source for detecting credential abuse, brute force attacks, privilege escalation, and lateral movement.

### Learning Objectives
By the end of this module, you will:
*   Analyze authentication events across platforms
*   Detect brute force, credential stuffing, and spray attacks
*   Identify privilege escalation indicators
*   Recognize advanced attacks (Pass-the-Hash, Golden Ticket)

---

## 2. Core Content

### Mental Model: Identity is the New Perimeter

**How professionals think about this:**
With cloud, remote work, and VPNs, the network perimeter is dissolving. Identity has become the security boundary. Monitoring authentication is now the primary detection layer.

```
AUTHENTICATION LOG IMPORTANCE:

TRADITIONAL PERIMETER:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  INTERNET ──► [FIREWALL] ──► INTERNAL NETWORK                      │
│                   │                                                 │
│                   └── Security checkpoint                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

MODERN REALITY:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  Users access from:                                                 │
│  ├── Office (any device)                                           │
│  ├── Home (personal device)                                        │
│  ├── Coffee shop (untrusted network)                               │
│  ├── VPN (anywhere)                                                │
│  └── Cloud services (no firewall traversal)                        │
│                                                                     │
│  IDENTITY = THE NEW PERIMETER                                       │
│                                                                     │
│  Every authentication event is a security checkpoint               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Critical Authentication Events

**Windows authentication events:**

| Event ID | Description | Significance |
|----------|-------------|--------------|
| **4624** | Successful logon | Who logged in, how, from where |
| **4625** | Failed logon | Brute force indicator |
| **4634/4647** | Logoff | Session duration |
| **4648** | Logon with explicit credentials | RunAs, privilege use |
| **4672** | Special privileges assigned | Admin session |
| **4720** | User account created | Persistence |
| **4724/4726** | Password reset/User deleted | Account manipulation |
| **4768** | Kerberos TGT request | Initial domain auth |
| **4769** | Kerberos service ticket | Service access |
| **4776** | NTLM authentication | Legacy auth (often suspicious) |

**Linux authentication events:**

```
LINUX AUTH LOG PATTERNS (/var/log/auth.log):

SUCCESSFUL LOGIN:
Accepted password for bob from 192.168.1.100 port 55555 ssh2
Accepted publickey for alice from 10.0.0.50 port 44444 ssh2

FAILED LOGIN:
Failed password for bob from 192.168.1.100 port 55555 ssh2
Failed password for invalid user admin from 203.0.113.5 port 22

PRIVILEGE ESCALATION:
bob : TTY=pts/0 ; PWD=/home/bob ; USER=root ; COMMAND=/bin/bash
session opened for user root by bob(uid=1000)

ACCOUNT CHANGES:
useradd[12345]: new user: name=attacker, UID=1001
passwd[12346]: password changed for user attacker
```

### Logon Types

**Understanding how authentication occurred:**

```
WINDOWS LOGON TYPES:

Type 2 - Interactive (Console)
│
├── User at keyboard
├── Physical access
└── Usually legitimate (but check time, user context)

Type 3 - Network
│
├── Remote access (file share, web)
├── Most common
└── Lateral movement often uses Type 3

Type 4 - Batch
│
├── Scheduled tasks
└── Unusual for interactive users

Type 5 - Service
│
├── Service startup
└── Should be service accounts only

Type 7 - Unlock
│
├── Workstation unlocked
└── User returning to session

Type 10 - RemoteInteractive
│
├── RDP session
├── HIGH IMPORTANCE
└── Often targeted by attackers

Type 11 - CachedInteractive
│
├── Cached credentials used
└── Works offline (no DC contact)
```

### Detecting Authentication Attacks

**Brute force detection:**

```
BRUTE FORCE INDICATORS:

Pattern: Many failed logins → One success
─────────────────────────────────────────────
4625 Failed - bob - 10.0.0.1 - 08:00:01
4625 Failed - bob - 10.0.0.1 - 08:00:02
4625 Failed - bob - 10.0.0.1 - 08:00:03
... (50 more)
4624 Success - bob - 10.0.0.1 - 08:00:55 ← COMPROMISED

Detection rule:
IF failures(user, source_ip, 5min) > 10
AND success(user, source_ip) within 10min of last failure
THEN ALERT "Likely Brute Force Success"
```

**Credential stuffing detection:**

```
CREDENTIAL STUFFING INDICATORS:

Pattern: Many users, few attempts each
─────────────────────────────────────────────
4625 Failed - alice - 203.0.113.50
4625 Failed - bob - 203.0.113.50
4625 Failed - charlie - 203.0.113.50
4625 Failed - david - 203.0.113.50
... (1000 different users)

Detection rule:
IF unique_users(source_ip, 1hour) > 100
THEN ALERT "Likely Credential Stuffing"
```

**Password spray detection:**

```
PASSWORD SPRAY INDICATORS:

Pattern: Many users, same time, low failure rate per user
─────────────────────────────────────────────
4625 Failed - user1 - 10.0.0.100 - 08:00:00
4625 Failed - user2 - 10.0.0.100 - 08:00:00  
4625 Failed - user3 - 10.0.0.100 - 08:00:00
(No lockouts - only 1 attempt per user)

Detection rule:
IF unique_users(source_ip, 5min) > 50
AND failures_per_user < 3
THEN ALERT "Password Spray Attack"
```

### Privilege Escalation Logs

**Monitoring privilege use:**

```
PRIVILEGE ESCALATION INDICATORS:

WINDOWS:
Event 4672 - Special privileges assigned
  → Admin login detected
  → Check: Is this user supposed to have admin rights?

Event 4648 - Explicit credentials
  → User authenticated as different user
  → Check: Is this RunAs legitimate?

LINUX:
sudo command logged
  bob : COMMAND=/bin/bash
  → User ran command as root
  → Check: Is this user authorized for sudo?

su command logged
  session opened for user root by bob
  → User switched to root
  → Check: Should this user have root access?
```

### Advanced Attack Detection

**Kerberos attacks:**

```
KERBEROS ATTACK INDICATORS:

PASS-THE-HASH:
─────────────────────────────────────────────
Event 4624 - Logon Type 9 (NewCredentials)
OR
Event 4776 - NTLM authentication
WHERE:
  - User = Domain Admin
  - Source = Non-DC server
  
→ Credentials used outside normal context

PASS-THE-TICKET:
─────────────────────────────────────────────
Event 4768 - TGT Request
WHERE:
  - Account Name doesn't match computer name
  - Certificate information missing
  
→ Forged ticket potentially in use

GOLDEN TICKET:
─────────────────────────────────────────────
Event 4769 - Service Ticket Request
WHERE:
  - Domain Controller didn't issue corresponding 4768
  - Account name = krbtgt
  
→ Attacker may have domain dominance

KERBEROASTING:
─────────────────────────────────────────────
Many 4769 events
WHERE:
  - Service accounts requested
  - Encryption = RC4 (weak)
  - Single source user
  
→ Attempting to crack service account passwords
```

### Behavioral Analysis

**Context matters:**

```
BEHAVIORAL INDICATORS:

IMPOSSIBLE TRAVEL:
─────────────────────────────────────────────
Login: alice - New York - 08:00
Login: alice - Tokyo - 08:30
Physical travel: ~14 hours

→ One of these is not alice

UNUSUAL TIMING:
─────────────────────────────────────────────
Normal: alice logins 08:00-18:00 EST
Alert: alice login 03:00 EST Saturday

→ Either alice is working late or credential compromised

NEW LOCATION:
─────────────────────────────────────────────
Historical: alice always from 192.168.1.0/24
Alert: alice from 203.0.113.0/24 (new subnet)

→ Could be VPN, could be compromise

FIRST-TIME ACCESS:
─────────────────────────────────────────────
Alert: alice accessed file-server-finance first time
Context: alice is in Marketing

→ Lateral movement or job change?
```

### Building Auth Detection Rules

**Practical detection logic:**

```
DETECTION RULE EXAMPLES:

RULE: Brute Force Success
─────────────────────────────────────────────
SELECT * FROM auth_logs
WHERE user IN (
  SELECT user FROM auth_logs
  WHERE status = 'failure'
  GROUP BY user, source_ip, 5min_window
  HAVING COUNT(*) > 10
)
AND status = 'success'
AND timestamp WITHIN 10min OF last_failure

RULE: Service Account Interactive Login
─────────────────────────────────────────────
SELECT * FROM auth_logs
WHERE account_name LIKE 'svc_%'
AND logon_type IN (2, 10)  -- Interactive or RDP
-- Service accounts shouldn't do interactive logins

RULE: Admin Used Outside Normal Hours
─────────────────────────────────────────────
SELECT * FROM auth_logs
WHERE privileges = 'admin'
AND (HOUR(timestamp) < 7 OR HOUR(timestamp) > 19)
AND DAY(timestamp) NOT IN ('Saturday', 'Sunday')
```

---

## 3. Guided Practice

### Exercise 1: Log Analysis

Analyze these auth events:

```
08:00:01 4625 Failed - admin - 192.168.1.50
08:00:02 4625 Failed - admin - 192.168.1.50
08:00:03 4625 Failed - admin - 192.168.1.50
... (45 more failures)
08:01:00 4624 Success - admin - 192.168.1.50
08:01:30 4672 Special privileges assigned - admin
```

1. What attack pattern is this? ___
2. Was it successful? ___
3. What should be the immediate response? ___

### Exercise 2: Detection Rule Design

Design a rule to detect potential credential stuffing:

| Criteria | Value |
|----------|-------|
| Event type | ___ |
| Aggregation field | ___ |
| Time window | ___ |
| Threshold | ___ |

### Exercise 3: Event Correlation

You see:
- 4624 Type 10 (RDP) from unknown IP
- 4672 (Admin privileges) 
- 4688 (Process creation: powershell.exe)

How would you investigate? List steps:

1. ___
2. ___
3. ___

---

## 4. Reflection Check

### Detection Understanding
1. Why isn't every failed login an attack?

2. Single failed login from 50 different users - brute force or spray?

3. Admin logs in at 3 AM. Attack or normal?

### Attack Understanding
1. Attacker has valid credentials. How do authentication logs still help?

2. Pass-the-Hash bypasses password. What events still trigger?

3. Golden Ticket forges Kerberos. How might you detect it?

---

## 5. Key Misconceptions

**MYTH: "Failed logins always mean attack"**
REALITY: Users mistype passwords daily. Threshold-based detection with context matters.

**MYTH: "Successful login means legitimate user"**
REALITY: Attackers with stolen credentials log in successfully. Behavioral analysis needed.

**MYTH: "NTLM is legacy and unused"**
REALITY: NTLM still used in many environments. Often a red flag when unexpected.

**MYTH: "Admin logins are always investigated"**
REALITY: Alert fatigue from routine admin activity. Baseline normal behavior first.

**MYTH: "Two-factor defeats credential attacks"**
REALITY: 2FA helps but can be bypassed. Still need to monitor for anomalies.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Identify** critical authentication events (Windows/Linux)
2. **Distinguish** between brute force, stuffing, and spray attacks
3. **Analyze** logon types and their security implications
4. **Detect** privilege escalation in logs
5. **Apply** behavioral analysis to authentication events

---

## 7. Further Depth (Optional)

*   **Practice:** Build detection rules in ELK/Splunk
*   **Tool:** Learn Windows Event Forwarding (WEF)
*   **Research:** MITRE ATT&CK credential access techniques
*   **Lab:** Set up and analyze Kerberos attacks
