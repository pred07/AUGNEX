# Detection Logic Basics

## 1. Orientation

### What this module covers
This module covers the Boolean logic and query construction that powers security detections. Understanding how to build effective detection rules is fundamental to both detection engineering and threat hunting.

### Fit in the Learning Path
Simple pattern matching catches simple attacks. Sophisticated adversaries require sophisticated detection logic—sequences, correlations, and conditional logic. This module teaches the building blocks of detection engineering.

### Learning Objectives
By the end of this module, you will:
*   Construct compound detection queries
*   Implement stateful (sequence) detections
*   Apply thresholds and time windows
*   Understand detection performance implications

---

## 2. Core Content

### Mental Model: The Query is the Weapon

**How professionals think about this:**
A detection rule is a question you ask your data continuously. The quality of the question determines the quality of the answers. Vague questions produce noisy alerts. Precise questions catch attackers.

```
DETECTION LOGIC LEVELS:

LEVEL 1: SIMPLE MATCH
─────────────────────────────
"Did event X happen?"

WHERE process = "mimikatz.exe"

Result: Catches obvious attacks
Problem: Attacker renames file

LEVEL 2: COMPOUND CONDITIONS
─────────────────────────────
"Did event X happen with conditions Y and Z?"

WHERE process = "cmd.exe"
  AND parent = "winword.exe"
  AND user_type = "standard"

Result: More specific, fewer false positives
Problem: Still single-event focused

LEVEL 3: SEQUENCES
─────────────────────────────
"Did event A happen, THEN event B happen?"

WHERE event_a = "user_created"
  FOLLOWED BY event_b = "added_to_admins"
  WITHIN 5 minutes

Result: Catches multi-step attacks
Problem: Performance cost

LEVEL 4: CORRELATIONS
─────────────────────────────
"Did events from multiple sources indicate attack?"

WHERE endpoint_alert = "suspicious_process"
  AND network_alert = "c2_beacon"
  ON same_host WITHIN 10 minutes

Result: High confidence, low FP
Problem: Complex to build and maintain
```

### Boolean Operators

**Fundamental logic:**

```
DETECTION OPERATORS:

AND (Both conditions must be true):
─────────────────────────────
process == "powershell.exe" AND commandline CONTAINS "-enc"

True only if:
- Process is PowerShell
- AND commandline has encoded flag

OR (Either condition can be true):
─────────────────────────────
process == "cmd.exe" OR process == "powershell.exe"

True if:
- Process is cmd
- OR process is PowerShell

NOT (Exclude matches):
─────────────────────────────
process == "powershell.exe" AND NOT user IN known_admins

True if:
- Process is PowerShell
- AND user is NOT in admin list

COMBINING:
─────────────────────────────
(process == "cmd.exe" OR process == "powershell.exe")
AND parent == "winword.exe"
AND NOT path CONTAINS "system32"

Order of operations matters!
Use parentheses for clarity
```

### Comparison Operators

**Matching conditions:**

| Operator | Meaning | Example |
|----------|---------|---------|
| `==` | Equals | `port == 22` |
| `!=` | Not equals | `status != 200` |
| `>` | Greater than | `bytes > 1000000` |
| `<` | Less than | `count < 5` |
| `>=` | Greater or equal | `failures >= 10` |
| `CONTAINS` | Substring match | `cmdline CONTAINS "-exec bypass"` |
| `STARTSWITH` | Prefix match | `url STARTSWITH "http://"` |
| `ENDSWITH` | Suffix match | `filename ENDSWITH ".exe"` |
| `MATCHES` | Regex match | `domain MATCHES "^[a-z0-9]{8}\.com$"` |
| `IN` | List membership | `port IN [22, 23, 3389]` |
| `LIKE` | Wildcard match | `path LIKE "*\temp\*"` |

### Thresholds and Aggregations

**Count-based detection:**

```
THRESHOLD DETECTION:

SIMPLE THRESHOLD:
─────────────────────────────
COUNT(failed_login) > 10
WHERE user = target_user
WITHIN 5 minutes

Triggers only if threshold exceeded

AGGREGATION FUNCTIONS:
─────────────────────────────
COUNT()   - Number of events
SUM()     - Total of numeric field
AVG()     - Average of numeric field
MIN()     - Minimum value
MAX()     - Maximum value
DISTINCT()- Unique values

EXAMPLES:

Brute force:
COUNT(failed_login) > 100 WITHIN 10 minutes

Data exfiltration:
SUM(bytes_out) > 1GB WITHIN 1 hour

Password spray:
DISTINCT(target_user) > 50 
WHERE source_ip = attacker_ip
WITHIN 30 minutes

Rate anomaly:
COUNT(event) > 10 * AVG(count_baseline)
```

### Time Windows

**Temporal constraints:**

```
TIME WINDOW CONCEPTS:

TUMBLING WINDOW:
─────────────────────────────
Fixed-size, non-overlapping windows

|──5min──|──5min──|──5min──|
Events counted in each window independently

Use: Simple counting, periodic aggregation

SLIDING WINDOW:
─────────────────────────────
Overlapping windows that move with each event

|──5min──|
   |──5min──|
      |──5min──|

Use: Continuous monitoring, immediate detection

SESSION WINDOW:
─────────────────────────────
Variable size based on activity gaps

|───activity───|gap|──activity──|gap|──act──|

Use: User behavior sessions, attack campaigns

EXAMPLE RULES:

"More than 10 failed logins in 5 minutes":
Tumbling: Resets every 5 minutes
Sliding: 5 minute window moves with each login

Impact:
Tumbling: 5 logins at 4:59, 5 at 5:01 = 2 windows, no alert
Sliding: Same scenario = 10 in window, ALERT
```

### Sequence Detection

**Multi-event patterns:**

```
SEQUENCE RULE STRUCTURE:

SEQUENCE (
    event_a: eventType = "user_created"
    event_b: eventType = "group_added" 
             AND group = "Domain Admins"
)
WHERE event_a.user == event_b.target_user
WITHIN 1 hour
BY source_host

COMPONENTS:
─────────────────────────────
SEQUENCE:  Events must occur in order
event_a:   First event definition
event_b:   Second event definition
WHERE:     Correlation conditions
WITHIN:    Maximum time between events
BY:        Grouping field (per-host, per-user)

EXAMPLES:

Privilege Escalation:
SEQUENCE (
    a: process = "cmd.exe" AND user = "standard"
    b: process = "whoami.exe" AND output = "SYSTEM"
)
WITHIN 1 minute

Lateral Movement:
SEQUENCE (
    a: eventType = "authentication_success"
    b: eventType = "remote_execution"
)
WHERE a.target_host == b.source_host
WITHIN 15 minutes

Attack Chain:
SEQUENCE (
    a: eventType = "phishing_click"
    b: eventType = "malware_download"
    c: eventType = "persistence_created"
    d: eventType = "c2_beacon"
)
BY target_user
WITHIN 24 hours
```

### Performance Considerations

**Making rules efficient:**

```
PERFORMANCE OPTIMIZATION:

HIGH COST OPERATIONS:
─────────────────────────────
- Regex matching (MATCHES)
- Lookbacks (WITHIN very long time)
- Many OR conditions
- No index-friendly fields

OPTIMIZATION STRATEGIES:

1. FILTER EARLY
   Bad:  MATCHES ".*malware.*" WHERE source = "EDR"
   Good: WHERE source = "EDR" AND MATCHES ".*malware.*"
   
2. USE INDEXED FIELDS
   Bad:  WHERE commandline CONTAINS "mimikatz"
   Good: WHERE process_hash IN known_bad_hashes

3. LIMIT LOOKBACK
   Bad:  WITHIN 7 days
   Good: WITHIN 1 hour (if attack permits)

4. AVOID WILDCARDS AT START
   Bad:  path LIKE "*mimikatz*"
   Good: path LIKE "C:\Windows\Temp\*"

5. PRE-AGGREGATE
   Instead of: COUNT(*) > 10 WITHIN 1 hour
   Use: Pre-computed 5-minute counts, then COUNT(buckets) > 2
```

### Detection Rule Template

**Standard structure:**

```
DETECTION RULE FORMAT:

METADATA:
─────────────────────────────
Name: Suspicious PowerShell Execution
ID: DETECT-0042
Severity: Medium
MITRE: T1059.001
Author: Detection Team
Last Updated: 2024-01-15
Description: Detects PowerShell with encoded commands
             launched from Office applications

RULE LOGIC:
─────────────────────────────
WHERE process_name = "powershell.exe"
  AND (
    commandline CONTAINS "-enc"
    OR commandline CONTAINS "-EncodedCommand"
  )
  AND parent_name IN [
    "winword.exe",
    "excel.exe",
    "outlook.exe"
  ]
  AND user NOT IN known_power_users

TUNING NOTES:
─────────────────────────────
- Whitelist user_list_1 (approved macro users)
- Exclude host_list_1 (development machines)
- Last tuned: 2024-01-10

RESPONSE:
─────────────────────────────
1. Isolate endpoint
2. Capture memory dump
3. Contact user
4. Escalate if confirmed malicious
```

---

## 3. Guided Practice

### Exercise 1: Build a Brute Force Rule

Requirements:
- Detect more than 20 failed logins
- From same source IP
- Within 5 minutes
- Exclude known scanner IPs

Write the rule:
```
___
```

### Exercise 2: Sequence Detection

Create a rule for: "User downloads file, then executes it within 10 minutes"

```
SEQUENCE (
    event_a: ___
    event_b: ___
)
WHERE ___
WITHIN ___
```

### Exercise 3: Optimization

Which version is more efficient and why?

Version A:
```
WHERE commandline MATCHES ".*password.*"
  AND source = "Windows"
```

Version B:
```
WHERE source = "Windows"
  AND commandline CONTAINS "password"
```

Answer: ___

---

## 4. Reflection Check

### Logic Understanding
1. Rule uses `OR`. When might this cause problems?

2. Threshold is 10 failures. Attacker does 9. Detection?

3. Sequence requires A then B. Attack does B then A. Detected?

### Performance Understanding
1. Rule takes 30 seconds to execute. Problem?

2. Lookback is 30 days. What's the cost?

3. Regex vs CONTAINS. When use each?

---

## 5. Key Misconceptions

**MYTH: "Complex rules are better rules"**
REALITY: Complexity adds cost and maintenance burden. Simple, focused rules are often more effective.

**MYTH: "Thresholds prevent false positives"**
REALITY: Thresholds also prevent true positives. Low-and-slow attacks bypass thresholds.

**MYTH: "Sequence detection catches attack chains"**
REALITY: Attackers don't follow scripts. Flexible timing and order variations may evade sequences.

**MYTH: "Regex is the most powerful matching"**
REALITY: Regex is expensive. Use simpler operators when possible.

**MYTH: "If the rule doesn't fire, it's working"**
REALITY: Silent rules may mean no attacks OR broken detection. Test regularly.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Construct** compound Boolean conditions
2. **Implement** threshold-based detection
3. **Build** sequence detection rules
4. **Apply** time windows appropriately
5. **Optimize** rules for performance

---

## 7. Further Depth (Optional)

*   **Practice:** Build detection rules in your SIEM
*   **Tool:** Explore Sigma rule format
*   **Methodology:** Detection engineering maturity model
*   **Lab:** Test rules against attack simulations
