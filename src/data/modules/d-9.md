# Windows Logging Fundamentals

## 1. Orientation

### What this module covers
This module dives deep into Windows Event Logging—the structured logging system used across all Windows environments. Understanding Windows logs is essential because Windows dominates enterprise environments, and most incidents involve Windows systems.

### Fit in the Learning Path
Windows is the corporate standard—approximately 75% of enterprise desktops and many servers run Windows. Understanding Windows Event Logs is fundamental for SOC analysts, incident responders, and penetration testers alike.

### Learning Objectives
By the end of this module, you will:
*   Navigate Windows Event Viewer effectively
*   Understand log channels and their purposes
*   Memorize critical Security Event IDs
*   Apply filters to find relevant events efficiently

---

## 2. Core Content

### Mental Model: Windows Logging Architecture

**How professionals think about this:**
Windows Event Logging is structured, XML-based, and channel-organized. Every security-relevant action generates events. The challenge is knowing which events matter and where to find them.

```
WINDOWS EVENT LOG ARCHITECTURE:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  EVENT PROVIDERS                                                    │
│  (Applications, Services, OS Components)                            │
│     │                                                               │
│     │ Generate events                                               │
│     ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  WINDOWS EVENT LOG SERVICE                                  │   │
│  │  (Receives, routes, stores events)                          │   │
│  └────────────────────────────┬────────────────────────────────┘   │
│                               │                                     │
│               ┌───────────────┼───────────────┐                     │
│               │               │               │                     │
│               ▼               ▼               ▼                     │
│       ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐      │
│       │  SECURITY   │ │   SYSTEM    │ │    APPLICATION      │      │
│       │   .evtx     │ │    .evtx    │ │       .evtx         │      │
│       │             │ │             │ │                     │      │
│       │ Auth events │ │ OS events   │ │ App events          │      │
│       │ Audit policy│ │ Drivers     │ │ Crashes             │      │
│       │ Access logs │ │ Services    │ │ Installations       │      │
│       └─────────────┘ └─────────────┘ └─────────────────────┘      │
│               │               │               │                     │
│               └───────────────┼───────────────┘                     │
│                               │                                     │
│                               ▼                                     │
│                    %SystemRoot%\System32\winevt\Logs\               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Event Log Channels

**The Big Three:**

| Channel | Purpose | Security Relevance |
|---------|---------|-------------------|
| **Security** | Authentication, authorization, audit | PRIMARY security log |
| **System** | OS components, services, drivers | Persistence detection |
| **Application** | Software events, crashes | App exploitation |

**Extended channels (critical for security):**

```
ADDITIONAL SECURITY CHANNELS:

Microsoft-Windows-Sysmon/Operational
└── Process creation, network connections, file changes
└── NOT installed by default but essential for security

Microsoft-Windows-PowerShell/Operational
└── PowerShell execution, script blocks
└── CRITICAL for attack detection

Microsoft-Windows-Windows Defender/Operational
└── Malware detections, scan results

Microsoft-Windows-TerminalServices-LocalSessionManager/Operational
└── RDP session details

Microsoft-Windows-TaskScheduler/Operational
└── Scheduled task creation/execution (persistence!)

Microsoft-Windows-Windows Firewall With Advanced Security/Firewall
└── Firewall rule changes, blocked connections
```

### Event Structure

**Anatomy of a Windows event:**

```xml
EVENT STRUCTURE (XML):

<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
  <System>
    <Provider Name="Microsoft-Windows-Security-Auditing" 
              Guid="{54849625-5478-4994-a5ba-3e3b0328c30d}"/>
    <EventID>4624</EventID>
    <Version>2</Version>
    <Level>0</Level>
    <Task>12544</Task>
    <Opcode>0</Opcode>
    <Keywords>0x8020000000000000</Keywords>
    <TimeCreated SystemTime="2024-01-15T10:30:00.123456789Z"/>
    <EventRecordID>12345678</EventRecordID>
    <Correlation/>
    <Execution ProcessID="500" ThreadID="4472"/>
    <Channel>Security</Channel>
    <Computer>WORKSTATION01</Computer>
    <Security/>
  </System>
  <EventData>
    <Data Name="SubjectUserSid">S-1-5-18</Data>
    <Data Name="SubjectUserName">SYSTEM</Data>
    <Data Name="TargetUserName">Administrator</Data>
    <Data Name="LogonType">10</Data>
    <Data Name="IpAddress">192.168.1.100</Data>
    <!-- More fields... -->
  </EventData>
</Event>

KEY FIELDS:
- EventID: The event type identifier
- TimeCreated: When it happened (UTC)
- Computer: Source system name
- EventData: The actual details (varies by event type)
```

### Critical Security Event IDs

**Authentication events (MEMORIZE THESE):**

| Event ID | Description | What to Look For |
|----------|-------------|------------------|
| **4624** | Successful logon | Type 10 = RDP, Type 3 = Network |
| **4625** | Failed logon | Brute force (many from same IP) |
| **4634** | Logoff | Session duration analysis |
| **4648** | Explicit credential logon | Runas, pass-the-hash |
| **4672** | Special privileges assigned | Admin logon |
| **4776** | NTLM auth attempt | Pass-the-hash attacks |

**Logon Types (Event 4624):**

```
LOGON TYPE REFERENCE:

Type 2  - Interactive
          └── Physical keyboard logon
          
Type 3  - Network
          └── File share, remote services
          └── MOST COMMON (thousands daily)
          
Type 4  - Batch
          └── Scheduled task execution
          
Type 5  - Service
          └── Service account logon
          
Type 7  - Unlock
          └── Workstation unlock
          
Type 10 - RemoteInteractive
          └── RDP session
          └── HIGH INTEREST for lateral movement
          
Type 11 - CachedInteractive
          └── Cached credential (offline domain logon)
```

**Account management events:**

| Event ID | Description | Threat Indicator |
|----------|-------------|------------------|
| **4720** | User account created | Backdoor account |
| **4726** | User account deleted | Covering tracks |
| **4722** | User account enabled | Re-enabled backdoor |
| **4723** | Password change attempt | Password spray? |
| **4724** | Password reset by admin | Potential takeover |
| **4728** | User added to global group | Privilege escalation |
| **4732** | User added to local group | Local admin added |
| **4756** | User added to universal group | Domain privilege escalation |

**Critical detection events:**

| Event ID | Description | Severity |
|----------|-------------|----------|
| **1102** | Audit log cleared | CRITICAL - Attacker covering tracks |
| **4697** | Service installed | HIGH - Potential persistence |
| **7045** | Service installed (System log) | HIGH - Persistence |
| **4698** | Scheduled task created | HIGH - Persistence |
| **4688** | Process creation | Need Sysmon for command line |
| **4104** | PowerShell script block logging | Attack scripts |

### Sysmon Enhancement

**Why Sysmon is essential:**

```
SYSMON CRITICAL EVENTS:

Event ID 1 - Process Creation
└── Full command line! (4688 often lacks this)
└── Parent process tracking
└── File hashes

Event ID 3 - Network Connection
└── Process-to-IP mapping
└── C2 detection

Event ID 7 - Image Loaded
└── DLL loading
└── DLL hijacking detection

Event ID 8 - CreateRemoteThread
└── Process injection detection

Event ID 10 - Process Access
└── Credential dumping (LSASS access)

Event ID 11 - File Create
└── Malware drop detection

Event ID 13 - Registry Value Set
└── Persistence mechanisms

WITHOUT SYSMON:
- No command-line logging (4688)
- No network-to-process mapping
- No file hash correlation
- Missing critical attack indicators

RECOMMENDATION: Install Sysmon with SwiftOnSecurity config
```

### Audit Policy

**Enabling detailed logging:**

```powershell
# View current audit policy
auditpol /get /category:*

# Critical categories to enable:
auditpol /set /subcategory:"Logon" /success:enable /failure:enable
auditpol /set /subcategory:"Logoff" /success:enable
auditpol /set /subcategory:"Account Lockout" /success:enable /failure:enable
auditpol /set /subcategory:"Process Creation" /success:enable
auditpol /set /subcategory:"Detailed File Share" /success:enable
auditpol /set /subcategory:"Security Group Management" /success:enable /failure:enable
auditpol /set /subcategory:"User Account Management" /success:enable /failure:enable

# Enable command line in process creation (GPO preferred)
# Computer Configuration → Policies → Administrative Templates → 
# System → Audit Process Creation → Include command line
```

### Using Event Viewer

**Navigation:**

```
EVENT VIEWER WORKFLOW:

1. OPEN: Win+R → eventvwr.msc

2. NAVIGATE:
   Windows Logs
   ├── Application
   ├── Security      ← PRIMARY FOR SECURITY
   ├── Setup
   ├── System        ← SECONDARY FOR SECURITY
   └── Forwarded Events

   Applications and Services Logs
   ├── Microsoft
   │   └── Windows
   │       ├── PowerShell   ← CRITICAL
   │       ├── Sysmon       ← IF INSTALLED
   │       └── TaskScheduler ← PERSISTENCE

3. FILTER:
   Right-click → Filter Current Log
   
   By Event ID: 4624
   By Time: Last 24 hours
   By Source: Microsoft-Windows-Security-Auditing
   By Keyword: Success or Failure

4. EXPORT:
   Right-click → Save All Events As...
   Format: .evtx (native) or .xml/.csv (for analysis)
```

### PowerShell Log Analysis

**Command-line analysis:**

```powershell
# Get recent security events
Get-WinEvent -LogName Security -MaxEvents 100

# Filter by Event ID
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625} -MaxEvents 50

# Failed logins in last hour
$StartTime = (Get-Date).AddHours(-1)
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625; StartTime=$StartTime}

# Extract specific fields
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4624} -MaxEvents 10 | 
  ForEach-Object {
    $xml = [xml]$_.ToXml()
    [PSCustomObject]@{
      Time = $_.TimeCreated
      User = ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'TargetUserName'}).'#text'
      LogonType = ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'LogonType'}).'#text'
      SourceIP = ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'IpAddress'}).'#text'
    }
  }

# Count failed logins by IP
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625} | 
  ForEach-Object {
    $xml = [xml]$_.ToXml()
    ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'IpAddress'}).'#text'
  } | Group-Object | Sort-Object Count -Descending
```

---

## 3. Guided Practice

### Exercise 1: Event Viewer Navigation

Open Event Viewer and:

1. Navigate to Security log
2. Find Event ID 4624 (if any)
3. Record: User, Logon Type, Source IP (if available)

Findings: ___

### Exercise 2: Event ID Recognition

Match the Event ID to its meaning:

| Event ID | Meaning |
|----------|---------|
| 4624 | ___ |
| 4625 | ___ |
| 7045 | ___ |
| 1102 | ___ |
| 4720 | ___ |

### Exercise 3: Filter Creation

Create a filter to find:
- All failed logins (4625) in the last 24 hours

Steps:
1. ___
2. ___
3. ___

Number of events found: ___

---

## 4. Reflection Check

### Technical Understanding
1. Logon Type 3 appears thousands of times daily. Why isn't each one an alert?

2. Why is Event ID 1102 (Audit log cleared) considered critical?

3. Standard Windows logging doesn't include command lines in process creation events. Why is this a problem?

### Practical Thinking
1. You're investigating a suspected breach. The security log has been cleared. What now?

2. Why might a SIEM send Windows events off-server within minutes of generation?

3. An attacker uses RDP to access a server. What Event IDs would you look for?

---

## 5. Key Misconceptions

**MYTH: "Windows logs everything by default"**
REALITY: Default audit policy is minimal. Enhanced auditing must be configured via GPO or auditpol.

**MYTH: "Event 4688 shows command lines"**
REALITY: Command line logging requires explicit configuration. Use Sysmon for reliable command line capture.

**MYTH: "Security log is enough for investigations"**
REALITY: Many critical events are in System, PowerShell, or Sysmon logs. All are needed.

**MYTH: "Log size just needs to be 'big enough'"**
REALITY: Windows logs are circular by default. Full logs overwrite old events. Forward logs before they're lost.

**MYTH: "Event ID memorization isn't necessary"**
REALITY: Quick recognition of 4624, 4625, 4720, 1102, 7045 speeds investigation dramatically.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Navigate** Event Viewer to find Security events
2. **Identify** the three main log channels
3. **Recognize** critical Event IDs (4624, 4625, 7045, 1102)
4. **Explain** Logon Types and their meaning
5. **Understand** why Sysmon is essential

---

## 7. Further Depth (Optional)

*   **Tool:** Install Sysmon with SwiftOnSecurity configuration
*   **Practice:** Create PowerShell scripts for log analysis
*   **Reference:** SANS Windows Logging Cheat Sheet
*   **Research:** Windows Event Forwarding (WEF) for centralization
