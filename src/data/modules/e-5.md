# Threat Modeling and Attack Surface Mapping

## 1. Orientation

### What this module covers
This module teaches systematic thinking before action. Threat modeling identifies what could go wrong and prioritizes where to focus; attack surface mapping defines all the ways an attacker could interact with a system. These skills separate thoughtful professionals from random button-pushers.

### Fit in the Learning Path
A skilled penetration tester spends 80% of their time in planning and reconnaissance, 20% in execution. If you skip threat modeling, you attack blindly—missing critical vectors while wasting time on dead ends.

### Learning Objectives
By the end of this module, you will:
*   Define and map attack surfaces systematically
*   Apply the STRIDE threat model to any system
*   Create simple threat models for target applications
*   Prioritize testing efforts based on threat analysis

---

## 2. Core Content

### Mental Model: Think Before You Hack

**How professionals think about this:**
Before touching a keyboard, skilled attackers build a mental (or actual) model of the target. They ask: What assets matter? What are all the possible entry points? What threats are most likely? This thinking maximizes impact and efficiency.

```
THE PLANNING ADVANTAGE:

Undirected Testing:              Threat Modeling First:
┌────────────────────┐          ┌────────────────────┐
│ • Try SQLi here    │          │ 1. Map all inputs  │
│ • XSS there        │          │ 2. Identify assets │
│ • Nmap everything  │          │ 3. Apply STRIDE    │
│ • Miss API entirely│          │ 4. Prioritize      │
│ • Waste time on    │          │ 5. Test highest    │
│   hardened areas   │          │    risk first      │
│                    │          │                    │
│ Coverage: Random   │          │ Coverage: Complete │
│ Efficiency: Poor   │          │ Efficiency: High   │
└────────────────────┘          └────────────────────┘
```

### Attack Surface: Everything That Can Be Attacked

**Definition:**
The attack surface is the sum of all points where an attacker can attempt to enter data, extract data, or interact with the system.

**Categories of attack surface:**

| Category | Examples | Typical Vulnerabilities |
|----------|----------|------------------------|
| **Network** | Open ports, services | Service exploits, misconfigurations |
| **Application** | Web forms, APIs, file uploads | Injection, authentication flaws |
| **Human** | Employees, contractors | Phishing, social engineering |
| **Physical** | Network jacks, USB ports | Physical access attacks |
| **Supply Chain** | Third-party libraries, services | Dependency vulnerabilities |

**Mapping attack surface:**

```
ATTACK SURFACE DECOMPOSITION:

Target: E-commerce Website

NETWORK SURFACE:
├── Port 443 (HTTPS)
├── Port 22 (SSH - internal only?)
├── Port 3306 (MySQL - should not be exposed)
└── CDN edge nodes

APPLICATION SURFACE:
├── User registration
│   ├── Username field
│   ├── Email field
│   ├── Password field
│   └── CAPTCHA
├── Login
│   ├── Username/password
│   ├── Password reset
│   └── MFA (if any)
├── Product search
│   ├── Search query
│   └── Category filters
├── Shopping cart
│   ├── Quantity field
│   ├── Coupon code
│   └── Price (client-side?)
├── Checkout
│   ├── Shipping address
│   ├── Payment processing
│   └── Order confirmation
├── Admin panel (if discoverable)
└── APIs
    ├── REST endpoints
    ├── GraphQL (if any)
    └── WebSocket connections

HUMAN SURFACE:
├── Customer support
├── IT administrators
└── Third-party vendors

DATA FLOWS:
├── User → Web Server → Database
├── User → Payment Gateway → Bank
└── Admin → VPN → Internal Network
```

### STRIDE: Microsoft's Threat Model

**A systematic framework for identifying threats:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                           STRIDE                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  S - SPOOFING                                                       │
│      "Can I pretend to be someone/something I'm not?"               │
│      Examples: Session hijacking, credential theft, IP spoofing    │
│                                                                     │
│  T - TAMPERING                                                      │
│      "Can I modify data I shouldn't?"                               │
│      Examples: Parameter manipulation, file modification, MITM     │
│                                                                     │
│  R - REPUDIATION                                                    │
│      "Can I deny I performed an action?"                            │
│      Examples: Missing logs, unsigned transactions                 │
│                                                                     │
│  I - INFORMATION DISCLOSURE                                         │
│      "Can I access data I shouldn't?"                               │
│      Examples: Directory listing, error messages, SQL injection    │
│                                                                     │
│  D - DENIAL OF SERVICE                                              │
│      "Can I prevent legitimate use?"                                │
│      Examples: Resource exhaustion, crash bugs, account lockout    │
│                                                                     │
│  E - ELEVATION OF PRIVILEGE                                         │
│      "Can I gain more access than allowed?"                         │
│      Examples: Privilege escalation, IDOR, broken access control   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**STRIDE by target:**

| Component | Likely STRIDE Threats |
|-----------|----------------------|
| User authentication | S, T, I, E |
| Database | T, I, E |
| API endpoints | All STRIDE |
| Session management | S, T, R |
| File upload | T, I, E |
| Logging system | R |
| External services | S, I, D |

### Building a Threat Model

**Step-by-step process:**

```
THREAT MODELING WORKFLOW:

1. DEFINE SCOPE
   └── What system/component are we modeling?

2. CREATE DATA FLOW DIAGRAM (DFD)
   ├── Actors (users, external systems)
   ├── Processes (web server, API, database)
   ├── Data stores (database, files, cache)
   └── Data flows (arrows between components)

3. IDENTIFY ASSETS
   └── What has value? (user data, credentials, money)

4. IDENTIFY THREATS
   └── Apply STRIDE to each component

5. RATE RISKS
   └── Likelihood × Impact = Priority

6. DETERMINE MITIGATIONS
   └── What controls exist? What's missing?

7. PRIORITIZE TESTING
   └── Focus on highest risk first
```

**Simple DFD example:**

```
┌──────────┐       HTTPS        ┌──────────────┐      SQL       ┌──────────┐
│          │───────────────────►│              │───────────────►│          │
│   User   │                    │  Web Server  │                │ Database │
│          │◄───────────────────│              │◄───────────────│          │
└──────────┘                    └──────────────┘                └──────────┘
                                       │
                                       │ API calls
                                       ▼
                                ┌──────────────┐
                                │   Payment    │
                                │   Gateway    │
                                └──────────────┘

STRIDE ANALYSIS:

User → Web Server:
  S: Session hijacking, credential stuffing
  T: Parameter tampering, request modification
  I: Response contains sensitive data
  D: Application-layer DoS

Web Server → Database:
  S: SQL injection bypasses auth
  T: SQL injection modifies data
  I: SQL injection extracts data
  E: Database user has excessive privileges

Web Server → Payment Gateway:
  S: Request forgery to payment system
  T: Transaction amount manipulation
  I: API key leakage
  D: Blocking payment processing
```

### Attack Surface Reduction

**The defensive perspective:**

| Principle | Implementation |
|-----------|---------------|
| Minimize entry points | Close unused ports, disable unused features |
| Reduce complexity | Simpler systems have fewer vulnerabilities |
| Principle of least privilege | Users/services only get required access |
| Defense in depth | Multiple layers, not single points of failure |
| Secure defaults | Safe configuration out of the box |

**Questions to ask:**
- Is this port/service/feature necessary?
- What's the minimum access required?
- What happens if this component is compromised?
- Are there unnecessary exposed endpoints?

### Prioritizing Attack Vectors

**Risk-based prioritization:**

| Factor | High Priority | Low Priority |
|--------|--------------|--------------|
| **Asset value** | Customer PII, payment data | Marketing content |
| **Exposure** | Internet-facing | Internal only |
| **Complexity** | Simple attack | Requires chained exploits |
| **Likelihood** | Known vulnerable | No known issues |
| **Detection** | Low visibility | Well-monitored |

**Testing priority matrix:**
```
                    HIGH IMPACT
                         │
    ┌────────────────────┼────────────────────┐
    │                    │                    │
    │  CRITICAL:         │   HIGH:            │
    │  Test immediately  │   Test early       │
    │                    │                    │
HIGH├────────────────────┼────────────────────┤LOW
LIKE│                    │                    │LIKE
    │                    │                    │
    │  MEDIUM:           │   LOW:             │
    │  Test if time      │   Test last        │
    │                    │                    │
    └────────────────────┼────────────────────┘
                         │
                    LOW IMPACT
```

---

## 3. Guided Practice

### Exercise 1: STRIDE a Login Page

Apply STRIDE to a standard login form:

| Threat | Attack Example | Test Approach |
|--------|---------------|---------------|
| Spoofing | ___ | ___ |
| Tampering | ___ | ___ |
| Repudiation | ___ | ___ |
| Information Disclosure | ___ | ___ |
| Denial of Service | ___ | ___ |
| Elevation of Privilege | ___ | ___ |

### Exercise 2: Attack Surface Mapping

For a REST API for a mobile banking app, list the attack surface:

**Input points:**
1. ___
2. ___
3. ___
4. ___

**Authentication surface:**
1. ___
2. ___

**Data access points:**
1. ___
2. ___

### Exercise 3: Prioritization

Given these findings, prioritize for testing:

| Finding | Priority | Justification |
|---------|----------|---------------|
| Admin panel at /admin (internet-facing) | ___ | ___ |
| Internal monitoring dashboard | ___ | ___ |
| File upload for user avatars | ___ | ___ |
| Legacy API endpoint (documented deprecated) | ___ | ___ |

---

## 4. Reflection Check

### Threat Modeling Mindset
1. Why is threat modeling done before testing begins?

2. A system has 50 potential input points. How do you decide which to test first?

3. The STRIDE threat "Repudiation" is often overlooked. Why does it matter?

### Attack Surface Thinking
1. A company adds a new feature: social login with Google/Facebook. How does this change the attack surface?

2. You're testing an internal application with no external exposure. Is threat modeling still valuable?

3. "Defense in depth" suggests multiple layers. How does this relate to attack surface?

---

## 5. Key Misconceptions

**MYTH: "Threat modeling is for architects, not pentesters"**
REALITY: Pentesters who threat model first are more effective. It's planning before execution.

**MYTH: "More features = more value, always"**
REALITY: More features = more attack surface. Each feature is potential vulnerability surface.

**MYTH: "If it's not internet-facing, it's not attackable"**
REALITY: Internal systems are attacked via phishing, supply chain, and insider threats.

**MYTH: "STRIDE covers everything"**
REALITY: STRIDE is one framework. Others (PASTA, LINDDUN, etc.) add different perspectives.

**MYTH: "Attack surface mapping is a one-time activity"**
REALITY: Attack surface changes constantly as systems evolve. Update continuously.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Map** the attack surface of a given system
2. **Apply** STRIDE to identify threats systematically
3. **Create** a simple data flow diagram for an application
4. **Prioritize** testing based on risk assessment
5. **Explain** how attack surface reduction improves security

---

## 7. Further Depth (Optional)

*   **Framework:** Study PASTA (Process for Attack Simulation and Threat Analysis)
*   **Tool:** Experiment with Microsoft Threat Modeling Tool
*   **Practice:** Create threat models for real applications (your own or CTF targets)
*   **Research:** Study how cloud and microservices change attack surfaces
