# Detecting Suspicious Network Activity

## 1. Orientation

### What this module covers
This module covers advanced threat hunting techniques for network traffic—finding the subtle signals of Command and Control (C2), data exfiltration, and covert channels that evade signature-based detection.

### Fit in the Learning Path
This is threat hunting territory—looking for faint signals of stealthy adversaries who have bypassed perimeter defenses. These techniques find what signatures miss.

### Learning Objectives
By the end of this module, you will:
*   Detect beaconing patterns in network traffic
*   Identify C2 channels and covert communication
*   Recognize domain generation algorithms (DGA)
*   Find data exfiltration via tunneling

---

## 2. Core Content

### Mental Model: Finding the Machine

**How professionals think about this:**
Humans are random—they click, type, browse unpredictably. Machines are consistent—malware beacons at regular intervals, generates domains algorithmically, maintains persistent connections. Finding the machine behavior reveals the malware.

```
HUMAN vs MACHINE TRAFFIC:

HUMAN (Normal web browsing):
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  ●     ●●   ●      ●●●  ●   ●        ●●    ●  ●●●●●  ●             │
│  │     ││   │      │││  │   │        ││    │  │││││  │             │
│  └─────┴┴───┴──────┴┴┴──┴───┴────────┴┴────┴──┴┴┴┴┴──┴──           │
│                                                                     │
│  Random timing, varying destinations                               │
│  Bursts of activity, then quiet                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

MACHINE (Malware beaconing):
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  ●     ●     ●     ●     ●     ●     ●     ●     ●     ●           │
│  │     │     │     │     │     │     │     │     │     │           │
│  └─60s─┴─60s─┴─60s─┴─60s─┴─60s─┴─60s─┴─60s─┴─60s─┴─60s─┴           │
│                                                                     │
│  Regular interval, same destination                                │
│  Consistent timing = MACHINE                                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Beaconing Detection

**Finding C2 heartbeats:**

```
BEACON CHARACTERISTICS:

1. TIMING CONSISTENCY
   ─────────────────────────────
   Same interval between connections
   Even with jitter, pattern is detectable
   
   Perfect beacon: 60s, 60s, 60s, 60s...
   With 20% jitter: 55s, 62s, 48s, 67s, 58s...
   Still detectable: Average ~60s, low variance

2. DESTINATION CONSISTENCY
   ─────────────────────────────
   Same IP or domain repeatedly
   Often uncommon/new destinations
   
3. PAYLOAD CONSISTENCY
   ─────────────────────────────
   Similar packet sizes
   Often small (heartbeat) or same (checkin)
   
4. 24/7 ACTIVITY
   ─────────────────────────────
   Runs when humans don't
   Active at 3 AM on weekends
   Active during holidays
```

**Beacon detection methodology:**

```
BEACON DETECTION PROCESS:

STEP 1: AGGREGATE CONNECTIONS
Group by: Source → Destination

STEP 2: CALCULATE TIMING
For each pair, calculate:
- Time between connections
- Standard deviation of interval
- Jitter percentage

STEP 3: SCORE CONSISTENCY
Low jitter (< 10%) = High beacon score
Regular interval = High beacon score
24/7 activity = High beacon score

STEP 4: FILTER NOISE
Remove known-good:
- Windows Update
- Antivirus updates
- Cloud sync (OneDrive, Dropbox)
- Monitoring agents

STEP 5: INVESTIGATE TOP SCORES
High beacon scores + unknown destination = 
INVESTIGATE

MATHEMATICAL DETECTION:
─────────────────────────────
Coefficient of Variation (CV) = StdDev / Mean
CV < 0.1 = Very regular (likely beacon)
CV > 0.5 = Random (likely human)
```

### Domain Generation Algorithms (DGA)

**Detecting algorithmically generated domains:**

```
DGA CONCEPT:

WHY ATTACKERS USE DGA:
─────────────────────────────
Static C2: malware.evil.com
→ Blocked once discovered

DGA: Generates domains algorithmically
Day 1: a8f3k2x9.com
Day 2: j7m4n1l2.com
Day 3: p2q8r5s3.com
→ Must block infinite domains

DGA DETECTION:
─────────────────────────────
1. ENTROPY ANALYSIS
   Normal domain: google.com (low entropy)
   DGA domain: a8fk39xk2m.net (high entropy)
   
   Calculate Shannon entropy
   High entropy + unusual TLD = suspicious

2. CONSONANT/VOWEL RATIO
   Normal: "facebook" (balanced)
   DGA: "xkjqzxf" (all consonants)

3. N-GRAM ANALYSIS
   Normal domains follow linguistic patterns
   DGAs don't have "th", "ing", "tion"

4. MACHINE LEARNING
   Train classifier on known DGA samples
   Detect new DGA families

EXAMPLE DGA DOMAINS:
─────────────────────────────
qwery89x2.net     ← DGA (random)
update.microsoft.com  ← Legitimate
xk38fm2p9.info    ← DGA (random)
```

### Long Connections

**Finding tunnels and shells:**

```
LONG CONNECTION INDICATORS:

NORMAL CONNECTIONS:
─────────────────────────────
HTTP request: ~200ms
API call: ~50ms
File download: 1-30 seconds
Video stream: Up to hours (but known destinations)

SUSPICIOUS LONG CONNECTIONS:
─────────────────────────────
SSH to unknown IP: 4+ hours
HTTPS to unusual domain: Constant open
DNS over TCP: Persistent (DNS tunneling?)

REVERSE SHELL PATTERN:
─────────────────────────────
Victim → Attacker connection established
Connection stays open for hours
Small packets in both directions
Often on common ports (443, 80) to evade

DETECTION:
─────────────────────────────
Query: Connections > 1 hour duration
Filter: Known services (CDN, cloud apps)
Investigate: Unknown long-lived connections
```

### Covert Channels

**Data hidden in plain sight:**

```
COVERT CHANNEL TYPES:

1. DNS TUNNELING
   ─────────────────────────────
   Normal: Query A record for google.com
   Tunnel: Query TXT for "c2data.evil.com"
           Response contains encoded commands
   
   Detection indicators:
   - High DNS query volume to single domain
   - Long subdomain names (encoded data)
   - TXT record queries (uncommon)
   - NXDOMAIN responses (DGA probing)

2. ICMP TUNNELING
   ─────────────────────────────
   Normal: "ping google.com" (tiny data)
   Tunnel: Large ICMP payloads with hidden data
   
   Detection indicators:
   - ICMP packets > 100 bytes
   - Consistent ICMP to external IPs
   - ICMP to unusual destinations

3. HTTP/HTTPS TUNNELING
   ─────────────────────────────
   Normal: Standard web traffic
   Tunnel: Encoded data in POST bodies,
           Headers, or WebSocket connections
   
   Detection indicators:
   - POST requests with unusual sizes
   - Connections to new/uncategorized domains
   - WebSocket to non-standard services

4. PROTOCOL ANOMALIES
   ─────────────────────────────
   Port 443 but not TLS
   Port 80 but not HTTP
   Standard port, wrong protocol
```

### Tor and VPN Detection

**Anonymization networks:**

```
TOR DETECTION:

TOR INDICATOR 1: KNOWN EXITS
─────────────────────────────
Tor publishes exit node IPs
Check connections to/from these IPs
(Lists updated frequently)

TOR INDICATOR 2: TRAFFIC PATTERNS
─────────────────────────────
Tor uses TLS on port 443 or 9001
Circuit establishment patterns
Onion routing traffic characteristics

TOR INDICATOR 3: CERTIFICATE ANALYSIS
─────────────────────────────
Tor certificates have specific patterns
Check certificate fingerprints

VPN DETECTION:
─────────────────────────────
1. Known VPN provider IPs
2. Common VPN ports (1194/UDP, 443/TCP for OpenVPN)
3. IPSec/IKE traffic (ports 500, 4500)
4. WireGuard patterns (port 51820)

ANONYMOUS PROXY INDICATORS:
─────────────────────────────
- X-Forwarded-For headers
- Traffic to known proxy services
- Sudden change in apparent geo-location
```

### Threat Hunting with RITA

**Real Intelligence Threat Analytics:**

```
RITA ANALYSIS WORKFLOW:

STEP 1: IMPORT ZEEK LOGS
rita import --import-dir /logs --database company_logs

STEP 2: ANALYZE BEACONS
rita show-beacons company_logs
└── Shows source → dest pairs with beacon scores

STEP 3: ANALYZE LONG CONNECTIONS
rita show-long-connections company_logs
└── Shows connections by duration

STEP 4: ANALYZE DNS
rita show-dns-fqdns company_logs
└── Shows domains with high query volume

STEP 5: INVESTIGATE HIGH SCORES
┌─────────────────────────────────────────────────────────────────────┐
│ Score  │ Source           │ Destination      │ Connections │       │
├────────┼──────────────────┼──────────────────┼─────────────┤       │
│  0.95  │ 192.168.1.50     │ 45.33.32.156    │    8640     │ ← Investigate!
│  0.82  │ 192.168.1.30     │ cdn.update.com  │    2880     │ ← Probably update 
│  0.15  │ 192.168.1.100    │ google.com      │     350     │ ← Normal
└─────────────────────────────────────────────────────────────────────┘
```

### Detection Techniques Summary

| Indicator | Normal | Suspicious | Detection Method |
|-----------|--------|------------|------------------|
| **Timing** | Random intervals | Regular intervals | Beacon analysis |
| **Domain** | Known, readable | High entropy, random | DGA detection |
| **Duration** | Short (seconds) | Long (hours) | Connection duration |
| **DNS volume** | Low per domain | High to single domain | Query aggregation |
| **ICMP size** | Small (<100 bytes) | Large with data | Payload inspection |
| **Protocol** | Matches port | Mismatched | Protocol analysis |

---

## 3. Guided Practice

### Exercise 1: Beacon Analysis

Given this connection log:

```
10:00:00 192.168.1.50 → 45.33.32.156:443 (200 bytes)
10:01:02 192.168.1.50 → 45.33.32.156:443 (200 bytes)
10:02:01 192.168.1.50 → 45.33.32.156:443 (200 bytes)
10:03:00 192.168.1.50 → 45.33.32.156:443 (200 bytes)
10:03:59 192.168.1.50 → 45.33.32.156:443 (200 bytes)
```

1. Average interval: ___
2. Jitter estimate: ___
3. Beacon likelihood: ___

### Exercise 2: DGA Detection

Which domains are likely DGA?

| Domain | DGA? | Reason |
|--------|------|--------|
| login.microsoft.com | ___ | ___ |
| xk38fm2p9z.net | ___ | ___ |
| api-gateway.company.com | ___ | ___ |
| 9a8f7k2x5m.info | ___ | ___ |

### Exercise 3: Covert Channel

You notice:
- Host queries DNS 1000 times/hour for `*.data.evil.com`
- Each subdomain is 50+ characters: `aGVsbG8gd29ybGQ=.data.evil.com`

1. What type of channel is this? ___
2. What is the subdomain likely containing? ___
3. How would you investigate? ___

---

## 4. Reflection Check

### Detection Understanding
1. Attacker adds 50% jitter to beaconing. Still detectable? How?

2. DGA domain resolves to legitimate cloud IP. Still suspicious?

3. Long connection on port 443 to cloud provider. Attack or normal?

### Evasion Understanding
1. Why do attackers use DNS for C2 instead of HTTPS?

2. Tor exit nodes are blocked. How might attacker still reach Tor?

3. You block known VPN providers. What alternatives exist?

---

## 5. Key Misconceptions

**MYTH: "Beaconing is obvious to detect"**
REALITY: Sophisticated malware uses high jitter, domain fronting, and legitimate services to blend in.

**MYTH: "DGA detection catches all DGA"**
REALITY: Dictionary-based DGAs (real words) have low entropy and evade entropy-based detection.

**MYTH: "DNS tunneling is rare"**
REALITY: DNS is often the only protocol allowed through firewalls, making it a common exfil channel.

**MYTH: "We block Tor, so we're safe"**
REALITY: Bridges, meek, and domain fronting allow Tor access even when blocked.

**MYTH: "Long connections are always suspicious"**
REALITY: Video conferencing, websocket apps, and cloud syncing create legitimate long connections.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Detect** beaconing using timing analysis
2. **Identify** DGA domains using entropy and patterns
3. **Find** covert channels (DNS, ICMP tunneling)
4. **Investigate** long-lived connections
5. **Apply** tools like RITA for threat hunting

---

## 7. Further Depth (Optional)

*   **Tool:** Install RITA and analyze Zeek logs
*   **Practice:** SANS Network Forensics challenges
*   **Research:** Academic papers on DGA detection
*   **Lab:** Set up DNS tunneling with iodine for testing
