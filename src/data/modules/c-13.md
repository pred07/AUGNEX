# Validating Process Execution Visibility

## 1. Orientation

### What this module covers
This module covers validating your visibility into process execution—the fundamental telemetry needed to detect malware, living-off-the-land techniques, and malicious activity. If you can't see what processes run, you're blind to most attacks.

### Fit in the Learning Path
Every attack involves executing code. Process creation logging is the foundational detection capability. Without command line arguments, parent-child relationships, and process metadata, investigation is nearly impossible.

### Learning Objectives
By the end of this module, you will:
*   Configure comprehensive process creation logging
*   Analyze parent-child process relationships
*   Detect suspicious process patterns
*   Validate process visibility through testing

---

## 2. Core Content

### Mental Model: Process as Story

**How professionals think about this:**
Every process tells a story—what launched it, what arguments it received, what it spawned. Understanding this story is how you detect attacks hidden in legitimate tools.

```
PROCESS EXECUTION VISIBILITY:

WHAT ATTACKERS DO                    WHAT YOU NEED TO SEE
───────────────────────────────────  ─────────────────────────────
Phishing → Open document             Word.exe spawned
┌─────────────────────────────┐
│  Macro executes PowerShell  │──►   Word.exe → cmd.exe → powershell.exe
│  with encoded command       │      CommandLine: powershell -enc [base64]
└─────────────────────────────┘
              │
              ▼
Download payload                     Network connection logged
Execute payload                      New process with unusual path
Dump credentials                     Access to lsass.exe
Lateral movement                     New processes on remote system

WITHOUT COMMAND LINE LOGGING:
Log says: "powershell.exe ran"
          (Useless - PowerShell runs constantly)

WITH COMMAND LINE LOGGING:
Log says: "powershell.exe -enc [base64 string]"
          (Suspicious - encoded command, investigate!)
```

### Critical Process Logging Configurations

**Required settings:**

```
PROCESS LOGGING HIERARCHY:

LEVEL 1: BASIC (INSUFFICIENT)
─────────────────────────────
Windows Security Event 4688
DEFAULT: No command line arguments
Result: "A process was created"
        Process: powershell.exe
        (Missing: What did it DO?)

LEVEL 2: ENHANCED (MINIMUM REQUIRED)
─────────────────────────────
Enable: "Include command line in process creation events"
GPO: Computer Configuration → Policies → Admin Templates → 
     System → Audit Process Creation → 
     Include command line in process creation events = Enabled

Result: "A process was created"
        Process: powershell.exe
        CommandLine: powershell -enc RwBlAHQ...
        (Now you can see the actual command!)

LEVEL 3: SYSMON (RECOMMENDED)
─────────────────────────────
Microsoft Sysmon (free, powerful)
Event ID 1: Process Creation
  - Full command line
  - Parent process info
  - File hash (MD5, SHA256, IMPHASH)
  - Current directory
  - User and session info

LEVEL 4: EDR (BEST)
─────────────────────────────
Commercial EDR provides:
  - All Sysmon capabilities
  - Process tree visualization
  - Memory analysis
  - Network connections per process
  - File operations per process
  - Automated detection
```

### Sysmon Deep Dive

**Essential Sysmon event IDs:**

```
SYSMON EVENT IDS FOR PROCESS VISIBILITY:

Event 1: Process Creation
─────────────────────────────
MOST CRITICAL EVENT
Fields:
  UtcTime: When
  ProcessGuid: Unique ID
  ProcessId: PID
  Image: Full path to executable
  FileVersion: Version info
  Description: File description
  Product: Product name
  Company: Publisher
  OriginalFileName: Original name (hard to spoof)
  CommandLine: THE GOLD - actual arguments
  CurrentDirectory: Where it ran from
  User: Who ran it
  LogonGuid: Link to logon session
  LogonId: Windows logon ID
  TerminalSessionId: RDP session?
  IntegrityLevel: Low/Medium/High/System
  Hashes: MD5, SHA256, IMPHASH
  ParentProcessGuid: Link to parent
  ParentProcessId: Parent PID
  ParentImage: Parent executable
  ParentCommandLine: Parent's arguments

Event 5: Process Terminated
─────────────────────────────
When process ends
Useful for: Process lifetime analysis

Event 10: ProcessAccess
─────────────────────────────
Process opens handle to another
Critical for: Credential dumping detection
(Anything accessing lsass.exe)

Event 11: FileCreate
─────────────────────────────
File created
Useful for: Dropper detection

Event 22: DNSQuery
─────────────────────────────
DNS resolution
Link process to network activity
```

### Parent-Child Relationships

**Process genealogy for detection:**

```
PARENT-CHILD ANALYSIS:

NORMAL RELATIONSHIPS:
─────────────────────────────
explorer.exe → browser.exe       (User launched browser)
services.exe → svchost.exe       (Service host startup)
winlogon.exe → userinit.exe      (Login sequence)

SUSPICIOUS RELATIONSHIPS:
─────────────────────────────
winword.exe → cmd.exe            Macro execution!
excel.exe → powershell.exe       Macro execution!
outlook.exe → mshta.exe          Email-based attack!
svchost.exe → cmd.exe            Possible service exploit
mshta.exe → powershell.exe       Script chain

DETECTION RULE EXAMPLE:
─────────────────────────────
Alert: Office Application Spawned Command Interpreter

Condition:
  ParentImage ends with:
    - winword.exe
    - excel.exe
    - powerpnt.exe
  AND
  Image ends with:
    - cmd.exe
    - powershell.exe
    - wscript.exe
    - cscript.exe
    - mshta.exe

Severity: High
```

### Living Off the Land Detection

**Detecting abuse of legitimate tools:**

```
LOLBAS DETECTION (Living Off the Land Binaries):

COMMON ATTACK TOOLS (Built into Windows):
─────────────────────────────
certutil.exe     - Download files
bitsadmin.exe    - Download files
mshta.exe        - Execute HTA/scripts
regsvr32.exe     - Execute remote scripts
rundll32.exe     - Execute DLL functions
wmic.exe         - Remote execution
msiexec.exe      - Execute MSI from URL
powershell.exe   - Everything
cmd.exe          - Everything

DETECTION APPROACH:
─────────────────────────────
Don't block: These are legitimate tools
DO monitor: Suspicious usage patterns

EXAMPLE DETECTIONS:
─────────────────────────────
certutil.exe:
  Alert if: CommandLine contains "-urlcache"
  Alert if: CommandLine contains "-encode" or "-decode"
  
bitsadmin.exe:
  Alert if: CommandLine contains "/transfer"
  
mshta.exe:
  Alert if: CommandLine contains "http://" or "https://"
  
regsvr32.exe:
  Alert if: CommandLine contains "/s" AND "/n" AND "/u"
            (COM scriptlet execution)
  
wmic.exe:
  Alert if: CommandLine contains "process" AND "call" AND "create"
            (Remote process creation)
```

### Process Anomaly Detection

**Beyond signatures:**

```
BEHAVIORAL PROCESS DETECTION:

1. PATH ANOMALIES
   ─────────────────────────────
   Normal: C:\Windows\System32\cmd.exe
   Suspicious: C:\Users\Public\cmd.exe
   Suspicious: C:\Windows\Temp\cmd.exe
   
   Detection: Alert if known binary name runs from unusual path

2. COMMAND LINE LENGTH
   ─────────────────────────────
   Normal: Short, simple commands
   Suspicious: Very long command lines (>500 chars)
   
   Detection: Statistical analysis of command line length

3. ENCODED COMMANDS
   ─────────────────────────────
   Normal: powershell Get-Date
   Suspicious: powershell -enc RwBlAHQ...
   
   Detection: "-enc", "-e", "-encodedcommand"

4. RARE BINARIES
   ─────────────────────────────
   Normal: Binaries seen frequently across fleet
   Suspicious: Binary seen on only 1 system
   
   Detection: Rarity analysis across environment

5. UNSIGNED BINARIES
   ─────────────────────────────
   Normal: Signed by Microsoft, known vendors
   Suspicious: Unsigned, unknown publisher
   
   Detection: Signature verification
```

### Purple Team Validation

**Testing process visibility:**

```
PURPLE TEAM PROCESS VALIDATION:

TEST 1: BASIC VISIBILITY
─────────────────────────────
Action: Run calc.exe from command line
Check: Does Sysmon Event 1 appear?
       Is command line captured?
       Is parent-child logged?

TEST 2: COMMAND LINE CAPTURE
─────────────────────────────
Action: powershell -Command "Get-Date"
Check: Is "-Command Get-Date" in logs?
       Not just "powershell.exe"?

TEST 3: ENCODED COMMAND
─────────────────────────────
Action: powershell -enc RwBlAHQALQBEAGEAdABlAA==
Check: Is encoded string logged?
       Does Script Block (4104) show decoded?

TEST 4: LOLBAS
─────────────────────────────
Action: certutil -urlcache -split -f http://example.com/test
Check: Does detection rule fire?
       Is full command line visible?

TEST 5: SUSPICIOUS PARENT-CHILD
─────────────────────────────
Action: Word macro that spawns cmd.exe
Check: Does "Office spawned shell" alert fire?
       Is parent correctly identified?

TEST 6: PROCESS ACCESS (LSASS)
─────────────────────────────
Action: Run Mimikatz or procdump on lsass
Check: Does Sysmon Event 10 log access?
       Does credential dumping alert fire?
```

---

## 3. Guided Practice

### Exercise 1: Parent-Child Analysis

Which relationships are suspicious? Why?

| Parent | Child | Suspicious? | Why |
|--------|-------|-------------|-----|
| explorer.exe | chrome.exe | ___ | ___ |
| winword.exe | cmd.exe | ___ | ___ |
| svchost.exe | powershell.exe | ___ | ___ |
| outlook.exe | mshta.exe | ___ | ___ |

### Exercise 2: LOLBAS Detection

Create detection for bitsadmin.exe abuse:

Process to monitor: ___
Suspicious command line contains: ___
Alert severity: ___
False positive considerations: ___

### Exercise 3: Visibility Audit

Check your environment:

| Capability | Enabled | Forwarded | Alerted |
|-----------|---------|-----------|---------|
| Event 4688 | ___ | ___ | ___ |
| Command line in 4688 | ___ | ___ | ___ |
| Sysmon Event 1 | ___ | ___ | ___ |
| Sysmon Event 10 | ___ | ___ | ___ |

---

## 4. Reflection Check

### Process Understanding
1. Log shows "powershell.exe" with no arguments. Useful for investigation?

2. Sysmon shows cmd.exe spawned from winword.exe. First action?

3. Process has unusual path but valid Microsoft signature. Investigate?

### Strategic Thinking
1. Sysmon generates 10GB logs/day. Worth it?

2. 95% of endpoints have Sysmon. 5% are legacy. Risk?

3. EDR blocks attack but you want logs for hunting. Configuration?

---

## 5. Key Misconceptions

**MYTH: "Default Windows logging is sufficient"**
REALITY: Default 4688 without command line is nearly useless. Enhancement required.

**MYTH: "EDR replaces Sysmon"**
REALITY: Good EDR makes Sysmon less critical but logging is valuable for hunting and correlation.

**MYTH: "Process name tells you what's running"**
REALITY: Attackers rename binaries. Use hashes and original filename.

**MYTH: "We'd spot malware in process list"**
REALITY: LOLBAS uses legitimate tools. Detection requires command line analysis.

**MYTH: "More process logging is always better"**
REALITY: Strategic logging with proper exclusions beats capturing everything.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Configure** command line logging (4688 or Sysmon)
2. **Analyze** parent-child process relationships
3. **Detect** LOLBAS abuse patterns
4. **Validate** process visibility through testing
5. **Explain** why process context matters for detection

---

## 7. Further Depth (Optional)

*   **Tool:** Sysmon (SwiftOnSecurity configuration)
*   **Resource:** LOLBAS project (lolbas-project.github.io)
*   **Practice:** Build detection for 5 LOLBAS binaries
*   **Reading:** Process injection techniques
