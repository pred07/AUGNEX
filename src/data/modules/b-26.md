# CI/CD Pipeline Security (DevSecOps)

## 1. Orientation

### What this module covers
The CI/CD pipeline is the factory floor of modern software. If you compromise the pipeline, you inject malware into every customer who updates their software (e.g., SolarWinds). This module covers securing the pipeline itself.

### Learning Objectives
*   Identify the **Top 5 Pipeline Risks** (OWASP CI/CD).
*   Implement **Signed Commits** and **Branch Protection**.
*   Understand the risk of **Dependency Confusion**.

---

## 2. Core Content

### The Attack Surface
1.  **Code Injection:** Attacker pushes malicious code to `main`.
2.  **Poisoned Dependency:** Attacker uploads a package `internal-utils` to a public repo (npm) with a higher version number.
3.  **Pipeline Persistance:** Malicious Runner/Agent inside the build environment.
4.  **Artifact Tampering:** Modifying the compiled binary before signing.

### Defenses

#### 1. Branch Protection
Never allow direct pushes to `main`. Require Pull Requests (PRs) with:
*   Minimum 1 reviewer.
*   Successful CI Status Checks (Tests pass).
*   Signed Commits (GPG) to verify identity.

#### 2. Dependency Pinning
Don't use `npm install package@latest`. 
*   **Pin via Hash:** `package@1.2.3` is good. `package@sha256:abc...` is better.
*   **Lockfiles:** Always commit `package-lock.json`.

#### 3. Artifact Signing (SLSA)
Supply-chain Levels for Software Artifacts (SLSA).
*   Generate a **SBOM** (Software Bill of Materials).
*   Sign the binary using a key stored in a secure HSM.

---

## 3. Lab: The Poisoned Pipeline

### Scenario
You are auditing a GitHub Actions workflow.

**Vulnerable Config:**
```yaml
on: [pull_request_target]
jobs:
  build:
    runs-on: self-hosted
    steps:
       - run: npm install && npm test
```
**The Vulnerability:**
`pull_request_target` runs in the context of the *target* repo (with secrets), even for forks. A malicious PR can change `npm test` to `cat /etc/passwd` or `env` to print secrets.

**Fix:**
Use `on: [pull_request]` (runs in isolated context) or strictly sanitize input.

---

## 4. Reflection
1.  Why is "SolarWinds" the textbook example of Pipeline attacks? (Attackers didn't change the source code. They compromised the *build system* to inject code during compilation).
2.  What is a "Homer" attack (Golden SAML)? (Forging authentication tokens to move laterally in the cloud environment connected to the pipeline).
