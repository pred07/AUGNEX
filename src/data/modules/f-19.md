# Windows Architecture (High-Level)

## 1. Orientation

### What this module covers
This module explores Windows architecture from a security perspective—the Registry, Services, processes, and key subsystems. Understanding how Windows works is essential for both attacking and defending Windows environments.

### Fit in the Learning Path
While Linux is the attacker's preferred operating system, Windows dominates enterprise environments. You must understand your target to attack or defend it effectively.

### Learning Objectives
By the end of this module, you will:
*   Navigate the Windows Registry
*   Understand Services vs Processes
*   Identify persistence mechanisms
*   Recognize security-relevant components

---

## 2. Core Content

### Mental Model: The Windows Philosophy

**How professionals think about this:**
Linux follows "everything is a file" philosophy. Windows uses structured APIs and opaque objects. Configuration lives in a central database (Registry), not scattered text files. Understanding this philosophy helps navigate the system.

```
WINDOWS vs LINUX ARCHITECTURE:

LINUX:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  Configuration: Text files in /etc                                 │
│  Services: Systemd units (text)                                    │
│  Everything: Appears as file in filesystem                         │
│  Philosophy: Simple, transparent, composable                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

WINDOWS:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  Configuration: Registry (binary database)                         │
│  Services: SCM managed (API-based)                                 │
│  Objects: Opaque, accessed via handles                             │
│  Philosophy: Centralized, structured, API-driven                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### The Windows Registry

**Central configuration database:**

```
REGISTRY STRUCTURE:

Root Keys (Hives):
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  HKEY_LOCAL_MACHINE (HKLM)                                         │
│  └── System-wide settings                                          │
│      └── SOFTWARE: Installed applications                          │
│      └── SYSTEM: Hardware, drivers, services                       │
│      └── SECURITY: Security policies                               │
│                                                                     │
│  HKEY_CURRENT_USER (HKCU)                                          │
│  └── Current user settings                                         │
│      └── SOFTWARE: User-specific app settings                      │
│      └── Environment: User environment variables                   │
│                                                                     │
│  HKEY_USERS (HKU)                                                  │
│  └── All user profiles loaded                                      │
│                                                                     │
│  HKEY_CLASSES_ROOT (HKCR)                                          │
│  └── File associations and COM objects                             │
│                                                                     │
│  HKEY_CURRENT_CONFIG (HKCC)                                        │
│  └── Current hardware profile                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Security-critical Registry locations:**

| Location | Purpose | Attack Use |
|----------|---------|------------|
| `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` | Auto-start programs | Persistence |
| `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` | User auto-start | User-level persistence |
| `HKLM\SYSTEM\CurrentControlSet\Services` | Service definitions | Service hijacking |
| `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon` | Login process | Credential stealing |
| `HKLM\SAM` | User accounts (encrypted) | Password cracking |

### Windows Services

**Background processes:**

```
SERVICES CONCEPT:

SERVICE vs PROCESS:
─────────────────────────────
Process: Any running program
         Started by user or another process
         
Service: Special process managed by SCM
         Runs in background (no UI)
         Starts at boot (before user login)
         Runs as SYSTEM or specified account

SERVICE CHARACTERISTICS:
─────────────────────────────
Name: Internal identifier
Display Name: Human-readable name
Status: Running, Stopped, Paused
Startup: Automatic, Manual, Disabled
Account: LocalSystem, NetworkService, Custom

SECURITY PERSPECTIVE:
─────────────────────────────
Services often run as SYSTEM (highest privilege)
Service misconfiguration = privilege escalation
Unquoted paths, weak permissions = exploitable
```

**Managing services:**

```
SERVICE COMMANDS:

Command Prompt:
sc query                    # List services
sc query <servicename>      # Service details
sc start <servicename>      # Start service
sc stop <servicename>       # Stop service
sc config <name> start=auto # Change startup

PowerShell:
Get-Service                 # List services
Get-Service -Name "WinRM"   # Specific service
Start-Service -Name "WinRM" # Start service
Stop-Service -Name "WinRM"  # Stop service

GUI:
services.msc                # Services console
```

### Processes and DLLs

**Execution architecture:**

```
PROCESS ARCHITECTURE:

┌─────────────────────────────────────────────────────────────────────┐
│  PROCESS (Running program)                                         │
│  ─────────────────────────                                         │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  Executable (.exe)                                           │ │
│  │  PID: Unique process identifier                              │ │
│  │  Parent: Process that started it                             │ │
│  │  User: Account running process                               │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                  │
│  │ DLL 1   │ │ DLL 2   │ │ DLL 3   │ │ DLL 4   │                  │
│  │kernel32 │ │ ntdll   │ │ user32  │ │ custom  │                  │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘                  │
│                                                                     │
│  Threads: Multiple execution contexts                              │
│  Handles: References to system objects                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

DLL ATTACKS:
─────────────────────────────
DLL Injection: Force process to load attacker DLL
DLL Hijacking: Replace expected DLL with malicious one
DLL Sideloading: Abuse application's DLL search order
```

### Windows Filesystem

**Directory structure:**

```
WINDOWS FILESYSTEM:

C:\
├── Windows\                    # Operating system
│   ├── System32\              # Core system files (64-bit)
│   │   └── config\            # Registry hive files
│   ├── SysWOW64\              # 32-bit compatibility
│   └── Temp\                  # System temp files
│
├── Program Files\              # 64-bit applications
├── Program Files (x86)\        # 32-bit applications
│
├── Users\
│   ├── <username>\
│   │   ├── Desktop\
│   │   ├── Documents\
│   │   ├── Downloads\
│   │   ├── AppData\           # Application data
│   │   │   ├── Local\         # Machine-specific
│   │   │   ├── LocalLow\      # Low integrity
│   │   │   └── Roaming\       # Synced across machines
│   │   └── NTUSER.DAT         # User registry hive
│   └── Public\                 # Shared files
│
├── ProgramData\                # Application data (all users)
└── Temp\                       # Temp files

SECURITY-RELEVANT LOCATIONS:
─────────────────────────────
C:\Windows\System32\           # Attackers may drop here
C:\Users\<user>\AppData\       # Common malware location
C:\ProgramData\                # Persistence location
%TEMP%                         # Malware staging area
```

### Windows Security Components

**Security subsystems:**

```
SECURITY ARCHITECTURE:

┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  LSASS (Local Security Authority Subsystem Service)                │
│  ─────────────────────────────────────────────────                 │
│  Handles authentication                                            │
│  Stores credentials in memory                                      │
│  Target of credential dumping attacks (Mimikatz)                   │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  SAM (Security Account Manager)                                    │
│  ─────────────────────────────                                     │
│  Database of local user accounts                                   │
│  Password hashes stored here                                       │
│  Located: C:\Windows\System32\config\SAM                          │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  UAC (User Account Control)                                        │
│  ─────────────────────────                                         │
│  Prompts for elevation                                             │
│  Runs apps with limited privileges by default                      │
│  Can be bypassed (UAC bypass techniques)                           │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Windows Defender                                                  │
│  ─────────────────                                                 │
│  Built-in antimalware                                              │
│  Real-time protection                                              │
│  AMSI (Antimalware Scan Interface)                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Persistence Mechanisms

**How malware survives reboot:**

```
WINDOWS PERSISTENCE LOCATIONS:

1. REGISTRY RUN KEYS
   ─────────────────────────────
   HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
   HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
   
   Runs at every login

2. SCHEDULED TASKS
   ─────────────────────────────
   schtasks /create /tn "UpdateTask" /tr malware.exe /sc onlogon
   
   Runs on trigger (time, login, event)

3. SERVICES
   ─────────────────────────────
   sc create malware binpath= "C:\malware.exe"
   
   Runs at boot, before user login

4. STARTUP FOLDER
   ─────────────────────────────
   C:\Users\<user>\AppData\Roaming\Microsoft\Windows\
      Start Menu\Programs\Startup
   
   Runs at user login (easy to find)

5. WMI SUBSCRIPTIONS
   ─────────────────────────────
   Event-driven persistence
   Harder to detect

6. DLL HIJACKING
   ─────────────────────────────
   Place malicious DLL where legitimate app loads from
   Executes when app runs
```

### Key Processes to Know

**Critical Windows processes:**

| Process | Purpose | Security Note |
|---------|---------|---------------|
| `System` | Kernel threads | PID 4, always exists |
| `smss.exe` | Session Manager | First user-mode process |
| `csrss.exe` | Client/Server Runtime | Critical, always exists |
| `wininit.exe` | Windows Initialization | Starts services |
| `services.exe` | Service Control Manager | Parent of services |
| `lsass.exe` | Local Security Authority | Credential target |
| `svchost.exe` | Service Host | Hosts multiple services |
| `explorer.exe` | Windows Explorer | User shell |

---

## 3. Guided Practice

### Exercise 1: Registry Exploration

Using regedit, navigate to and document:

1. HKCU Run key - What programs auto-start?
   ___

2. HKLM Services - Find "Windows Update" service configuration
   ___

3. What is the "ImagePath" for the Windows Defender service?
   ___

### Exercise 2: Process Analysis

Using Task Manager or Process Explorer:

1. Which process has PID 4? ___
2. What is the parent of `explorer.exe`? ___
3. How many `svchost.exe` processes are running? ___

### Exercise 3: Service Investigation

Run: `sc query type= service state= all`

1. How many services are running? ___
2. Find a service running as LocalSystem ___
3. What is the binary path? ___

---

## 4. Reflection Check

### Architecture Understanding
1. Why does lsass.exe have credentials in memory?

2. A service runs as SYSTEM. What can it access?

3. Why do attackers prefer Registry Run keys over Startup folder?

### Security Thinking
1. You see `svchost.exe` running from `C:\Temp`. Normal?

2. User account has no admin rights but malware runs. Where might persistence be?

3. Process `cmd.exe` has parent `WINWORD.exe`. Suspicious?

---

## 5. Key Misconceptions

**MYTH: "Registry is just settings"**
REALITY: Registry controls security, persistence, services, and more. It's a critical attack surface.

**MYTH: "All svchost.exe processes are the same"**
REALITY: Each svchost hosts different services. Malware sometimes masquerades as svchost.

**MYTH: "Services always need admin to create"**
REALITY: Some service vulnerabilities allow unprivileged service creation/modification.

**MYTH: "UAC prevents privilege escalation"**
REALITY: Many UAC bypass techniques exist. UAC is a speed bump, not a security boundary.

**MYTH: "Windows Defender catches everything"**
REALITY: Defender is good but bypassable. Defense in depth is still required.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Navigate** the Registry and find security-relevant keys
2. **Understand** Services vs Processes
3. **Identify** common persistence locations
4. **Recognize** critical Windows processes
5. **Explain** Windows security components

---

## 7. Further Depth (Optional)

*   **Tool:** Explore with Process Explorer (Sysinternals)
*   **Practice:** Hunt for persistence with Autoruns
*   **Research:** Windows Internals book (Russinovich)
*   **Lab:** Create and analyze a Windows service
