# User Space vs Kernel Space

## 1. Orientation

### What this module covers
This module takes a deeper technical dive into the **Protection Rings** (Ring 0 vs Ring 3) and the mechanism of **System Calls**.

### Fit in the Learning Path
We touched on this in Module 1. Now we formalize it. This distinction is the barrier that prevents a crashed web browser from crashing the entire PC.

### Learning Objectives
By the end of this module, you should understand:
*   The x86 Protection Rings.
*   The mechanics of a context switch.
*   What a **BSOD** (Blue Screen of Death) / **Kernel Panic** actually is.

---

## 2. Core Content

### Protection Rings (x86 Architecture)
The CPU hardware enforces security levels called Rings.
*   **Ring 0 (Kernel Mode)**: Full access to everything (RAM, IO, CPU instructions). Danger zone.
*   **Ring 1 & 2**: Drivers (Rarely used in modern OS).
*   **Ring 3 (User Mode)**: Restricted. Cannot touch hardware. Cannot read Kernel memory.

### The Barrier: System Calls (Syscalls)
When Chrome wants to send a network packet, it cannot touch the Wi-Fi card. It must ask the Kernel.
1.  **Application**: "Hey Kernel, please send this data." (Calls `write()`)
2.  **CPU Transition**: Switches from Ring 3 to Ring 0.
3.  **Kernel**: Checks permissions. "Does Chrome own this socket? Yes." -> Sends data.
4.  **CPU Transition**: Switches back to Ring 3.

### The Crash
*   **App Crash**: Logic error in Ring 3. The Kernel sees it, catches the error, and kills *only* that process. The OS stays alive.
*   **Kernel Panic / BSOD**: Logic error in Ring 0. The Kernel *is* the logic. If it gets confused, it cannot recover. It halts the GPU/CPU immediately to prevent data corruption. Result: Blue Screen.

---

## 3. Guided Practice

### Observing Syscalls
We can watch a program talking to the Kernel in real-time.

**Tool**: `strace` (Linux).
*   **Warning**: This produces a LOT of text.

**Step 1: Trace a Command**
We will trace the simple `ls` command (Listing files).
Run:
```bash
strace ls
```

**Step 2: Analyze Output**
Ignore most of it. Look for:
*   `openat(...)`: Opening a directory.
*   `write(1, "Desktop...", ...)`: Writing text to your screen.
*   `close(...)`: Closing the handle.

**Observation**:
The `ls` program didn't write to the screen alone. It asked the Kernel `write()` to do it.

---

## 4. Reflection Check

1.  **Rootkits**: A "Kernel Mode Rootkit" runs in Ring 0. Why is this nearly impossible for an Antivirus to detect? (Hint: The Rootkit can lie to the Antivirus about what files exist).
2.  **Drivers**: Why do video game anti-cheats (like Vanguard/EasyAntiCheat) ask to install a Kernel Driver?
3.  **Stability**: Why does Microsoft require drivers to be "Digitally Signed"?

---

## 5. Completion Criteria

This module is complete when:
1.  You can draw the ring diagram (0 inside, 3 outside).
2.  You have run `strace` and successfully felt overwhelmed by the output (it's normal).
3.  You understand that Ring 0 crashes = System Death.
