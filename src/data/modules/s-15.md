# YARA: The Pattern Matching Standard

## 1. Orientation

### What this module covers
YARA (Yet Another Recursive Acronym) is the industry standard for identifying malware by pattern matching. It works on **files**. If you want to find a specific malware sample based on string or binary patterns, you write a YARA rule.

### Learning Objectives
*   Write a basic YARA rule structure (Meta, Strings, Condition).
*   Use Hexadecimal strings for binary matching.
*   Use the `any of them` and `filesize` conditions.

---

## 2. Core Content

### Rule Structure
A YARA rule has three sections:

```yara
rule Example_Malware {
    meta:
        author = "CyberDef"
        description = "Detects generic malware"
    strings:
        $text_string = "EvilCorp v1.0"
        $hex_string = { E2 34 A1 C8 23 FB }
    condition:
        $text_string or $hex_string
}
```

### String Types
1.  **ASCII:** `$a = "string"`. Case sensitive.
2.  **Nocase:** `$a = "string" nocase`. Case insensitive.
3.  **Wide:** `$a = "string" wide`. Matches UTF-16 (Windows default).
4.  **Hex:** `$a = { 4D 5A }`. Matches binary bytes (e.g., MZ header).

### Conditions
The logic gate.
*   `any of them`: Matches if any string is found.
*   `$a and $b`: Both must be present.
*   `filesize < 500KB`: Optimize performance (skip huge files).
*   `uint16(0) == 0x5A4D`: Check if file starts with "MZ" (Process Executable).

---

## 3. Lab: Writing a Rule

### Task
Write a YARA rule to detect a webshell that always contains the variable `$_POST['cmd']` and is smaller than 20KB.

**Solution:**
```yara
rule PHP_Webshell_CMD {
    meta:
        description = "Detects PHP command execution webshell"
    strings:
        $s1 = "$_POST" nocase
        $s2 = "['cmd']" nocase
    condition:
        all of them and filesize < 20KB
}
```

---

## 4. Reflection
1.  Why use `wide` strings for Windows malware? (Windows stores strings as Unicode; ASCII searches will miss them).
2.  What happens if your rule is too generic (e.g., matching the string "Microsoft")? (False Positives. You will flag legitimate system files).
