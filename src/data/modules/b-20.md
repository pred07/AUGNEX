# Policy as Code (OPA / Sentinel)

## 1. Orientation

### What this module covers
Manual code reviews cannot scale to thousands of deployments a day. **Policy as Code** (PaC) automates compliance/security checks. We define rules (e.g., "No S3 buckets shall be public") and the CI/CD pipeline blocks any code that violates them.

### Learning Objectives
*   Understand the concept of "Compliance as Code."
*   Write a basic **OPA (Open Policy Agent)** Rego rule.
*   Integrate Policy checks into the Terraform pipeline.

---

## 2. Core Content

### The Shift Left
Instead of a security team auditing AWS *after* deployment (Reactive), the pipeline checks the Terraform code *before* deployment (Proactive).

### Open Policy Agent (OPA)
The industry standard for PaC. It uses a language called **Rego**.

### Example: Blocking Public IPs
**Terraform Input (JSON):**
```json
{
  "resource": {
    "aws_instance": {
      "web": { "associate_public_ip_address": true }
    }
  }
}
```

**Rego Policy:**
```rego
deny[msg] {
  resource := input.resource.aws_instance[_]
  resource.associate_public_ip_address == true
  msg = "Public IPs are forbidden for EC2 instances."
}
```
*   **Outcome:** If the input matches the logic, the deployment is DENIED.

---

## 3. Lab: The Gatekeeper

### Scenario
Developer tries to deploy an S3 bucket with `acl = "public-read"`.

1.  **Pipeline Running:**
    *   Step 1: `terraform plan -out=tfplan`
    *   Step 2: `terraform show -json tfplan > tfplan.json`
    *   Step 3: `opa eval -i tfplan.json -d policies/s3.rego "data.main.deny"`

2.  **Policy Result:**
    *   Rule: `deny if acl != private`.
    *   Output: `["S3 bucket must be private"]`.

3.  **Action:** Pipeline Fails. Deployment stopped.

---

## 4. Reflection
1.  How does this help with Audits (SOC2/ISO)? (Your policy code *is* your documentation. You prove that non-compliant infrastructure *cannot* exist).
2.  What is the difference between specific static analysis (tfsec) and generic PaC (OPA)? (OPA is a general purpose engine that can audit K8s, Terraform, Envoy, and Linux, providing a unified language for policy).
