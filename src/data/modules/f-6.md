# Virtual Networking Concepts

## 1. Orientation

### What this module covers
This module explains how your virtual machines communicate—with the internet, with your host system, and with each other. You will learn the fundamental networking modes available in hypervisors, understand the security implications of each configuration, and know how to design isolated lab environments that prevent accidental exposure of vulnerable systems.

### Fit in the Learning Path
Incorrect network configuration is one of the most dangerous mistakes in security lab setup. Configure it wrong, and your intentionally vulnerable lab becomes an open invitation on your real network. This module prevents that disaster.

### Learning Objectives
By the end of this module, you will:
*   Understand the architecture and traffic flow of each networking mode
*   Choose the appropriate network configuration for different lab scenarios
*   Design isolated networks for safe malware analysis and attack simulation
*   Troubleshoot common virtual networking problems

---

## 2. Core Content

### Mental Model: Trust Boundaries in Virtual Networks

**How professionals think about this:**
Every network mode creates different trust boundaries. The question isn't just "can my VM reach the internet?"—it's "what can reach my VM, and what happens if my VM is compromised?"

```
SECURITY IMPACT BY NETWORK MODE:

┌─────────────────────────────────────────────────────────────────────┐
│                          INTERNET                                   │
└─────────────────────────────┬───────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Physical Router/Firewall                        │
└───────────┬─────────────────────────────────────────────┬───────────┘
            │                                             │
   ┌────────┴────────┐                           ┌────────┴────────┐
   │   Your Phone,   │                           │   BRIDGED VM    │
   │ Other Devices   │                           │ (Same network!) │
   └─────────────────┘                           └─────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │    YOUR HOST PC   │
                    │  ┌─────────────┐  │
                    │  │  NAT VM     │  │◄──── Protected by host
                    │  └─────────────┘  │
                    │  ┌─────────────┐  │
                    │  │ Host-Only   │  │◄──── Completely isolated
                    │  │    VM       │  │
                    │  └─────────────┘  │
                    └───────────────────┘
```

### NAT (Network Address Translation)

**Architecture:**
The VM sits behind the host, which acts as a router. The hypervisor creates a virtual NAT device that translates between the VM's private IP and the host's network.

**Traffic flow:**
```
VM (10.0.2.15) → Virtual NAT Router → Host IP → Physical Network → Internet
                      ↑
                Translation happens here
```

**Characteristics:**
| Aspect | NAT Behavior |
|--------|--------------|
| VM IP | Private range (e.g., 10.0.2.15) |
| Internet access | Yes (outbound) |
| Inbound connections | Blocked (unless port forwarding configured) |
| Visible on LAN | No (hidden behind host) |
| VM-to-VM communication | Same NAT network only |

**Security implications:**
- VM is protected from external scanning—nothing can initiate connections to it
- If VM is compromised, attacker cannot directly pivot to other network devices
- Suitable for general use, downloading tools, browsing

**When to use:**
- General lab work, updates, tool installation
- When internet is needed but exposure is not
- Default safe choice

### Bridged Adapter

**Architecture:**
The VM connects directly to the physical network adapter, appearing as a separate device on your network. It gets its own IP from your router via DHCP.

**Traffic flow:**
```
VM (192.168.1.105) ─────────────► Physical Network ────► Internet
                                         ↑
              Same level as your phone, laptop, smart TV
```

**Characteristics:**
| Aspect | Bridged Behavior |
|--------|------------------|
| VM IP | Same subnet as host (e.g., 192.168.1.x) |
| Internet access | Yes (full) |
| Inbound connections | Allowed (from LAN and potentially internet) |
| Visible on LAN | Yes (can be scanned, attacked) |
| VM-to-VM communication | All VMs on same bridge can communicate |

**Security implications:**
- VM is exposed to your entire local network
- Other devices can scan, attack, or interact with the VM
- If VM runs a vulnerable service, other devices can exploit it
- If VM is your Kali box performing scans, it appears as a real network device

**When to use:**
- When you need the VM to appear as a real network device
- Network scanning labs (scanning your actual router)
- When other physical devices need to interact with the VM
- Wireless testing (capturing traffic from your real network)

**Caution:**
- Never use bridged mode for intentionally vulnerable VMs (Metasploitable, DVWA)
- Your IoT devices, neighbors with shared routers, or public networks could reach your VM

### Host-Only Adapter

**Architecture:**
Creates a private network between the host and VMs only. No external connectivity at all.

**Traffic flow:**
```
┌───────────────────────────────────────────┐
│              HOST SYSTEM                  │
│  ┌──────────────────────────────────────┐ │
│  │     Virtual Host-Only Network        │ │
│  │         192.168.56.0/24              │ │
│  │                                      │ │
│  │   Host ◄──────────► VM1             │ │
│  │ (56.1)              (56.101)        │ │
│  │         ◄──────────► VM2             │ │
│  │                      (56.102)       │ │
│  └──────────────────────────────────────┘ │
│                                           │
│  ╳ No route to internet                  │
│  ╳ No route to physical LAN              │
└───────────────────────────────────────────┘
```

**Characteristics:**
| Aspect | Host-Only Behavior |
|--------|-------------------|
| VM IP | Isolated range (e.g., 192.168.56.x) |
| Internet access | No |
| Inbound connections | From host and same-network VMs only |
| Visible on LAN | No |
| VM-to-VM communication | Yes (same host-only network) |

**Security implications:**
- Maximum isolation from external threats
- Even if VM is compromised, no route to attack external systems
- Malware cannot phone home, spread, or exfiltrate data
- Perfect for vulnerable target VMs

**When to use:**
- Malware analysis (malware cannot reach C2 server)
- Vulnerable VMs (Metasploitable, VulnHub machines)
- Attack simulations (Kali attacking Windows victim)
- Any scenario requiring complete isolation

### Internal Network

**Architecture:**
Similar to Host-Only, but the host cannot communicate with the VMs—only VMs on the same internal network can see each other.

**Traffic flow:**
```
┌───────────────────────────────────────────┐
│              HOST SYSTEM                  │
│                                           │
│  ┌──────────────────────────────────────┐ │
│  │     Internal Network "LabNet"        │ │
│  │                                      │ │
│  │   VM1 ◄──────────────► VM2          │ │
│  │                                      │ │
│  │   ╳ Host cannot reach this network   │ │
│  └──────────────────────────────────────┘ │
└───────────────────────────────────────────┘
```

**When to use:**
- Complete isolation including from the host
- Multi-VM attack scenarios where host shouldn't participate
- Maximum paranoia malware analysis

### Combined Configurations

Real lab setups often use multiple adapters:

**Example: Attack Lab Configuration**
```
Kali VM:
  Adapter 1: NAT (for internet access, tool updates)
  Adapter 2: Host-Only (for attacking isolated targets)

Metasploitable VM:
  Adapter 1: Host-Only only (no internet, isolated)
```

This allows Kali to reach the internet when needed, while attacks happen on the isolated network.

**Example: Malware Analysis Configuration**
```
Analysis VM:
  Adapter 1: Host-Only (isolated, file sharing with host via shared folder)
  
Alternatively:
  Adapter 1: Internal Network (completely isolated, even from host)
```

### Network Mode Comparison

| Mode | Internet | Inbound from LAN | VM-to-VM | Host Access | Risk Level |
|------|----------|------------------|----------|-------------|------------|
| **NAT** | Yes | No | Same NAT | Limited | Low |
| **Bridged** | Yes | Yes | Yes | Yes | High |
| **Host-Only** | No | No | Same network | Yes | Very Low |
| **Internal** | No | No | Same network | No | Minimal |

### Common Troubleshooting

**Problem: VM has no internet**
- Check adapter attachment (is it connected?)
- Check adapter type (NAT should have internet)
- Try `dhclient eth0` to renew IP
- Verify host has internet

**Problem: VMs can't see each other**
- Ensure both are on same network type (e.g., both Host-Only)
- Check they're on the same named network (VirtualBox allows multiple Host-Only networks)
- Verify IP addressing (same subnet?)
- Check firewall rules inside VMs

**Problem: Host can't reach VM**
- NAT: Expected behavior (use port forwarding if needed)
- Bridged: Check VM firewall, verify IP with `ip a`
- Host-Only: Verify host-only adapter enabled in host network settings

---

## 3. Guided Practice

### Exercise 1: Mode Comparison

Configure your VM in each mode and record the differences:

| Mode | VM IP Address | Can ping 8.8.8.8? | Can host ping VM? |
|------|---------------|-------------------|-------------------|
| NAT | ___.___.___.___  | ___ | ___ |
| Bridged | ___.___.___.___  | ___ | ___ |
| Host-Only | ___.___.___.___  | ___ | ___ |

### Exercise 2: Lab Network Design

Design the network configuration for this scenario:

**Lab components:**
- Kali Linux (attacker)
- Metasploitable 2 (vulnerable target)
- Windows 10 (victim for malware testing)

For each VM, specify the adapter(s) and mode(s):

| VM | Adapter 1 | Adapter 2 | Justification |
|----|-----------|-----------|---------------|
| Kali | ___ | ___ | ___ |
| Metasploitable 2 | ___ | ___ | ___ |
| Windows 10 | ___ | ___ | ___ |

### Exercise 3: Incident Scenario

Your friend set up a "hacking lab" with Metasploitable on Bridged mode at a coffee shop. What are the potential consequences? What should they have done instead?

---

## 4. Reflection Check

### Security Thinking
1. Why is Bridged mode more dangerous than NAT, even though both provide internet access?

2. A malware sample you're analyzing tries to reach its C2 server. In which network mode would you notice this behavior vs. it being blocked?

3. You're on a corporate network with aggressive security monitoring. You want to practice network scanning. What's the safest network configuration?

### Operational Thinking
1. You need to download a tool to your isolated analysis VM. How do you get the file there safely without exposing the VM to the internet?

2. Your Host-Only network uses 192.168.56.0/24. Your office network uses 192.168.56.0/24. Is this a problem?

3. VirtualBox allows multiple Host-Only networks. When would you create more than one?

---

## 5. Key Misconceptions

**MYTH: "NAT means no one can attack my VM"**
REALITY: NAT blocks inbound connections from outside, but if the VM initiates a connection (e.g., visits a malicious website), attacks can still succeed.

**MYTH: "Bridged is fine because I have a router firewall"**
REALITY: Your router protects against internet threats, not LAN threats. Other devices on your network can reach the bridged VM.

**MYTH: "Host-Only is useless because there's no internet"**
REALITY: Host-Only is the foundation of safe lab environments. Use multiple adapters when you need both isolation and connectivity.

**MYTH: "I can just disconnect the cable for isolation"**
REALITY: Virtual networking is more flexible and reliable. Physical disconnection doesn't help when your VMs need to communicate with each other.

**MYTH: "VPN protects my bridged VM"**
REALITY: VPN protects traffic leaving your network. It doesn't protect against local network attacks on your bridged interface.

---

## 6. Completion Criteria

This module is complete when you can:

1. **Explain** the architecture and traffic flow of each networking mode
2. **Identify** the security implications of each mode
3. **Design** a multi-VM lab with appropriate network isolation
4. **Troubleshoot** common virtual networking problems
5. **Choose** the correct network mode for any given lab scenario

---

## 7. Further Depth (Optional)

*   **Practice:** Set up a dual-adapter Kali with NAT + Host-Only and attack an isolated Metasploitable
*   **Advanced:** Configure VirtualBox NAT port forwarding to expose a service
*   **Research:** Explore VirtualBox intnet (internal networking) vs Host-Only differences
*   **Exploration:** Create multiple isolated networks for different lab scenarios
